#!/bin/sh
set -e
op__="${1-}"
op2__="${2-}"
__lang="${3:-.en}"

. "$__distro_path_lib"
tldr_dir="$__distro_for_all_path/tldr"
cheat_sh_dir="$__distro_for_all_path/cheat_sh"
navi_cheats_dir="$__distro_for_all_path/navi_cheats"
betterman_dir="$__distro_for_all_path/betterman"

git_clone(){
	git clone --depth=1 "${1:-}" "${2:-}"
}

install_betterman(){
	if [ ! -d "${tldr_dir}" ];then
		if [ ! -d "${tldr_dir}/.git" ];then
			rm -rdf "${tldr_dir}"
		fi
		git_clone https://github.com/tldr-pages/tldr "${tldr_dir}"
	fi

	if [ ! -d "${cheat_sh_dir}" ];then
		if [ ! -d "${cheat_sh_dir}/.git" ];then
			rm -rdf "${cheat_sh_dir}"
		fi
		git_clone https://github.com/chubin/cheat.sheets.git "${cheat_sh_dir}"
	fi
	
	if [ ! -d "${navi_cheats_dir}" ];then
		if [ ! -d "${navi_cheats_dir}/.git" ];then
			rm -rdf "${navi_cheats_dir}"
		fi
		git_clone https://github.com/denisidoro/cheats.git "${navi_cheats_dir}"
	fi
	
	mkdir -p \
		"$betterman_dir/cheat_sh" \
		"$betterman_dir/navi_cheats" \
		"$betterman_dir/tldr_${__lang}"
	
	for section in common linux; do
		if [ ! -L "$betterman_dir/tldr_${__lang}/$section" ];then
			ln -sf "$tldr_dir/pages${__lang}/$section" "$betterman_dir/tldr_${__lang}/$section"
		fi
	done
	
	for subdir in see_also sheets; do
		if [ ! -L "$betterman_dir/cheat_sh/$subdir" ];then
			ln -sf "$cheat_sh_dir/$subdir" "$betterman_dir/cheat_sh/$subdir"
		fi
	done
	
	for d in "$navi_cheats_dir"/*; do
		[ -d "$d" ] && ln -sf "$d" "$betterman_dir/navi_cheats/$(basename "$d")" || :
	done
}

update_betterman() {
	last_update="$(stat -c %y "$betterman_dir" 2>/dev/null | cut -d' ' -f1 | cut -d'-' -f1-2)"
	current_month="$(date +'%Y-%m')"

	if [ "$last_update" != "$current_month" ]; then
		for dir in "$tldr_dir" "$cheat_sh_dir" "$navi_cheats_dir"; do
			if [ -d "$dir/.git" ]; then
				(
					cd "$dir"
					git pull --quiet
					[ -n "$(git status --porcelain)" ] && git checkout .
				)
			fi
		done
	fi
}

help() {
	script_name="$(basename "$0")"
	cat <<-EOF
	Usage: $script_name [option] <command>
	
		Options:
  		-c, --cheat     Show cheat.sh output for command
  		-t, --tldr      Show betterman/tldr content
  		-u, --update    Update all cheat repositories
  		-h, --help      Show this help message
	EOF
	exit 0
}

run_my_tldr_(){
	cmd="$1"
	if [ -z "$cmd" ];then
		help
	fi
	
	install_betterman
	update_betterman
	
	# Find .md or .cheat files matching the command
	result="$(find -L "$betterman_dir" \( -name "$cmd.md" -o -name "$cmd.cheat" -o -name "$cmd" \) 2>/dev/null || :)"

	if [ -z "${result}" ];then
		echo "no betterman entry for ${cmd}" 
		exit 1
	fi
	
	bat --style=plain --paging=never ${result}
}

main()
{
	case $op__ in
		-c|--cheat)
			getURL '2term' "cheat.sh/$op2__"
		;;
		-t|--tldr)
			run_my_tldr_ "${op2__}"
		;;
		-u|--update)
			install_betterman
			update_tldr_
		;;
		-h |--help)
			help
		;;
		*)
			run_my_tldr_ "${op__}"
		;;
	esac
}

main
