#!/bin/sh
set -e

. "$__distro_path_lib"
op__="$1"
op2__="$2"
wallpaper_layout="${3:-zoom}"
__bgp=true

. "${__distro_path_root}/lib/common/WM"

Prerequisite() {
	. "${__distro_display_manager_lib_path}"	  
	
	if [ "$Display_server_are" = "X11" ];then
		SETTER="xwallpaper --stretch"
	elif [ "$Display_server_are" = "wayland" ];then
		if [ -n "$SWAYSOCK" ];then
			SETTER="eval ogurictl output '*' --image"
		elif echo "$DESKTOP_SESSION" | grep -q "sway";then
			SETTER="swaybg -i"
		fi
	fi
}

__restore(){
	Prerequisite
	. "${Distro_config_file}"
	sleep 0.5
	if [ "$__bgp" = true ];then # on terminal
		( sleep 2 && $SETTER "$wallpaper_are" ) &
	else
		$SETTER "$wallpaper_are"
	fi
}

random_wall(){
	Prerequisite
	__Style_name="${op2__}"
	op2__="$(find "${__distro_path_wallpaper}"/ -type f -name "${__Style_name}_*" | shuf -n 1)"
	N=6
	random_wall_animation () {
		N=6
		ls "${__distro_path_wallpaper}/${__Style_name}_"* | sort -R | tail -$N | while read file; do
			$SETTER $file
			sleep 0.1
		done
	}
	random_wall_animation
	save_wall
}

save_and_restore(){
	save_wall
	__restore
}

save_wall(){
	sed -i "s|wallpaper_are=.*|wallpaper_are=\"$op2__\"|" "${Distro_config_file}"
	
	style_conf_path="$HOME/.config/blob/${_panel_name_}/${_style}/style.conf"
	if [ -f "$style_conf_path" ] && grep -q "wallpaper_are=" "$style_conf_path" ;then
		sed -i "s|wallpaper_are=.*|wallpaper_are=\"$op2__\"|" "${style_conf_path}"
	fi
}

main()
{
	case $op__ in
		-r) __restore ;;
		-s) save_wall ;;
		-d|--random) random_wall ;;
		-R) save_and_restore ;;
		-T) __bgp=false ; save_and_restore ;;
		*) pickbg ;;
	esac
}

main
