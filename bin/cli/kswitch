#!/bin/sh
set -e
. "$__distro_path_lib"
. "${__distro_path_root}/lib/common/WM"

KB_CONFIG="${script_config_path}/kb_layout.ini"
set_lang_argument="${1:-}"

if [ -n "$set_lang_argument" ] && [ "$set_lang_argument" != "--force" ] && [ "$set_lang_argument" != "-f" ]; then
    notify-send "⌨ Keyboard Module" "Setting layout to: $set_lang_argument"
    setxkbmap "$set_lang_argument"
    exit 0
fi

if [ ! -f "$KB_CONFIG" ]; then
    if [ -f "/etc/vconsole.conf" ]; then
        . /etc/vconsole.conf
        printf '%s\n' "${KEYMAP:-us}" > "$KB_CONFIG"
    elif [ -f "/etc/default/keyboard" ]; then
        . /etc/default/keyboard
        printf '%s\n' "${XKBLAYOUT:-us}" > "$KB_CONFIG"
    else
        setxkbmap -query | awk '/layout/ {print $2}' > "$KB_CONFIG"
    fi
fi

line_count=$(wc -l < "$KB_CONFIG")
if [ "$line_count" -eq 1 ] || [ "$set_lang_argument" = "--force" ] || [ "$set_lang_argument" = "-f" ]; then
    set_kb_layout 1
    exit 0
fi

current_kb="$(setxkbmap -query | grep -oP 'layout:\s*\K\w+')"
next_kb="$(awk "/$current_kb/{p=1}p" "${script_config_path}/kb_layout.ini" | sed -n 2p)"

if [ -z "$next_kb" ]; then
    next_kb=$(head -n 1 "$KB_CONFIG")
fi

setxkbmap "${next_kb},us"
notify-send "⌨ Keyboard Module" "Layout switched to: $next_kb"
