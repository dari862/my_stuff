#!/bin/sh
# work on this : fix RTL langs
set -e

set_lang_2="${1:-}"
if [ -n "${set_lang_2}" ];then
	notify-send "⌨  Keyboard/language module" "Current layout: $set_lang_2"
	setxkbmap "$set_lang_2"
	exit
fi

. "$__distro_path_lib"
. "${__distro_path_root}/lib/common/WM"

[ ! -f "${script_config_path}/kb_layout.ini" ] && echo "$(setxkbmap -query | grep layout | awk '{print $2}')" > "${script_config_path}/kb_layout.ini"

if [ "$(cat "${script_config_path}/kb_layout.ini" | wc -l)" = 1 ] || [ "${1:-}" = "--force" ] || [ "${1:-}" = "-f" ];then
	set_kb_layout 1
fi

if ! grep -q "us" "${script_config_path}/kb_layout.ini";then
	. /etc/default/keyboard
	mkdir -p "${script_config_path}"
	echo "$XKBLAYOUT" > "${script_config_path}/kb_layout.ini"
fi

current_kb="$(setxkbmap -query | grep -oP 'layout:\s*\K\w+')"
next_kb="$(awk "/$current_kb/{p=1}p" "${script_config_path}/kb_layout.ini" | sed -n 2p)"
[ -z "$next_kb" ] && next_kb="us"

notify-send "⌨  Keyboard/language module" "$(printf "%s" "\- Current layout: $current_kb")"
setxkbmap "$next_kb"
