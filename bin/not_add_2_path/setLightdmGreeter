#!/bin/sh
__mode="${1-}"
set_lightdm_theme(){
	greeter_background="${1-}"
	greeter_theme_name="${2-}"
	greeter_icon_theme_name="${3-}"
	greeter_font_name="${4-}"
	greeter_position="${5-}"
	
	if [ -z "$greeter_background" ] && [ -z "$greeter_theme_name" ] && [ -z "$greeter_icon_theme_name" ] && [ -z "$greeter_font_name" ] && [ -z "$greeter_position" ];then
		printf '%s' "ERROR: greeter_background, greeter_theme_name, greeter_icon_theme_name, greeter_font_name and greeter_position needed to set lightdm greeter"
		exit 1
	fi
	
	LDMF="$(ls /usr/share/lightdm/lightdm-gtk-greeter.conf.d/50_*.conf | head -1)"
	sed -i "s|background = .*|background = ${greeter_background}|g" "$LDMF"
	sed -i "s/theme-name = .*/theme-name = ${greeter_theme_name}/g" "$LDMF"
	sed -i "s/icon-theme-name = .*/icon-theme-name = ${greeter_icon_theme_name}/g" "$LDMF"
	sed -i "s/font-name = .*/font-name = ${greeter_font_name}/g" "$LDMF"
	sed -i "s/position = .*/position = ${greeter_position}/g" "$LDMF"
}

initial_step(){
	. "$__distro_path_lib"
	if [ "$(id -u)" -eq 0 ];then
		_SUPERUSER=""
	else
		_SUPERUSER="my-superuser"
	fi
	lightdm_background="${__distro_path_themes}/my_wallpapers/default_wall-01.jpg"
	
	$_SUPERUSER mkdir -p "/usr/share/lightdm/lightdm.conf.d"
	$_SUPERUSER mkdir -p "/usr/share/lightdm/lightdm-gtk-greeter.conf.d"
    
	$_SUPERUSER tee /usr/share/lightdm/lightdm.conf.d/"50_${__custom_distro_name}".conf <<- EOF >/dev/null 2>&1
	# Distro specific defaults for lightdm
	#
	
	[Seat:*]
	# show users
	greeter-hide-users=false
	user-session=${__custom_distro_name}${switch_default_xsession_to}
	EOF
	
	$_SUPERUSER tee /usr/share/lightdm/lightdm-gtk-greeter.conf.d/"50_${__custom_distro_name}".conf <<- 'EOF' >/dev/null 2>&1
	# Distro specific defaults for lightdm-gtk-greeter
	#
	# LightDM GTK+ Configuration
	# Available configuration options listed below.
	#
	# Appearance:
	#  theme-name = GTK+ theme to use
	#  icon-theme-name = Icon theme to use
	#  cursor-theme-name = Cursor theme to use
	#  cursor-theme-size = Cursor size to use
	#  background = Background file to use, either an image path or a color (e.g. #772953)
	#  user-background = false|true ("true" by default)  Display user background (if available)
	#  transition-duration = Length of time (in milliseconds) to transition between background images ("500" by default)
	#  transition-type = ease-in-out|linear|none  ("ease-in-out" by default)
	#
	# Fonts:
	#  font-name = Font to use
	#  xft-antialias = false|true  Whether to antialias Xft fonts
	#  xft-dpi = Resolution for Xft in dots per inch (e.g. 96)
	#  xft-hintstyle = none|slight|medium|hintfull  What degree of hinting to use
	#  xft-rgba = none|rgb|bgr|vrgb|vbgr  Type of subpixel antialiasing
	#
	# Login window:
	#  active-monitor = Monitor to display greeter window (name or number). Use #cursor value to display greeter at monitor with cursor. Can be a semicolon separated list
	#  position = x y ("50% 50%" by default)  Login window position
	#  default-user-image = Image used as default user icon, path or #icon-name
	#  hide-user-image = false|true ("false" by default)
	#
	# Panel:
	#  panel-position = top|bottom ("top" by default)
	#  clock-format = strftime-format string, e.g. %H:%M
	#  indicators = semi-colon ";" separated list of allowed indicator modules. Built-in indicators include "~a11y", "~language", "~session", "~power", "~clock", "~host", "~spacer". Unity indicators can be represented by short name (e.g. "sound", "power"), service file name, or absolute path
	#
	# Accessibility:
	#  a11y-states = states of accessibility features: "name" - save state on exit, "-name" - disabled at start (default value for unlisted), "+name" - enabled at start. Allowed names: contrast, font, keyboard, reader.
	#  keyboard = command to launch on-screen keyboard (e.g. "onboard")
	#  keyboard-position = x y[;width height] ("50%,center -0;50% 25%" by default)  Works only for "onboard"
	#  reader = command to launch screen reader (e.g. "orca")
	#  at-spi-enabled = false|true ("true" by default) Enables accessibility at-spi-command if the greeter is built with it enabled
	#
	# Security:
	#  allow-debugging = false|true ("false" by default)
	#  screensaver-timeout = Timeout (in seconds) until the screen blanks when the greeter is called as lockscreen
	#
	# Template for per-monitor configuration:
	#  [monitor: name]
	#  background = overrides default value
	#  user-background = overrides default value
	#  laptop = false|true ("false" by default) Marks monitor as laptop display
	#  transition-duration = overrides default value
	#
	
	[greeter]
	background = will be changed with sed
	#user-background=
	theme-name = Arc-Dark
	icon-theme-name = lightdm-icons
	font-name = Noto Sans 9
	xft-antialias=true
	#xft-dpi=
	xft-hintstyle=hintfull
	xft-rgba=rgb
	reader=orca
	indicators = ~clock;~language;~session;~a11y;~power
	clock-format = %H:%M          %a, %b %d
	position = 57%,start 22%,start
	EOF
	
	sed -i "s|background = will be changed with sed|background = ${lightdm_background}|g" /usr/share/lightdm/lightdm-gtk-greeter.conf.d/"50_${__custom_distro_name}".conf
}

if [ "${__mode}" = "--initial-step" ];then
	__distro_path_lib="${2:-$__distro_path_lib}"
	switch_default_xsession_to="${3:-openbox}"
	initial_step 
else
	set_lightdm_theme "${1-}" "${2-}" "${3-}" "${4-}" "${5-}"
fi
