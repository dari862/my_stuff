#!/bin/bash
unalias -a

wal="${1:-}"
theme_file_2_source="${2:-/tmp/$USER/theme_color_builder_output/colors.sh}"

if [[ -z "$wal" ]]; then
	printf "%s\n" "Error: 'wal' no wallpaper provided" >&2
	exit 1
else
	wal="$(realpath "$wal")"
fi

# Speed up script by not using unicode.
sys_locale="$LANG"
export LC_ALL=C
export LANG=C

shopt -s nullglob nocasematch

# Internal variables.
_temp_theme_dir="$(dirname "$theme_file_2_source")"
newline=$'\n'
color_count=16

# GENERATE COLORSCHEME
get_colors() {
	mkdir -p "${_temp_theme_dir}"
	colors=($(magick "${wal}"  +dither -colors $color_count -unique-colors txt:- | grep -E -o " \#.{6}"))

	# If imagemagick finds less than 16 colors, use a larger source number of colors.
	while (( "${#colors[@]}" <= 15 )); do
		colors=($(magick "${wal}"  +dither -colors "$((color_count + ${index:-2}))" -unique-colors txt:- | grep -E -o " \#.{6}"))
		((index++))
		out "colors: Imagemagick couldn't generate a $color_count color palette, trying a larger palette size ($((color_count + index)))."

		# Quit the loop if we're taking too long.
		((index == 10)) && break
	done
	out "colors: Generated colorscheme"
}

export_colors() {
	set_color() {
		sequences+="\033]4;${1};${2}\007"
		sh_colors+="color${1}='${2}'${newline}"
	}
	
	set_special() {
		sequences+="\033]${1};${2}\007"
	}
	
	################################
	#send_sequences
	# Create string of escape sequences to send to the terminals.
	set_special 10  "${colors[15]}"
	set_special 11  "${alpha:+[${alpha}]}${colors[0]}"
	set_special 12  "${colors[15]}"
	set_special 13  "${colors[15]}"
	set_special 14  "${alpha:+[${alpha}]}${colors[0]}"
	
	# This escape sequence doesn't work in VTE terminals.
	set_special 708 "${alpha:+[${alpha}]}${colors[0]}"

	set_color 0  "${colors[0]}"

	set_color 1  "${colors[9]}"
	set_color 2  "${colors[10]}"
	set_color 3  "${colors[11]}"
	set_color 4  "${colors[12]}"
	set_color 5  "${colors[13]}"
	set_color 6  "${colors[14]}"
	set_color 7  "${colors[15]}"

	# Create a comment color based on the brightness of the background.
	case "${colors[0]:1:1}" in
		[0-1]) set_color 8 "#666666" ;;
		2)     set_color 8 "#757575" ;;
		[3-4]) set_color 8 "#999999" ;;
		5)     set_color 8 "#8a8a8a" ;;
		[6-9]) set_color 8 "#a1a1a1" ;;
		*)     set_color 8 "${colors[7]}" ;;
	esac

	set_color 9  "${colors[9]}"
	set_color 10 "${colors[10]}"
	set_color 11 "${colors[11]}"
	set_color 12 "${colors[12]}"
	set_color 13 "${colors[13]}"
	set_color 14 "${colors[14]}"
	set_color 15 "${colors[15]}"
	
	# Set a black color that isn't affected by bold highlighting.
	sequences+="\033]4;66;${colors[0]}\007"
	
	################################
	# export_colors
	printf "%s" "$sequences" > "${_temp_theme_dir}/sequences"
	out "export: Exported escape sequences"
	printf "%s\n%s" "# wal - Colors generated by wal " "$sh_colors"  > "${theme_file_2_source}"
	out "export: Exported sh colors"
}

out() {
	printf "%s\n" "$1" >&2
}

# FINISH UP
main () {
	get_colors
	export_colors
	# Set the locale back to the original value.
	export LC_ALL="$sys_locale"
}

main
