#!/bin/sh
# need superuser : called by my-installer
BROWSERS_CHROOT_NAME="chroot-browsers"
chroot_default_browser_name="chroot-browser"
SCRIPT_NAME="chroot-${APP_NAME}"
LAUNCHER_SCRIPT_NAME="chroot-${APP_NAME}-launcher"
BROWSERS_CHROOT_DIR="${ROOT_CHROOT_DIR}/${BROWSERS_CHROOT_NAME}"
extra_chroot_browser="${INSTALLER_CHROOT_DIR}/EXTRA/${APP_NAME}"
CHROOT_DIR="${BROWSERS_CHROOT_DIR}"

generate_default_chroot_browser(){
	generate_never_remove_bin "${extra_chroot_browser}/${chroot_default_browser_name}" || failed_to_run "Failed to set execute permission on launch script"
	generate_applicationsdotdesktop_link "${chroot_default_browser_name}" || failed_to_run "Failed to generate_applicationsdotdesktop_link ${chroot_default_browser_name}"
}

end_of_chroot_builder(){	
	say "Creating launch script to run $APP_NAME from the host..."
	generate_applicationsdotdesktop_link "${SCRIPT_NAME}" || failed_to_run "Failed to generate_applicationsdotdesktop_link ${SCRIPT_NAME}"
	generate_never_remove_bin "${extra_chroot_browser}/${SCRIPT_NAME}" || failed_to_run "Failed to set execute permission on launch script"
	
	if [ -f "/etc/doas.conf" ];then
		my-superuser tee -a "/etc/doas.conf" > /dev/null <<- EOF
		permit persist :users as root cmd ${extra_chroot_browser}/${LAUNCHER_SCRIPT_NAME}-wayland
		permit persist :users as root cmd ${extra_chroot_browser}/${LAUNCHER_SCRIPT_NAME}-X11
		EOF
	
		my-superuser tee -a "${__distro_path_root}/system_files/doas.conf" > /dev/null <<- EOF
		permit persist :users as root cmd ${extra_chroot_browser}/${LAUNCHER_SCRIPT_NAME}-wayland
		permit persist :users as root cmd ${extra_chroot_browser}/${LAUNCHER_SCRIPT_NAME}-X11
		EOF
	fi
	
	if [ -d "/etc/sudoers.d" ];then
		my-superuser tee "/etc/sudoers.d/chroot_${APP_NAME}" > /dev/null <<- EOF
		%users ALL=(ALL) NOPASSWD: ${extra_chroot_browser}/${LAUNCHER_SCRIPT_NAME}-wayland
		%users ALL=(ALL) NOPASSWD: ${extra_chroot_browser}/${LAUNCHER_SCRIPT_NAME}-X11
		EOF
		my-superuser chmod 400 "/etc/sudoers.d/chroot_${APP_NAME}"
	fi
	
	if [ ! -f "${LAUNCH_SCRIPT_PATH}/${chroot_default_browser_name}" ];then
		generate_default_chroot_browser
	fi
	
	if [ "$make_chroot_browser_default_browser" = true ];then
     	generate_never_remove_bin "${extra_chroot_browser}/${chroot_default_browser_name}" "my-www-browser"
    fi
    
	generate_users_to_chroot
	
	say 
	say 
	say "You can now launch $APP_NAME from the chroot using the command: $SCRIPT_NAME"	
}
trap cleanup EXIT # from chroot_functions
chroot_builder

say "Installing $APP_NAME in the chroot..."
