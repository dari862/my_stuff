#!/bin/sh
current_user="chroot$(/usr/bin/logname)"
if /usr/sbin/chroot "$ROOT_CHROOT_DIR/chroot-browsers" id "${current_user}" >/dev/null 2>&1; then
    :
else
    /usr/sbin/chroot "$ROOT_CHROOT_DIR/chroot-browsers" useradd -m "${current_user}" -s /bin/bash
fi

if ! /usr/bin/mountpoint -q "$ROOT_CHROOT_DIR/chroot-browsers/proc"; then
    /usr/bin/mount --bind "/proc" "$ROOT_CHROOT_DIR/chroot-browsers/proc"
fi

WAYLAND_SOCKET="/run/user/$(id -u)/wayland-0"
CHROOT_WAYLAND_SOCKET="$ROOT_CHROOT_DIR/chroot-browsers/run/user/$(id -u)/wayland-0"

/usr/bin/mkdir -p "$(dirname "${CHROOT_WAYLAND_SOCKET}")"
/usr/bin/mount --bind "${WAYLAND_SOCKET}" "${CHROOT_WAYLAND_SOCKET}"
/usr/sbin/chroot "$ROOT_CHROOT_DIR/chroot-browsers" su - "${current_user}" -c "export MOZ_ENABLE_WAYLAND=1 WAYLAND_DISPLAY=wayland-0 && firefox"
