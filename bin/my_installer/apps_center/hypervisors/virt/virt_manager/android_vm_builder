#!/bin/sh
# https://github.com/maximilionus/android-qemu-launcher
# work on this : workonthis
set -e

INSTALL_MODE="${1:-qemu}"
IMAGE_TYPE="${2:-android}"
DRIVE_SIZE="${_qemu_drive_size:-20G}"

case "$IMAGE_TYPE" in
	"android")
		ISO_URL="https://sourceforge.net/projects/android-x86/files/Release%209.0/android-x86_64-9.0-r2.iso"
		ISO_NAME="android-x86_64-9.0-r2.iso"
		;;
	"bliss")
		ISO_URL="https://sourceforge.net/projects/android-x86/files/Release%209.0/android-x86_64-9.0-r2.iso"
		ISO_NAME="android-x86_64-9.0-r2.iso"
		;;
	*)
		echo "Error: Image type '$IMAGE_TYPE' not supported."
		exit 1
		;;
esac

REAL_SCRIPT_PATH=$(realpath "$0")
Android_VM_PATH="${REAL_SCRIPT_PATH%/*}"
VM_CONF="${Android_VM_PATH}/vm.conf"
ICON_PATH="${Android_VM_PATH}/android_icon.svg"
LAUNCHER_SH="${Android_VM_PATH}/launcher.sh"
DRIVE_DIR="${Android_VM_PATH}/drives"
DRIVE_NAME="android-image.qcow2"
DRIVE_PATH="${DRIVE_DIR}/$DRIVE_NAME"

ISO_PATH="${Android_VM_PATH}/$ISO_NAME"

prepare_env() {
	echo "Checking environment..."
	mkdir -p "$DRIVE_DIR"

	if [ ! -f "$VM_CONF" ]; then
		cat <<-EOF > "$VM_CONF"
		WINDOW_TITLE="Android VM"
		RAM_SIZE=4096
		CPU_CORES=2
		ADB_PORT=4444
		DRIVE_DIR="$DRIVE_DIR"
		DRIVE_NAME="$DRIVE_NAME"
		EOF
	fi

	. "$VM_CONF"

	if [ ! -f "$ICON_PATH" ]; then
		echo "PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiIHN0YW5kYWxvbmU9Im5vIj8+CjxzdmcKICAgdmlld0JveD0iMCAwIDUxMi4wMDAwMSA1MTIuMDAwMDIiCiAgIGVuYWJsZS1iYWNrZ3JvdW5kPSJuZXcgMCAwIDkxOC42IDUxNS4xIgogICB2ZXJzaW9uPSIxLjEiCiAgIGlkPSJzdmcxIgogICB3aWR0aD0iNTEyIgogICBoZWlnaHQ9IjUxMiIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICA8ZyBpZD0iWE1MSURfMV8iIHRyYW5zZm9ybT0idHJhbnNsYXRlKDAsMC4wMDM3NjM3NSkiPgogICAgPHBhdGggZmlsbD0iIzNEREM4NCIgZD0iTSA1MTAuOTU1NjIsMzk4Ljk2MjI3IEggMS4wNDQzNzk0IEMgOS4yMDQyOTE4LDMxMi41MzM4MiA1OC42MDc4NDEsMjM4LjcwNjA1IDEzMS41NDc0NiwxOTkuMTgzMiBMIDg5LjI0OTExLDEyNS45MTA1MiBjIC0yLjM4NjkxNCwtNC4xMDc3MSAtMC45OTkxNzQsLTkuMzI1NjEgMy4xMDg1NDEsLTExLjcxMjUzIDQuMTA3Njk3LC0yLjM4NjkxIDkuMzI1NTg5LC0wLjk5OTE3IDExLjcxMjUwOSwzLjEwODU0IGwgNDIuODUzNDMsNzQuMjE2MzQgYyAzMi42OTUxNSwtMTQuOTMyMDkgNjkuNDk4MDIsLTIzLjI1ODUzIDEwOS4wNzYzOCwtMjMuMjU4NTMgMzkuNTc4MzQsMCA3Ni4zODEyMSw4LjMyNjQ0IDEwOS4wNzYzNywyMy4yNTg1MyBsIDQyLjg1MzQyLC03NC4yMTYzNCBjIDIuMzMxNCwtNC4xMDc3MSA3LjYwNDgxLC01LjQ5NTQ1IDExLjY1NywtMy4xMDg1NCA0LjA1MjIxLDIuMzg2OTIgNS40OTU0Niw3LjYwNDgyIDMuMTA4NTUsMTEuNzEyNTMgbCAtNDIuMjk4MzIsNzMuMjcyNjggYyA3Mi45OTUxMywzOS41MjI4NSAxMjIuMzk4NjgsMTEzLjM1MDYyIDEzMC41NTg1OSwxOTkuNzc5MDcgeiBNIDM3My4wMTQyNSwzMjcuMzU0ODggYyAxMS44MjM1NiwwIDIxLjQyNjcsLTkuNjAzMTYgMjEuMzcxMiwtMjEuMzcxMiAwLC0xMS43NjgwMyAtOS41NDc2NCwtMjEuMzcxMiAtMjEuMzcxMiwtMjEuMzcxMiAtMTEuNzY4MDMsMCAtMjEuMzcxMiw5LjU0NzY2IC0yMS4zNzEyLDIxLjM3MTIgMCwxMS43NjgwNCA5LjU0NzY2LDIxLjM3MTIgMjEuMzcxMiwyMS4zNzEyIHogbSAtMjM0LjA4NDAxLDAgYyAxMS44MjM1NCwwIDIxLjQyNjcxLC05LjYwMzE2IDIxLjM3MTE5LC0yMS4zNzEyIDAsLTExLjc2ODAzIC05LjU0NzY1LC0yMS4zNzEyIC0yMS4zNzExOSwtMjEuMzcxMiAtMTEuNzY4MDQsMCAtMjEuMzcxMTksOS41NDc2NiAtMjEuMzcxMTksMjEuMzcxMiAwLDExLjc2ODA0IDkuNTQ3NjQsMjEuMzcxMiAyMS4zNzExOSwyMS4zNzEyIHoiIC8+CiAgPC9nPgo8L3N2Zz4K" | base64 --decode > "$ICON_PATH"
	fi
}

download_iso() {
	if [ ! -f "$ISO_PATH" ]; then
		echo "Downloading Android ISO..."
		if command -v curl >/dev/null; then
			curl -L -o "$ISO_PATH" "$ISO_URL"
		elif command -v wget >/dev/null; then
			wget -O "$ISO_PATH" "$ISO_URL"
		else
			echo "Error: Neither curl nor wget found."
			exit 1
		fi
	fi
}

generate_scripts() {
	echo "Generating launcher script..."
	cat <<- EOF > "$LAUNCHER_SH"
	#!/bin/sh
	# Generated Launcher
	Android_VM_PATH="$Android_VM_PATH"
	. "\${Android_VM_PATH}/vm.conf"
		
	EOF
	case "$INSTALL_MODE" in
 		"qemu")
				cat <<- EOF >> "$LAUNCHER_SH"
				TITLE="\${1:-$WINDOW_TITLE}"
				ISO_IMG="\$2"
				CD_ARG=""
				
				if [ -n "\$ISO_IMG" ];then
					CD_ARG="-cdrom \$ISO_IMG"
				fi
				
				qemu-system-x86_64 -enable-kvm -M q35 -m \${RAM_SIZE:-4096} \
					-smp \${CPU_CORES:-2} -cpu host \
					-drive file="\${DRIVE_DIR}/\$DRIVE_NAME",if=virtio \
					-usb -device virtio-tablet -device virtio-keyboard \
					-device qemu-xhci,id=xhci -device virtio-vga-gl \
					-display sdl,gl=on -machine vmport=off \
					-net nic,model=virtio-net-pci -net user,hostfwd=tcp::\${ADB_PORT:-4444}-:5555 \
					-name "\$TITLE" -audio pa,model=ac97 \$CD_ARG
				EOF
			;;
		"virtmanager")
				cat <<- EOF >> "$LAUNCHER_SH"
				TITLE="\${1:-$WINDOW_TITLE}"
				ISO_IMG="\$2"
				CD_ARG=""
				
				if [ -n "\$ISO_IMG" ];then
					CD_ARG="-cdrom \$ISO_IMG"
				fi
				
				qemu-system-x86_64 -enable-kvm -M q35 -m \${RAM_SIZE:-4096} \
					-smp \${CPU_CORES:-2} -cpu host \
					-drive file="\${DRIVE_DIR}/\$DRIVE_NAME",if=virtio \
					-usb -device virtio-tablet -device virtio-keyboard \
					-device qemu-xhci,id=xhci -device virtio-vga-gl \
					-display sdl,gl=on -machine vmport=off \
					-net nic,model=virtio-net-pci -net user,hostfwd=tcp::\${ADB_PORT:-4444}-:5555 \
					-name "\$TITLE" -audio pa,model=ac97 \$CD_ARG
				EOF
		;;
		*)
			echo "Error: Install mode \"$INSTALL_MODE\" not supported."
			exit 1
		;;
	esac
	chmod +x "$LAUNCHER_SH"

	DESKTOP_FILE="$HOME/.local/share/applications/android-qemu.desktop"
	cat <<-EOF > "$DESKTOP_FILE"
	[Desktop Entry]
	Name=Android VM
	Exec=$LAUNCHER_SH
	Icon=$ICON_PATH
	Type=Application
	Categories=System;Emulator;
	EOF
	chmod +x "$DESKTOP_FILE"
}

create_vm_disk() {
	if [ ! -f "$DRIVE_PATH" ]; then
		echo "Creating QEMU Disk ($DRIVE_SIZE)..."
		if qemu-img create -f qcow2 "$DRIVE_PATH" "$DRIVE_SIZE";then
			echo "Launching VM for Installation..."
			"$LAUNCHER_SH" "Android Install" "$ISO_PATH"
		else
			echo "Failed to create Virtual Disk..."
			exit 1
		fi
	else
		echo "Disk already exists. Use the launcher to start."
	fi
}

prepare_env
download_iso
generate_scripts
create_vm_disk

echo "Setup Complete. You can now launch Android from your App Menu."
