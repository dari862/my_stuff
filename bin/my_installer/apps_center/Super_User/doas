#!/bin/sh
# need superuser : called by my-installer
app_name="doas"
set_as_default_package=true
prompt "  Do you want to set $app_name as default package?"  || set_as_default_package=false

if ! cat /etc/group | grep sudo;then
	my-superuser groupadd sudo >/dev/null 2>&1
fi

say 'Installing package...' 1

Package_installer_ "${app_name}" || continue

if [ -f "/etc/doas.conf" ];then
	my-superuser rm -rdf "/etc/doas.conf"
fi

generate_never_remove_bin "${__distro_path_root}/bin/doas/doasedit"
my-superuser cp -rp ${__distro_path_root}/system_files/doas.conf /etc

my-superuser adduser "$USER" sudo >/dev/null 2>&1 || :

my-superuser doas -C /etc/doas.conf || failed_to_run "failed to install doas not installed."

my-superuser tee -a /etc/bash.bashrc <<- EOF >/dev/null 
if [ -x /usr/bin/doas ];then
	complete -F _command doas
fi
EOF

say 'Removing sudo ...' 1
# Ensure that debug mode is never enabled to
# prevent the password from leaking.
set +x

my-superuser su root << EOF
	. \"${__distro_path_root}/lib/common/common\"
	. \"${__distro_path_root}/Distro_Specific/Package-manager.sh\"
	export SUDO_FORCE_REMOVE=yes
	PASSWORD="$(LC_ALL=C tr -dc "_A-Z-a-z-0-9" < /dev/urandom | dd ibs=1 obs=1 count=30 2>/dev/null | base64)"
	echo \"root:${PASSWORD}\" | chpasswd
	Package_remove_ sudo
	passwd -l root
	dpkg -i ${__distro_path_root}/lib/fake_empty_apps/sudo.deb
	ln -sf $(which doas) /usr/bin/my-superuser
	ln -sf $(which doas) /usr/bin/sudo
	unset SUDO_FORCE_REMOVE
	unset PASSWORD
EOF

if [ "$set_as_default_package" = true ];then
	my-alternatives --set "my-superuser" "${app_name}" || continue
fi
