#!/bin/sh
# need superuser : called by my-installer
app_name="samba"

say 'Installing package...' 1

Package_installer_ "${app_name}" || continue

say "Setting up Samba..."  1
SAMBA_USER="sambauser"
SAMBA_GROUP="sambashare"
CURRENT_USER=$(whoami)
SHARED_DIR="/srv/samba/SecureShare"

if getent group "$SAMBA_GROUP" > /dev/null; then
    say "Group '$SAMBA_GROUP' already exists."
else
    say "Creating Samba group '$SAMBA_GROUP'..."
    my-superuser groupadd "$SAMBA_GROUP"
fi

# Create user if not exists
if id "$SAMBA_USER" &>/dev/null; then
    say "User '$SAMBA_USER' already exists."
else
    say "Creating system user '$SAMBA_USER'..."
    my-superuser adduser --disabled-password --gecos "" "$SAMBA_USER"
    my-superuser usermod -aG "$SAMBA_GROUP" "$SAMBA_USER"
fi

# Add current user to samba group for access
my-superuser usermod -aG "$SAMBA_GROUP" "$CURRENT_USER"
say "Added current user '$CURRENT_USER' to group '$SAMBA_GROUP'."

# Prompt for Samba password until confirmed
say "Setting Samba password for '$SAMBA_USER'..."
while true; do
    my-superuser smbpasswd -a "$SAMBA_USER" && break
    say "Password setup failed or canceled. Try again."
done
my-superuser smbpasswd -e "$SAMBA_USER"

say "Creating secure shared directory at '$SHARE_DIR'..."
my-superuser mkdir -p "$SHARE_DIR"
my-superuser chown root:"$SAMBA_GROUP" "$SHARE_DIR"
my-superuser chmod 2770 "$SHARE_DIR"  # Set GID bit so new files inherit group

say "Backing up original smb.conf..."
[ -f "/etc/samba/smb.conf" ] && my-superuser cp /etc/samba/smb.conf /etc/samba/smb.conf.bak || :

say "Configuring Samba secure share..."
# Append share config only if not already present
if ! grep -q "\[SecureShare\]" /etc/samba/smb.conf; then
    my-superuser tee /etc/samba/smb.conf >>/dev/null 2>&1 <<EOL

[SecureShare]
   path = $SHARE_DIR
   valid users = @$SAMBA_GROUP
   guest ok = no
   read only = no
   browsable = yes
   create mask = 0660
   directory mask = 2770
   force group = $SAMBA_GROUP
EOL
else
    say "Share [SecureShare] already defined in smb.conf. Skipping append."
fi

for service in smb nmb; do
		service_manager "enable" "$service"
done

if service_manager "is-active" smb && service_manager "is-active" nmb; then
	say "Samba is up and running."
	say "Samba share available at: $SHARED_DIR"
else
	say "Failed to start Samba."
fi

if command -v ufw >/dev/null 2>&1; then
	say "Configuring firewall..."  1
	my-superuser ufw allow Samba
	my-superuser ufw enable
fi

say "Secure Samba share is ready!"
say "Access it using the '$SAMBA_USER' account:"
say "   smb://<your-debian-ip>/SecureShare"
say "Members of the '$SAMBA_GROUP' group (including '$CURRENT_USER') can access the share."
