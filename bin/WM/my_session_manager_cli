#!/bin/sh
## Commands Executed By Openbox Powermenu

## Rofi #############################################
. "/usr/share/my_stuff/lib/common/WM"
opt_="${1:-}"
opt2_="${2:-}"
if [ "$opt2_" = "--no-cli-print-error" ];then
	print_error="no"
else
	print_error="yes"
fi

_logout(){
	current_wm_name="$(cat "$WM_name_file_path")"
	if [ "$current_wm_name" = "openbox" ];then
		openbox --exit
	elif [ "$current_wm_name" = "bspwm" ];then
		bspc quit
	elif [ "$current_wm_name" = "dwm" ];then	
		kill_process.sh dwm
	elif [ "$current_wm_name" = "i3" ];then
		i3-msg exit
	elif [ "$current_wm_name" = "qtile" ];then
		qtile cmd-obj -o cmd -f shutdown
	elif [ "$current_wm_name" = "awesome" ];then
		awesome --replace
	else
		([ "$(command -v systemctl)" ] && systemctl --user exit) || loginctl terminate-session "$XDG_SESSION_ID"
	fi
} 

_reload(){
	current_wm_name="$(cat "$WM_name_file_path")"
	if [ "$current_wm_name" = "openbox" ];then
		openbox --reconfigure &
	elif [ "$current_wm_name" = "bspwm" ];then
		bspc --restart
	elif [ "$current_wm_name" = "dwm" ];then	
		#kill_process.sh dwm
		:
	elif [ "$current_wm_name" = "i3" ];then
		i3-msg restart
	elif [ "$current_wm_name" = "qtile" ];then
		qtile cmd-obj -o cmd -f restart
	elif [ "$current_wm_name" = "awesome" ];then
		awesome --replace
	fi
} 

_suspend(){
	# The systemd or elogind compatibility magic.   #
	mpc -q pause 
	amixer set Master mute 
	extra_stuff suspend
}

extra_stuff(){
	failed_to_extra_stuff=false
	# hibernate | hybrid-sleep | suspend-then-hibernate | reboot | poweroff
	# The systemd or elogind compatibility magic.   #
	if command -v systemctl >/dev/null 2>&1;then
		systemctl "$1" >/dev/null 2>&1 || failed_to_extra_stuff=true
	else
		loginctl "$1" >/dev/null 2>&1 || failed_to_extra_stuff=true
	fi
	[ "$print_error" = "yes" ] && [ "$failed_to_extra_stuff" = true ] && echo "failed to extra_stuff $1 switching to superuser $1"  && my-superuser $1
}

_lock(){
    my-locker || loginctl lock "$XDG_SESSION_ID"
    exit $?
}

_moniter_off(){
	. "${my_stuff_display_manager_lib_path}"
	if [ "$Display_server_are" = "X11" ];then
		xset dpms force off || ( xset s blank && xset s activate )
	elif [ "$Display_server_are" = "wayland" ];then
		DE=$(printf '%s' "$XDG_CURRENT_DESKTOP$DESKTOP_SESSION$GDMSESSION" | tr '[:upper:]' '[:lower:]')
		if command -v swaymsg >/dev/null 2>&1;then
    		swaymsg "output * dpms off"
		elif command -v hyprctl >/dev/null 2>&1;then
    		hyprctl dispatch dpms off
		elif printf '%s' "$DE" | grep -q 'gnome'; then
    		gdbus call --session \
        		--dest org.gnome.ScreenSaver \
        		--object-path /org/gnome/ScreenSaver \
        		--method org.gnome.ScreenSaver.SetActive true
		elif printf '%s' "$DE" | grep -q 'kde'; then
    		qdbus org.freedesktop.ScreenSaver /ScreenSaver Lock
		else
			if [ "$print_error" = "yes" ];then
    			echo "Unsupported or unknown Wayland compositor: $DESKTOP_SESSION"
    			echo "You can extend this script with specific commands for your environment."
    			exit 1
    		fi
		fi
	fi
}

tty_menu(){
	opt_=""
   	clear
   	printf "Please choose an option \n"
   	echo "1) Logout	  3) Hibernate	    5) Reboot	      7) Quit
2) Suspend	  4) Hybrid-Sleep   6) Power-Off"
	read option
	option="$(echo "${option}" | tr '[:upper:]' '[:lower:]' )"
    case $option in
    	"logout"|1)		opt_="logout";;
    	"suspend"|2)	opt_="suspend";;
    	"hibernate"|3)	opt_="hibernate";;
    	"hybrid"*|4)	opt_="hybrid-sleep";;
    	"reboot"|5)		opt_="reboot";;
    	"power"*|6)		opt_="shutdown";;
    	"quit"|7)		echo 'exit cancelled' && exit;;
    	*) 				exit 1 ;;
    esac
    main
}

help_menu(){
	echo "
Powermenu
	
    	help		Show 			this help
    	lock		Lock 			screen	Does not work for a tty session
    	logout		Logout			Also works for tty.
    	suspend		Suspend			State determined by ACPI S0 S1 or S3
    	hibernate	Suspend			Suspend to Disk	Requires enough swap to store RAM
    	hybrid		Hybrid Sleep	ACPI must support sleep state S3
    	reboot		Reboot    		Reboot
    	shutdown	poweroff		poweroff
    	
    	text menu at a TTY
"
}
## Options #############################################
main(){
	case "$opt_" in
		logout) _logout ;;
		suspend) _suspend ;;
		reboot) extra_stuff reboot ;;
		shutdown) extra_stuff poweroff ;;
		lock) _lock ;;
		hibernate) extra_stuff hibernate ;;
		hybrid-Sleep) extra_stuff hybrid-sleep ;;
		moniter_off) _moniter_off ;;
		reload) _reload ;;
		help) help_menu ;;
		*) tty_menu ;;
	esac
}

main
