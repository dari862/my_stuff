#!/bin/sh
## Files and Directories
set -e
. "$__distro_path_lib"
. "${__distro_path_root}/lib/common/WM"
. "${Distro_config_file}"

use_single_bar=true
polybar_launcher_path="$HOME/.local/bin/polybar_launch"
config_file_name="config"

check_for_bars(){
	for bar in $bar_2_check;do
		if grep -q "^\[bar/$bar]" "$HOME/.config/polybar/${polybar_STYLE}/${config_file_name}.ini";then
			echo "MONITOR=\$monitor polybar -q $bar -c \"\$HOME/.config/polybar/$polybar_STYLE/${config_file_name}.ini\" &" >> "${polybar_launcher_path}"
		fi
	done
}

if [ -z "$ROFI_STYLE" ] || ( [ "$_panel_name_" = "polybar" ] && [ -z "$polybar_STYLE" ] );then
	RiceSelector
fi

if [ ! -f "$HOME/.config/polybar/$polybar_STYLE/system.ini" ];then
	"${__distro_path_root}"/bin/X11/polybar/polybar_fixer
fi

if grep -q "#EXO#" "$HOME/.config/polybar/${polybar_STYLE}/config.ini";then
	bar_2_check="main apps bspwmInfo CheckNetwork info monitoring network sec SystemTray sysTray third fourth fifth sixth"
else
	case "$polybar_STYLE" in
		pwidgets)		config_file_name="main"
						bar_2_check="primary secondary top";;
		hack*|cuts)		bar_2_check="top bottom";;
		cynthia|melissa)bar_2_check="bar1 bar2";;
		karla)			bar_2_check="bar1 bar2 bar3";;
		pamela|andrea)	bar_2_check="bar1 bar2 bar3 bar4 bar5 bar6";;
		*)				bar_2_check="main";;
	esac
fi

echo '#!/bin/sh' > "${polybar_launcher_path}"
if [ "$use_single_bar" = true ] ;then
    echo 'monitor="$(polybar --list-monitors | grep "(primary)" | cut -d":" -f1)"' >> "${polybar_launcher_path}"
    check_for_bars
else
    echo 'MONITORS="$(polybar --list-monitors | cut -d":" -f1)"' >> "${polybar_launcher_path}"
    echo 'for monitor in ${MONITORS}; do' >> "${polybar_launcher_path}"
    check_for_bars
    echo 'done' >> "${polybar_launcher_path}"
fi
chmod +x "${polybar_launcher_path}"
