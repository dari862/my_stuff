#!/bin/sh
set -eu
debug_mode="${1:-}"

. "$__distro_path_lib"
. "${__distro_path_root}/lib/common/WM"
. "${script_config_path}/clipmanager/config.ini"

pid_file_dir="${clip_path}/process_ids"
__script_name="$(basename "${0}")"
current_pid="$$"
out_file="${clip_path}/xclip.out"

if [ "$debug_mode" = "-d" ];then
	_log() {
		printf '[\033[94m%s\033[0m] %s' "${__script_name}" "${1}" | xargs >&2
	}
else
	exec 3>&1
	exec >/dev/null 2>&1
	_log() { :; }
fi

_usage() {
    _log "Invalid arguments."
    exit 1
}

cleanup() {
    _log "Exiting and cleaning up..."
    rm -f "${pid_file_dir}/$current_pid"
}

clean_old_procs() {
	for pid_file in "$pid_file_dir"/*; do
        if [ ! -e "$pid_file" ];then
        	continue
        fi
        old_pid="${pid_file##*/}"
        if kill -0 "$old_pid" 2>/dev/null; then
            _log "Killing old instance: $old_pid"
            kill "$old_pid" || kill -9 "$old_pid"
        fi
        rm -f "$pid_file"
    done
	touch "${pid_file_dir}/$current_pid"
}

process_clipboard() {
    _tc="$(xclip -selection clipboard -o -t TARGETS 2>/dev/null || echo "" )"

    if [ -z "${_tc}" ];then
       	_log "Waiting on initial selection with: ${UTF8_TARGET}"
       	xclip -verbose -in -selection clipboard -t "${UTF8_TARGET}" /dev/null || exit 3
       	return
    fi
    
    if printf '%s' "$_tc" | grep -q "x-special/gnome-copied-files"; then
        sleep 1
        return
    fi
    
   	_log "Available clipboard targets: $_tc"
   	_log "Preferred targets: ${_pref}"
   	_log "Default targets: ${UTF8_TARGET}"

   	_match="$(printf '%s\n%s\n%s\n' "${_tc}" "${_pref}" "${UTF8_TARGET}" | grep -v '^\s*$' | awk 'a[$0]++' | head -n1)"

   	if [ -n "${_match}" ];then
       	_log "Clipboard content dumped to temp file"
       	
       	xclip -verbose -out -selection clipboard -t "${_match}" > "${out_file}"
       	_log "xclip out exited"

       	if [ "${_match}" = "${UTF8_TARGET}" ];then
       		newfilename="$(date +%m%d-%H%M%S%s)"
       		_history="${history_path}/${newfilename}"
           	cp "${out_file}" "${_history}"
          	_log "Appended content to history: $_history"
       	fi
       	
       	xclip -verbose -in -selection clipboard -t "${_match}" "${out_file}"
       	_log "Clipboard re-injected, waiting for next change"
   	else
       	_log "No matching target found. Sleeping..."
       	sleep 1
   	fi
}

mkdir -p "${history_path}" "${pid_file_dir}"

clean_old_procs
trap cleanup EXIT

_log "Started with PID $current_pid"
while true;do
   	_log "== Iteration Start =="
   	process_clipboard
   	_log "== Iteration End =="
done
