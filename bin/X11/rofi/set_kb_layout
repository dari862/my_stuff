#!/bin/sh
# if this line exist script will be part of hub script.
set -e

if ! command -v setxkbmap >/dev/null 2>&1;then 
	exit 1
fi

. "$__distro_path_lib"
. "${__distro_path_root}/lib/common/WM"
. "${Distro_config_file}"

opt__="${1-h}"

HELP_List="1 add_kb_layout
2 change_kb_layout
3 notify-send
4 echo kb_layout"

[ ! -f "${script_config_path}/kb_layout.ini" ] && echo "$(setxkbmap -query | grep layout | awk '{print $2}')" > "${script_config_path}/kb_layout.ini"

if grep -q "us" "${script_config_path}/kb_layout.ini";then
	. /etc/default/keyboard
	mkdir -p "${script_config_path}"
	echo "$XKBLAYOUT" > "${script_config_path}/kb_layout.ini"
fi

add_kb_layout(){
	kb_choice="$(awk '/! layout/{flag=1; next} /! variant/{flag=0} flag {print $2, "- " $1}' /usr/share/X11/xkb/rules/base.lst | rofi -no-config -no-lazy-grab -dmenu -r -i -l 20 -theme "$HOME/.config/rofi/$ROFI_STYLE"/runner.rasi -p "" | awk '{print $3}')"
	
	if [ -n "$kb_choice" ] && ! grep -q "$kb_choice" "${script_config_path}/kb_layout.ini";then
		echo "$kb_choice" >> "${script_config_path}/kb_layout.ini"
	fi
	
	_menu
}

_menu(){
	opt__=""
	opt__="$(printf '%s\n' "${HELP_List}" | rofi -no-config -no-lazy-grab -dmenu -r -i -l 20 -theme "$HOME/.config/rofi/$ROFI_STYLE"/runner.rasi -p '' | awk '{ print $1 }')"
	main
}

main(){
	case "$opt__" in
		1) add_kb_layout ;;
		2) kswitch ;;
		3) notify-send "‚å®  Keyboard/language module" "$(printf "%s" "\- Current layout: $(setxkbmap -query | grep -oP 'layout:\s*\K\w+')")";;
		4) setxkbmap -query | grep -oP 'layout:\s*\K\w+' ;;
		*) _menu ;;
	esac
}

main
