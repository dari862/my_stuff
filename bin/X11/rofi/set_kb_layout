#!/bin/sh
# if this line exist script will be part of hub script.
set -e

if ! command -v setxkbmap >/dev/null 2>&1;then 
	exit 1
fi

. "$__distro_path_lib"
. "${__distro_path_root}/lib/common/WM"
. "${Distro_config_file}"

opt__="${1-h}"

HELP_List="1 Add new keyboard layout.
2 Change keyboard layout.
3 Send notification of current keyboard layout.
4 print keyboard layout on terminal."

KB_CONFIG="${script_config_path}/kb_layout.ini"

add_kb_layout(){
	xkb_base="/usr/share/X11/xkb/rules/base.lst"
    kb_choice=$(awk '
		/! layout/ {flag=1; next} 
		/! variant/ {flag=0} 
		flag && $1 != "" {print $2, "-", $1}
		' "$xkb_base" | rofi -no-config -no-lazy-grab -dmenu -r -i -l 20 -theme "$HOME/.config/rofi/$ROFI_STYLE/runner.rasi" -p "Select Layout:" | awk '{print $NF}')
	
	if [ -n "$kb_choice" ]; then
		if ! grep -Fxq "$kb_choice" "${script_config_path}/kb_layout.ini"; then
			printf '%s\n' "$kb_choice" >> "${script_config_path}/kb_layout.ini"
		fi
	fi
	
	_menu
}

_menu(){
	opt__=""
	opt__="$(printf '%s\n' "${HELP_List}" | rofi -no-config -no-lazy-grab -dmenu -r -i -l 20 -theme "$HOME/.config/rofi/$ROFI_STYLE"/runner.rasi -p '' | awk '{ print $1 }')"
	main
}

main(){
	case "$opt__" in
		1) add_kb_layout ;;
		2) kswitch ;;
		3) notify-send "âŒ¨  Keyboard/language module" "$(printf "%s" "\- Current layout: $(setxkbmap -query | grep -oP 'layout:\s*\K\w+')")";;
		4) setxkbmap -query | grep -oP 'layout:\s*\K\w+' ;;
		'') : ;;
		*) _menu ;;
	esac
}

if [ ! -f "$KB_CONFIG" ]; then
    if [ -f "/etc/vconsole.conf" ]; then
        . /etc/vconsole.conf
        printf '%s\n' "${KEYMAP:-us}" > "$KB_CONFIG"
    elif [ -f "/etc/default/keyboard" ]; then
        . /etc/default/keyboard
        printf '%s\n' "${XKBLAYOUT:-us}" > "$KB_CONFIG"
    else
        setxkbmap -query | awk '/layout/ {print $2}' > "$KB_CONFIG"
    fi
fi

main
