#!/bin/bash
. "$__distro_path_lib"
create_config_file(){
	location="$(cat /etc/timezone | awk -F/ '{print $2}')"
	reg_location="$(cat /etc/timezone | awk -F/ '{print $1}')"
	if [ "${reg_location}" = "America" ];then
		method_="2"
	else
		if [ "${location}" = "Karachi" ];then
			method_="1"
		elif [ "${location}" = "Riyadh" ];then
			method_="4"
		elif [ "${location}" = "Egypt" ];then
			method_="5"
		elif [ "${location}" = "Tehran" ];then
			method_="7"
		elif [ "${location}" = "Kuwait" ];then
			method_="9"
		elif [ "${location}" = "Qatar" ];then
			method_="10"
		elif [ "${location}" = "Singapore" ];then
			method_="11"
		elif [ "${location}" = "Paris" ];then
			method_="12"
		elif [ "${location}" = "Turkey" ];then
			method_="13"
		elif [ "${location}" = "Moscow" ];then
			method_="14"
		elif [ "${location}" = "Dubai" ];then
			method_="16"
		elif [ "${location}" = "Kuala_Lumpur" ];then
			method_="17"
		elif [ "${location}" = "Tunis" ];then
			method_="18"
		elif [ "${location}" = "Algiers" ];then
			method_="19"
		elif [ "${location}" = "Jakarta" ];then
			method_="20"
		elif [ "${location}" = "Casablanca" ];then
			method_="21"
		elif [ "${location}" = "Lisbon" ];then
			method_="22"
		elif [ "${location}" = "Amman" ];then
			method_="23"
		fi
	fi
	
	latlong=$(get_latlong)
	lat_="${latlong%,*}"
	long_="${latlong#*,}"
	
	cat <<-EOF > "$HOME/.config/scriptconfig/prayer-times.conf"
		# ----- Parameters ------ #
		# Coordinates: https://www.mapcoordinates.net/en
		lat="$lat_"
		long="$long_"
		# Calculation Method: https://api.aladhan.com/v1/methods
		# [0]="Shia Ithna-Ashari, Leva Institute, Qum"
		# [1]="University of Islamic Sciences, Karachi"
		# [2]="Islamic Society of North America (ISNA)"
		# [3]="Muslim World League"
		# [4]="Umm Al-Qura University, Makkah"
		# [5]="Egyptian General Authority of Survey"
		# [7]="Institute of Geophysics, University of Tehran"
		# [8]="Gulf Region"
		# [9]="Kuwait"
		# [10]="Qatar"
		# [11]="Majlis Ugama Islam Singapura, Singapore"
		# [12]="Union Organization Islamic de France"
		# [13]="Diyanet ƒ∞≈üleri Ba≈ükanlƒ±ƒüƒ±, Turkey (experimental)"
		# [14]="Spiritual Administration of Muslims of Russia"
		# [15]="Moonsighting Committee Worldwide (Moonsighting.com)"
		# [16]="Dubai (experimental)"
		# [17]="Jabatan Kemajuan Islam Malaysia (JAKIM)"
		# [18]="Tunisia"
		# [19]="Algeria"
		# [20]="Kementerian Agama Republik Indonesia"
		# [21]="Morocco"
		# [22]="Comunidade Islamica de Lisboa"
		# [23]="Ministry of Awqaf, Islamic Affairs and Holy Places, Jordan"
		method="${method_}"
		# Print Text Language (en/ar)
		print_lang="ar"
		
		athan_file_name='qatami_takbeer.mp3'
		athan_file_path="${__distro_path_root}/lib/${athan_file_name}"
		# ----------------------- #
		
		
		# ----------------------- #
		#polybar
		#[module/prayers]
		#type = custom/script
		#exec = \$HOME/.local/bin/prayer-times status
		#interval = 60
		#label = %{A:\$HOME/.local/bin/prayer-times menu:}%{F#83CAFA}Û±†ß %{F-} %output%%{A}
			
		# dunset
		#[play_athan]
		#summary = "Prayer Times"
		#script = "\$HOME/.local/bin/prayer-times athan"
		
		# Waybar (Wayland)
		#"custom/prayers": {
		#  "interval": 60,
		#  "return-type": "json",
		#  "exec": "$HOME/.local/bin/prayer-times waybar",
		#  "on-click": "$HOME/.local/bin/prayer-times menu",
		#  "format": "Û±†ß  {}",
		#}
		
		# Mako (Wayland)
		#[summary="Prayer Times"]
		#on-notify=exec $HOME/.local/bin/prayer-times athan
		#on-button-left=exec $HOME/.local/bin/prayer-times athan
		# ----------------------- #
	EOF
}

create_athan_daemon_file(){
	cat <<-EOF > "$HOME/.config/autostartscripts/athan-daemon"
	#!/bin/sh
	prayer-times sync
	while true;do
		sleep 28800 # sleep 8h
		prayer-times sync
	done
	EOF
	chmod +x "$HOME/.config/autostartscripts/athan-daemon"
}

[ ! -f "$HOME/.config/scriptconfig/prayer-times.conf" ] && create_config_file
[ ! -f "$HOME/.config/autostartscripts/athan-daemon" ] && create_athan_daemon_file

if [ "${XDG_SESSION_TYPE}" = "wayland" ];then
	notify='mako'
else
	notify='dunst'
fi

. "$HOME/.config/scriptconfig/prayer-times.conf"

_option="${1-}"
if [ "$_option" = "daemon" ];then
	sync_it
	while true;do
		sleep 28800 # sleep 8h
		sync_it
	done
	exit
fi
if [ "$_option" = "athan" ];then
	athan_pid="$(pgrep -f "mpv.*${athan_file_name}")"
	if [[ -z "$athan_pid" ]];then
  		mpv --no-audio-display --volume=100 "$athan_file_path"
	else
  		kill -1 "$athan_pid"
	fi
	exit
fi

if [ "$_option" = "help" ];then
  echo "Usage: $(basename "$0") [command]"
  echo "Command:"
  echo "  check      Check if prayer time data needs to be fetched"
  echo "  jobs       Add prayer time notifications as at jobs"
  echo "  sync       Check and sync prayer time data, and add notifications"
  echo "  print      Print prayer times"
  echo "  current    Get the current prayer"
  echo "  next       Get the next prayer"
  echo "  remaining  Get the remaining time for the next prayer"
  echo "  status     Get the status message indicating the next prayer"
  echo "  timeto     Get the time remaining for a prayer"
  echo "  menu       Toggle the menu window showing prayer times"
  echo "  waybar     Print waybar JSON-formatted status"
  echo "  athan      toggle-athan"
  exit
fi

prayers_json="$HOME/.local/share/prayers.json"
prayers=("Fajr" "Dhuhr" "Asr" "Maghrib" "Isha")
declare -A date
declare -A epochtimes
declare -A prayers_ar
prayers_ar=(
  ["Fajr"]="ÿßŸÑŸÅÿ¨ÿ±"
  ["Sunrise"]="ÿßŸÑÿ¥ÿ±ŸàŸÇ"
  ["Dhuhr"]="ÿßŸÑÿ∏Ÿáÿ±"
  ["Asr"]="ÿßŸÑÿπÿµÿ±"
  ["Maghrib"]="ÿßŸÑŸÖÿ∫ÿ±ÿ®"
  ["Isha"]="ÿßŸÑÿπÿ¥ÿßÿ°"
)
date=(
  [day_idx]=$(($(date +%-d) - 1))
  [weekday]=$(date +%a)
  [month]=$(date +%-m)
  [year]=$(date +%Y)
)

nameof() {
  if [[ "$print_lang" != "en" ]];then
    local array_name="prayers_$print_lang"
    eval "echo -n \${${array_name}[$1]}"
  else
    echo -n "$1"
  fi
}

check() {
  local available_month
  if [[ -r $prayers_json ]];then
    available_month=$(jq -r ".data[0].date.gregorian.month.number" "$prayers_json")
  else
    local fetch_prayers=1
  fi

  if [[ "$fetch_prayers" || "$available_month" != "${date[month]}" ]];then
    echo "-- fetching current month prayer calendar (${date[month]}-${date[year]})"
    # Documentation: https://aladhan.com/prayer-times-api#GetCalendar
    getURL 'download2' "https://api.aladhan.com/v1/calendar/${date[year]}/${date[month]}?latitude=$lat&longitude=$long&method=$method" "$prayers_json"
  fi
}

add-jobs() {
  # WARNING: THIS SCRIPTS REMOVES ALL JOBS IN QUEUE "P" SCHEDULED USING AT (ADJUST ACCORDINGLY)
  echo "-- removing all jobs in queue 'p'"
  if [[ "$(at -q p -l | wc -l)" != "0" ]];then
    for i in $(at -q p -l | awk '{ print $1 }'); do
      atrm "$i"
    done
  fi

  for prayer in "${prayers[@]}"; do
    echo "-- creating at job for $prayer prayer"
    if [[ "$notify" == "mako" ]];then
      printf 'notify-send -t 30000 --icon="clock-applet-symbolic" "Prayer Times" "It is time for %s prayer üïå"' "$prayer" | at -q p "$(timeof "$prayer" '%H:%M %F')"
    else
      printf '[ "$(dunstify --icon="clock-applet-symbolic" --action="Reply,reply" "Prayer Times" "Time for %s prayer üïå" -t 30000)" = "2" ] && %s' "$prayer" "$0 athan" | at -q p "$(timeof "$prayer" '%H:%M %F')"
    fi
  done
}

timeof() {
  [[ "$#" -lt "1" ]] && echo "atleast 1 argument is needed" && return 1
  echo -n "$(date -d "$(jq -r ".data[${date[day_idx]}].timings.$1" "$prayers_json")" "+${2:-%I:%M}")"
}

hijri() {
  case "$1" in
  weekday)
    if [[ "$print_lang" == "ar" ]];then
      echo -n "$(jq -r ".data[${date[day_idx]}].date.hijri.weekday.ar" "$prayers_json")"
    else
      echo -n "$(jq -r ".data[${date[day_idx]}].date.hijri.weekday.en" "$prayers_json")"
    fi
    ;;
  day)
    echo -n "$(jq -r ".data[${date[day_idx]}].date.hijri.day" "$prayers_json")"
    ;;
  month)
    if [[ "$print_lang" == "ar" ]];then
      echo -n "$(jq -r ".data[${date[day_idx]}].date.hijri.month.ar" "$prayers_json")"
    else
      echo -n "$(jq -r ".data[${date[day_idx]}].date.hijri.month.en" "$prayers_json")"
    fi
    ;;
  year)
    echo -n "$(jq -r ".data[${date[day_idx]}].date.hijri.year" "$prayers_json")"
    ;;
  *)
    echo "unsupported argument: $1" && return 1
    ;;
  esac
}

settimes() {
  # return if array already populated
  [[ "${#epochtimes[@]}" -gt 0 ]] && return 0

  epochtimes=(
    [now]=$(date +%s)
    [fajr]=$(timeof Fajr %s)
    [dhuhr]=$(timeof Dhuhr %s)
    [asr]=$(timeof Asr %s)
    [maghrib]=$(timeof Maghrib %s)
    [isha]=$(timeof Isha %s)
  )

  local nxt_idx=0
  local curr_idx=4
  for i in {4..0}; do
    local prayer_key="${prayers[$i],,}"
    if [[ "${epochtimes[now]}" -ge "${epochtimes[$prayer_key]}" ]];then
      [[ "$i" -lt "4" ]] && curr_idx=$i && nxt_idx=$((i + 1))
      break
    fi
  done

  local next_key="${prayers[$nxt_idx],,}"
  epochtimes[next]="${epochtimes[$next_key]}"
  currentprayer="${prayers[$curr_idx]}"
  nextprayer="${prayers[$nxt_idx]}"
  if [[ "$nxt_idx" == "1" && "${date[weekday]}" == "Fri" ]];then
    nextprayer="Jumuaa"
  fi
}

timeto() {
  [[ "$#" -lt "1" ]] && echo "atleast 1 argument are needed" && return 1
  settimes
  remain="$((epochtimes["${1,,}"] - epochtimes[now]))"
  [[ "$remain" -lt "0" ]] && remain="$((remain + 86400))"
  date -u -d"@$remain" "+${2:-%H:%M}"
}

print() {
  local format="üìÖ %sÿå%s\n%-12s%-10s\n%-12s%-10s\n%-12s%-10s\n%-12s%-10s\n%-12s%-10s\n%-12s%-10s\n"
  if [[ "$print_lang" == "ar" ]];then
    format="üìÖ %sÿå%s\n%s%11s\n%s%10s\n%s%11s\n%s%11s\n%s%10s\n%s%10s\n"
  fi

  printf "$format" \
    "$(hijri weekday)" \
    "$(hijri day)-$(hijri month)-$(hijri year)" \
    "€û $(nameof Fajr)" "$(timeof Fajr)" \
    "€û $(nameof Sunrise)" "$(timeof Sunrise)" \
    "€û $(nameof Dhuhr)" "$(timeof Dhuhr)" \
    "€û $(nameof Asr)" "$(timeof Asr)" \
    "€û $(nameof Maghrib)" "$(timeof Maghrib)" \
    "€û $(nameof Isha)" "$(timeof Isha)"
}

menu-en() {
  yad \
    --text-width=10 \
    --on-top \
    --text \
    "<span font-size='large'><b>üìÖ $(hijri weekday),$(hijri day)-$(hijri month)-$(hijri year)</b></span>" \
    --list \
    --width=300 \
    --height=250 \
    --title="Prayers" \
    --column="Prayer" \
    --column="Time" \
    --expand-column=1 \
    --no-buttons \
    --no-click \
    --no-selection \
    "<span font-size='large'>$(nameof Fajr)</span>" "<span font-size='large'>$(timeof Fajr)</span>" \
    "<span font-size='large'>$(nameof Sunrise)</span>" "<span font-size='large'>$(timeof Sunrise)</span>" \
    "<span font-size='large'>$(nameof Dhuhr)</span>" "<span font-size='large'>$(timeof Dhuhr)</span>" \
    "<span font-size='large'>$(nameof Asr)</span>" "<span font-size='large'>$(timeof Asr)</span>" \
    "<span font-size='large'>$(nameof Maghrib)</span>" "<span font-size='large'>$(timeof Maghrib)</span>" \
    "<span font-size='large'>$(nameof Isha)</span>" "<span font-size='large'>$(timeof Isha)</span>"
}

menu-ar() {
  yad \
    --text-width=10 \
    --on-top \
    --text-align='right' \
    --text \
    "<span font-size='large'><b>üìÖ $(hijri weekday),$(hijri day)-$(hijri month)-$(hijri year)</b></span>" \
    --list \
    --width=250 \
    --height=240 \
    --title="Prayers" \
    --column="ÿßŸÑŸàŸÇÿ™" \
    --column="ÿßŸÑÿµŸÑÿßÿ©" \
    --expand-column=1 \
    --no-buttons \
    --no-click \
    --no-selection \
    "<span font-size='large'>$(timeof Fajr)</span>" "<span font-size='large'>$(nameof Fajr)</span>" \
    "<span font-size='large'>$(timeof Sunrise)</span>" "<span font-size='large'>$(nameof Sunrise)</span>" \
    "<span font-size='large'>$(timeof Dhuhr)</span>" "<span font-size='large'>$(nameof Dhuhr)</span>" \
    "<span font-size='large'>$(timeof Asr)</span>" "<span font-size='large'>$(nameof Asr)</span>" \
    "<span font-size='large'>$(timeof Maghrib)</span>" "<span font-size='large'>$(nameof Maghrib)</span>" \
    "<span font-size='large'>$(timeof Isha)</span>" "<span font-size='large'>$(nameof Isha)</span>"
}

menu-toggle() {
  local menu_pid
  menu_pid=$(pgrep -f 'yad.*Prayers')

  if [[ -z "$menu_pid" ]];then
    if [[ "$print_lang" == "ar" ]];then
      menu-ar
    else
      menu-en
    fi

  else
    kill "$menu_pid"
  fi
}

current() {
  settimes
  echo "$currentprayer"
}

next() {
  settimes
  echo "$nextprayer"
}

remaining() {
  settimes
  timeto next "%H:%M:%S"
}

status() {
  settimes
  local remain
  remain="$(timeto next)"
  echo "$nextprayer in $remain"
}

waybar-status() {
  settimes
  local remain
  remain="$(timeto next)"
  local next_text="$nextprayer in $remain"
  printf '{ "text": "%s", "class": "%s" }' "$next_text" "$nextprayer"
}

sync_it() {
  check
  add-jobs
}

case "${_option}" in
check)
  check
  ;;
jobs)
  add-jobs
  ;;
sync)
  sync_it
  ;;
current)
  current
  ;;
next)
  next
  ;;
remaining)
  remaining
  ;;
status)
  status
  ;;
yad)
  yad-toggle
  ;;
waybar)
  waybar-status
  ;;
timeto)
  if [[ -n "$2" ]];then
    if [[ "$2" == "next" ]];then
      valid=1
    else
      for p in "${prayers[@]}"; do
        if [[ "${2^}" == "$p" ]];then
          valid=1
          break
        fi
      done
    fi
  fi

  if [[ -z "$valid" ]];then
    IFS='|'
    echo "Usage: $(basename "$0") timeto (next|${prayers[*],,})"
    exit 1
  fi

  timeto "$2"
  ;;
*)
  print
  ;;
esac
