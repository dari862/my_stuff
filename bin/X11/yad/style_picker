#!/bin/bash
# if this line exist script will be part of hub script.
# if this line exist script will be part of gui scripts.new_name=Style_Manager
# need superuser : called by apps_as_root

unalias -a

. "$__distro_path_lib"
. "${__distro_path_root}/lib/common/WM"
. "${__distro_path_root}/lib/common/openbox"
. "${Distro_config_file}"

CONFIGHOMEPATH="$HOME/.config"
GLOBALBLOBPATH="${__distro_path_root}/blob"
BLOBPATH="${CONFIGHOMEPATH}/blob"

GLOBALCONFIGPATH="${GLOBALBLOBPATH}/$_panel_name_"
CONFIGPATH="${BLOBPATH}/$_panel_name_"
CURSESSION="$Style_name"

TITLE="BLOB Config Manager"

DIALOG="yad --center --undecorated --borders=20 --window-icon=${__distro_path_root}/Distro_Specific/icons/linux.svg"
DIALOGDEC="yad --center  --borders=20 --window-icon=${__distro_path_root}/Distro_Specific/icons/linux.svg"

CANCEL="--button=Cancel:1"
EXIT="--button=Quit:1"
CLOSE="--button=Close:1"
	
T="--text="
OK="--button=OK:0"

MAIN_TEXT="Double-click selection, or <b>Enter</b>, or use the <b>Restore</b> button to restore settings\n"
RESTORE="Restore:0"
DELETE="Delete:2"
VIEW_IMG="View image:4"
ADD="Add New:3"
ABOUT="About:5"
ACTIVE="Last set"
NAME="Config Name"
SCREEN_SHOT="Screenshot"
CHOOSE_BEFORE_DELETE="Make a selection before trying to delete"
DELETE_FOR_SURE="Delete saved configurations <b>$FPATH</b>\nand screenshot?"
SETTINGS_SAVED="Settings were saved as"
OVERWRITE_SESSION="Overwrite existing session?"

CONFIGDIR=""

create_style_file() {
    __style_name="${1:-}"
    style_file="$CONFIGDIR/style.conf"
	JGRC="${CONFIGHOMEPATH}/jgmenu/jgmenurc"
	alacrittyconf="${CONFIGHOMEPATH}/alacritty/fonts.yml"
	
    # ---------- helpers ----------
    _kv() { grep -E "^$1" "$2" 2>/dev/null | awk -F'= ' '{print $2}'; }
    _kvq() { grep -E "^$1" "$2" 2>/dev/null | awk -F'"' '{print $2}' | head -n1; }
    _ini() { grep -E "^$1" "$2" 2>/dev/null | awk -F= '{print $2}'; }

    _dunst_block() {
        block="$1"
        key="$2"
        awk "/\\[$block\\]/{f=1} f && /^$key/{print} f && /^$/{f=0}" \
            "$CONFIGHOMEPATH/dunst/dunstrc" 2>/dev/null | awk -F'= ' '{print $2}'
    }

	__jg() {
    	grep "^${1:-}" "$JGRC" | awk -F'= '  '{print $2}' || :
	}

	_alacritty_block(){
		_key="$1"
		_alt="$2"
		if [ -f "${alacrittyconf}" ];then
			grep -q "${_key}:" "${alacrittyconf}" | head -n1 | awk -F': ' '{print $2}' | sed 's/"//g'
		else
			echo "${_alt}"
		fi
	}
	
    tee "$style_file" >/dev/null <<EOF
Style_name="${__style_name}"

# Distro_config
##############
$(cat "$CONFIGHOMEPATH/WM_common_config/Distro_config" 2>/dev/null || :)

# dunstrc
##############
dunstrc_icon_position=$(_kv icon_position "$CONFIGHOMEPATH/dunst/dunstrc")
dunstrc_frame_color="$(_kvq frame_color "$CONFIGHOMEPATH/dunst/dunstrc")"
dunstrc_separator_color=$(_kv separator_color "$CONFIGHOMEPATH/dunst/dunstrc")
dunstrc_transparency=$(_kv transparency "$CONFIGHOMEPATH/dunst/dunstrc")
dunstrc_origin=$(_kv origin "$CONFIGHOMEPATH/dunst/dunstrc")
dunstrc_offset="$(_kv offset "$CONFIGHOMEPATH/dunst/dunstrc")"
dunstrc_frame_width=$(_kv frame_width "$CONFIGHOMEPATH/dunst/dunstrc")
dunstrc_format=$(_kv format "$CONFIGHOMEPATH/dunst/dunstrc")
dunstrc_low_timeout=$(_dunst_block urgency_low timeout)
dunstrc_low_background="$(_dunst_block urgency_low background | tr -d '"')"
dunstrc_low_foreground="$(_dunst_block urgency_low foreground | tr -d '"')"
dunstrc_low_frame_color="$(_dunst_block urgency_low frame_color | tr -d '"')"
dunstrc_normal_timeout=$(_dunst_block urgency_normal timeout)
dunstrc_normal_background="$(_dunst_block urgency_normal background | tr -d '"')"
dunstrc_normal_foreground="$(_dunst_block urgency_normal foreground | tr -d '"')"
dunstrc_normal_frame_color="$(_dunst_block urgency_normal frame_color | tr -d '"')"
dunstrc_critical_timeout=$(_dunst_block urgency_critical timeout)
dunstrc_critical_background="$(_dunst_block urgency_critical background | tr -d '"')"
dunstrc_critical_foreground="$(_dunst_block urgency_critical foreground | tr -d '"')"
dunstrc_critical_frame_color="$(_dunst_block urgency_critical frame_color | tr -d '"')"

# gtk
##############
gtk_theme_name="$(_ini gtk-theme-name "$CONFIGHOMEPATH/gtk-3.0/settings.ini")"
gtk_icon_name="$(_ini gtk-icon-theme-name "$CONFIGHOMEPATH/gtk-3.0/settings.ini")"
gtk_font_name="$(_ini gtk-font-name "$CONFIGHOMEPATH/gtk-3.0/settings.ini")"
gtk_cursor_name="$(_ini gtk-cursor-theme-name "$CONFIGHOMEPATH/gtk-3.0/settings.ini")"

# openbox
##############
openbox_menu="$(ls -l "$CONFIGHOMEPATH/openbox/menu.xml" 2>/dev/null | awk '{print $NF}')"
openbox_bottom="$(grep 'ENTITY bottom_var' "$CONFIGHOMEPATH/openbox/rc.xml" | awk -F'"' '{print $2}')"
openbox_top="$(grep 'ENTITY top_var' "$CONFIGHOMEPATH/openbox/rc.xml" | awk -F'"' '{print $2}')"
openbox_right="$(grep 'ENTITY right_var' "$CONFIGHOMEPATH/openbox/rc.xml" | awk -F'"' '{print $2}')"
openbox_left="$(grep 'ENTITY left_var' "$CONFIGHOMEPATH/openbox/rc.xml" | awk -F'"' '{print $2}')"
openbox_font="$(grep 'ENTITY font_var' "$CONFIGHOMEPATH/openbox/rc.xml" | awk -F'"' '{print $2}')"
openbox_size="$(grep 'ENTITY size_var' "$CONFIGHOMEPATH/openbox/rc.xml" | awk -F'"' '{print $2}')"
openbox_theme="$(grep 'ENTITY theme_var' "$CONFIGHOMEPATH/openbox/rc.xml" | awk -F'"' '{print $2}')"
openbox_titleLayout="$(grep 'ENTITY titleLayout_var' "$CONFIGHOMEPATH/openbox/rc.xml" | awk -F'"' '{print $2}')"
openbox_gtk_icon_name="$(_ini gtk-icon-theme-name "$CONFIGHOMEPATH/gtk-3.0/settings.ini")"

# rofi
##############
rofi_background="$(grep 'background:' "$CONFIGHOMEPATH/rofi/theme.rasi" | sed 's/;//' | awk -F'#' '{print "#"$2}')"
rofi_active="$(grep 'active:' "$CONFIGHOMEPATH/rofi/theme.rasi" | sed 's/;//' | awk -F'#' '{print "#"$2}')"
rofi_background_alt="$(grep 'background_alt:' "$CONFIGHOMEPATH/rofi/theme.rasi" | sed 's/;//' | awk -F'#' '{print "#"$2}')"
rofi_foreground="$(grep 'foreground:' "$CONFIGHOMEPATH/rofi/theme.rasi" | sed 's/;//' | awk -F'#' '{print "#"$2}')"
rofi_selected="$(grep 'selected:' "$CONFIGHOMEPATH/rofi/theme.rasi" | sed 's/;//' | awk -F'#' '{print "#"$2}')"
rofi_urgent="$(grep 'urgent:' "$CONFIGHOMEPATH/rofi/theme.rasi" | sed 's/;//' | awk -F'#' '{print "#"$2}')"
rofi_font="$(grep ' font:' "$CONFIGHOMEPATH/rofi/fonts.rasi" | awk -F'"' '{print $2}')"
rofi_text_font="$(grep 'text-font:' "$CONFIGHOMEPATH/rofi/fonts.rasi" | awk -F'"' '{print $2}' || echo '@font')"
rofi_icon_font="$(grep 'icon-font:' "$CONFIGHOMEPATH/rofi/fonts.rasi" | awk -F'"' '{print $2}' || echo '@font')"

# bspwm
##############
$(cat "$CONFIGHOMEPATH/bspwm/theme-bspwm.conf" 2>/dev/null || :)

# jgmenu
##############
jgmenu_font="$(__jg font | awk '{$NF=""; print $0}')"
jgmenu_size="$(__jg font | awk '{print $NF}')"
jgmenu_color_menu_bg="$(__jg color_menu_bg)"
jgmenu_color_menu_border="$(__jg color_menu_border)"
jgmenu_color_norm_bg="$(__jg color_norm_bg)"
jgmenu_color_norm_fg="$(__jg color_norm_fg)"
jgmenu_color_sel_bg="$(__jg color_sel_bg)"
jgmenu_color_sel_fg="$(__jg color_sel_fg)"
jgmenu_color_sel_border="$(__jg color_sel_border)"
jgmenu_color_title_bg="$(__jg color_title_bg)"
jgmenu_color_title_fg="$(__jg color_title_fg)"
jgmenu_color_title_border="$(__jg color_title_border)"
jgmenu_color_sep_fg="$(__jg color_sep_fg)"
jgmenu_item_margin_x="$(__jg item_margin_x)"
jgmenu_item_margin_y="$(__jg item_margin_y)"
jgmenu_stay_alive="$(__jg stay_alive)"
jgmenu_menu_padding_right="$(__jg menu_padding_right)"
jgmenu_menu_padding_bottom="$(__jg menu_padding_bottom)"
jgmenu_menu_padding_left="$(__jg menu_padding_left)"
jgmenu_menu_radius="$(__jg menu_radius)"
jgmenu_sep_halign="$(__jg sep_halign)"
jgmenu_icon_size="$(__jg icon_size)"
jgmenu_icon_theme="$(__jg icon_theme)"
jgmenu_menu_border="$(__jg menu_border)"

# alacritty
##############
alacritty_family="$(_alacritty_block "family" "JetBrainsMono Nerd Font")"
alacritty_size="$(_alacritty_block "size" "10")"

# lightdm
##############
$(cat "$CONFIGHOMEPATH/WM_common_config/lightdm-greeter.conf" 2>/dev/null || :)

# plank
##############
plank_use_plank="$(pidof -q plank && echo yes || echo no)"
plank_hide_mode="$(_ini hide-mode "$HOME/.cache/plank.conf")"
plank_offset="$(_ini offset "$HOME/.cache/plank.conf")"
plank_position="$(_ini position "$HOME/.cache/plank.conf")"
EOF
}

take_style_screenshot() {
    __style_name="${1:-default_style}"
    SCREENSHOT_PATH="$CONFIGPATH/$__style_name"
    CURRDTOP=$(xprop -root _NET_CURRENT_DESKTOP | awk '{print $3}')
    MONS=$(xrandr --listactivemonitors | grep -c '^ ')

    # Get screen geometry more reliably
    read -r screenW screenH < <(xdotool getdisplaygeometry)

    # Calculate positions based on monitor count
    appXsize=$(( MONS == 1 ? 8 : 4 ))
    appX=$(( (screenW / 20) * appXsize ))
    appY=$(( (screenH / 20) * 4 ))
	# Save window list and hide windows
	WINDOW_LIST=$(wmctrl -l -x)

    wmctrl -k on

    # Handle lxappearance lifecycle
    pkill -x lxappearance >/dev/null 2>&1 && sleep 0.3
    lxappearance &
    pid=$!
    
    LX=""
    while [ -z "$LX" ]; do
        LX=$(xdotool search --pid "$pid" --name "Appearance" 2>/dev/null | tail -1)
        sleep 0.2
    done
    
    xdotool windowsize "$LX" 600 400
    xdotool windowmove "$LX" "$appX" "$appY"
    xdotool windowactivate "$LX"
    sleep 0.5
    
    xdotool mousemove $((appX - 30)) $((appY + 100)) click 3
    sleep 0.4
    
    my-shots --no-view --no-notify --no-copy --thumb 9 --path "${SCREENSHOT_PATH}" --name "preview.jpg"
    
    # Handle file operations
    ln -sf "${__style_name}/preview.jpg" "${SCREENSHOT_PATH}/../${__style_name}.jpg"

    # Cleanup UI
    xdotool click 1
    kill "$pid" 2>/dev/null

    # Restore windows for the current desktop only
    while read -r id desktop rest; do
        if [ "$desktop" = "$CURRDTOP" ]; then
            xdotool windowactivate "$id"
        fi
    done <<< "$WINDOW_LIST"
}

saveStyle(){
	MSG="  Configurations will be saved to a new directory in  \
    \n  $CONFIGPATH\n\n  Enter name of new collection...  "
    MSG2="  No file specified for new saved session.\n\n  Try again?"
    while true;do  # loop dialog if nothing is selected
        ANS=$($DIALOG --entry \
           	$CANCEL --button="OK:0" \
           	"$T$MSG" \
           	2>/dev/null )
        if [ "$?" -eq 1 ];then # Cancel was selected
           	return
        elif [ ! -f "$ANS" ] ;then     # entry was empty
           	if $DIALOG --image="dialog-question" "$CANCEL" "$OK" "$T$MSG2" 2>/dev/null;then
               	continue
           	else
               	return
           	fi
        else
            ANS=$(echo "$ANS" | sed -e 's/ /_/g')    # replace any spaces in dir name
            CONFIGDIR="$CONFIGPATH/$ANS"
           	if [ -d "$CONFIGDIR" ];then
               	if $DIALOG --form --image="dialog-question" --text="$OVERWRITE_SESSION" "$CANCEL" "$OK" --width=300 2>/dev/null;then
                   	mv "$CONFIGDIR" "${CONFIGDIR}_BKP" && mkdir -p "$CONFIGDIR"
                   	break
               	else
                   	continue
               	fi
			else
               	mkdir -p "$CONFIGDIR"
           		break	
			fi
		fi
	done
	
	create_style_file "${ANS}"
	take_style_screenshot "${ANS}"
	
	# Final notification
    $DIALOG --text="$SETTINGS_SAVED <b>$__style_name</b>" --image="gtk-save" "$OK" 2>/dev/null
    if [ -d "${CONFIGDIR}_BKP" ];then
    	rm -rfd "${CONFIGDIR}_BKP"
    fi
}
	
Intro(){
	TXTINTRO="<big><b>${__distro_title}\n\nOpenbox Configuration Manager</b></big>\n\n\n \
	<b>Save or Restore settings for:</b>\n\n \
	\tOpenbox theme\n \
	\tGTK theme\n \
	\tConkys\n \
	\tTint2\n \
	\tDesktop Background\n \
	\t+ Screenshot\n\n"
	$DIALOGDEC --image=mbs_trans_64 "$T$TXTINTRO" --title="$TITLE" "$CLOSE" --borders=30 2>/dev/null
}

getSet(){
	. "${Distro_config_file}"
   	SET="$Style_name"
}
	
yadMainMenu(){
   	getSet          # get name of latest set BLOB config
   	DLGLIST=""
   	setARR=()
   	namesARR=()
   	thumbsARR=()
   	i=0
   	for dir in "$GLOBALCONFIGPATH"/* "$CONFIGPATH"/* ;do
       	if [ -d "$dir" ];then
           	d=$(echo "$dir" | sed -e 's/ /_/g')    # replace any spaces in dir name
           	namesARR["$i"]="<big>$(basename "$d")</big>" # add theme collection name to array
           	d="${d##*/}"  # get directory name
           	# Get name of current session, set icon for TRUE/FALSE
           	if [ "$SET" = "$d" ];then
               	setARR["$i"]="gtk-yes"
           	else
               	setARR["$i"]="gtk-no"
           	fi
           	IMGTHUMB="Brak"     # Placeholder if no thumbnail found
           	f="$dir"/*"-thumb.jpg"
           	if [ -f "$f" ];then
               	IMGTHUMB="$f"
           	fi
           	thumbsARR["$i"]="$IMGTHUMB"
           	i=$((i+1))
       	fi
   	done
   	for ((j=0; j<${#namesARR[*]}; j++));do
       	DLGLIST="$DLGLIST ${setARR[j]} ${namesARR[j]} ${thumbsARR[j]}"
   	done
   	FPATH=""
   	while true ;do
       	CONFIG=$($DIALOGDEC --list --title="$TITLE" --image=preferences-desktop-theme\
           	--text="$MAIN_TEXT" \
           	--separator=" " \
           	--button="$ABOUT" \
           	--button="$VIEW_IMG" --button="$ADD" \
           	--button="$DELETE" --button=$RESTORE $EXIT \
           	--always-print-result \
           	--width=$yadW --height=$yadH --center --image-preview \
           	--expand-column=3 \
           	--column="$ACTIVE":IMG \
           	--column="$NAME":TEXT \
           	--column="$SCREEN_SHOT":IMG \
           	$DLGLIST \
           	2>/dev/null )
       	RET="$?"
       	if [ -f "$CONFIG" ];then
           	Style=$(echo "$CONFIG" | awk -F'[>|<]' '{print $3}' )
           	if [ -d "$CONFIGPATH/$Style" ];then
           		FPATH="$CONFIGPATH/$Style"
           	else
           		FPATH="$GLOBALCONFIGPATH/$Style"
           	fi
       	fi
       	case "$RET" in
           	0)  # RESTORE
               	CURSESSION="$(basename "$FPATH")"
               	break
               	;;
           	1)  # EXIT
           		exit 0
               	;;
           	2)  # DELETE
           		if [ ! -f "$CONFIG" ];then
                   	if $DIALOG --text="$CHOOSE_BEFORE_DELETE" "$EXIT" "$OK" 2>/dev/null;then
                       	continue
                   	else
                       	exit 0
                   	fi
               	fi
               	TEXT="$DELETE_FOR_SURE"
               	if $DIALOG "$T$TEXT" "$CANCEL" "$OK" 2>/dev/null;then
                   	if [ -d "$FPATH" ];then
                   		rm -rfd "$FPATH"
                   	fi
                   	if [ -L "$FPATH.jpg" ];then
                   		rm "$FPATH.jpg"
                   	fi
                   	currentsession="$CURSESSION"
                   	fpath=$(basename "$FPATH")
                   	if [ "$currentsession" = "$fpath" ];then
                       	CURSESSION=""
                   	fi
                   	yadMainMenu
               	else
                   	continue
               	fi
               	;;
           	3)  #ADD
               	saveStyle
               	yadMainMenu
               	;;
           	4)  # show screenshot in image viewer
               	picked_style_image="$(basename "$FPATH")"
               	if [ -f "$CONFIGPATH/${picked_style_image}.jpg" ];then
           			IMAGE_PATH="$CONFIGPATH/${picked_style_image}.jpg"
           		else
           			IMAGE_PATH="$GLOBALCONFIGPATH/${picked_style_image}.jpg"
           		fi
           		my-image-viewer "$IMAGE_PATH" || echo "failed to locate: $IMAGE_PATH"
               	yadMainMenu
               	;;
           	5)  # ABOUT
           		Intro
               	;;
           	*)  exit ;;
       	esac
   	done
	"${__distro_path_root}"/bin/X11/WM/style_changer "$_panel_name_" "$CURSESSION"
	#if . "$FPATH/lightdm-gtk-greeter.conf";then
   	#	apps_as_root "${__distro_path_root}/bin/not_add_2_path/setLightdmGreeter" "$greeter_background" "$greeter_theme_name" "$greeter_icon_theme_name" "$greeter_font_name" "$greeter_position" \
   	#		|| rofi -e "\n  LightdmGreeter File Restored. \n" -theme "$HOME/.config/rofi/$ROFI_STYLE"/massage.rasi
   	#fi
   	yadMainMenu   
}
# set yad H and W
PRIMARY=$(xrandr -q | awk '/ connected/ {if ($3=="primary") print $4; else print $3}')
PSIZE=${PRIMARY%%x*}    # Primary monitor width
desktopH=$(xrandr -q | awk '/Screen/ {print $10}') # desktop height
desktopH=${desktopH%%,*}    # remove trailing comma
yadW=$(( PSIZE / 3 ))  # 1/3 width primary monitor
yadH=$(( (desktopH / 3)*2 ))  # 2/3 height

getSet
yadMainMenu
exit 0
