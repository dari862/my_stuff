#!/bin/bash
# if this line exist script will be part of hub script.
# if this line exist script will be part of gui scripts.new_name=Style_Manager
# need superuser : called by apps_as_root
# work on this : fix saveStyle

unalias -a

. "$__distro_path_lib"
. "${__distro_path_root}/lib/common/WM"
. "${__distro_path_root}/lib/common/openbox"
. "${Distro_config_file}"

WM_config_blob_dir_name="config/$WM_config_name"

GLOBALBLOBPATH="${__distro_path_root}/system_files/blob"
BLOBPATH="$HOME/.config"

if [ "$_panel_name_" = 'polybar' ];then
	CONFIGPATH="${BLOBPATH}/blob/polybar"
	#CURSESSION="$Style_name"
	CURSESSION="$polybar_STYLE"
elif [ "$_panel_name_" = 'tint2' ];then
	CONFIGPATH="${BLOBPATH}/blob/tint2"
	CURSESSION="$Style_name"
fi

TITLE="BLOB Config Manager"

DIALOG="yad --center --undecorated --borders=20 --window-icon=${__distro_path_root}/Distro_Specific/icons/linux.svg"
DIALOGDEC="yad --center  --borders=20 --window-icon=${__distro_path_root}/Distro_Specific/icons/linux.svg"
yadWarning="yad --center  --borders=20 --window-icon=${__distro_path_root}/Distro_Specific/icons/linux.svg --title Alert  --button='Ok:1' --button='Cancel:0' --text"

CANCEL="--button=Cancel:1"
EXIT="--button=Quit:1"
CLOSE="--button=Close:1"
	
T="--text="
OK="--button=OK:0"

MAIN_TEXT="Double-click selection, or <b>Enter</b>, or use the <b>Restore</b> button to restore settings\n"
RESTORE="Restore:0"
DELETE="Delete:2"
VIEW_IMG="View image:4"
ADD="Add New:3"
ABOUT="About:5"
SAVE_SETTINGS="Save Settings:0"
VIEW_SAVED="View Saved:2"
ACTIVE="Last set"
NAME="Config Name"
SCREEN_SHOT="Screenshot"
CHOOSE_BEFORE_DELETE="Make a selection before trying to delete"
DELETE_FOR_SURE="Delete saved configurations <b>$FPATH</b>\nand screenshot?"
SETTINGS_SAVED="Settings were saved as"
CHOOSE_IMAGE="Make a selection"
OVERWRITE_SESSION="Overwrite existing session?"

MENUMODIFIER="super+space"  # keybind for show root-menu
MOUSECMD="click 3"          # mouse r-click
KEYDOWN=4           # adjust this for where "Preferences" is in the menu

saveStyle(){
	# set __style_name
	MSG="  Configurations will be saved to a new directory in  \
    \n  $CONFIGPATH\n\n  Enter name of new collection...  "
    MSG2="  No file specified for new saved session.\n\n  Try again?"
    DEL=0
    while true;do  # loop dialog if nothing is selected
        ANS=$($DIALOG --entry \
           	$CANCEL --button="OK:0" \
           	"$T$MSG" \
           	2>/dev/null )
        if [ "$?" -eq 1 ];then # Cancel was selected
           	return
        elif [[ ! "$ANS" ]] ;then     # entry was empty
           	$DIALOG --image="dialog-question" \
           	"$CANCEL" "$OK" \
           	"$T$MSG2" \
           	2>/dev/null
           	if [ "$?" -eq 0 ];then
               	continue
           	else
               	return
           	fi
        else
            ANS=$(echo $ANS | sed -e 's/ /_/g')    # replace any spaces in dir name
            CONFIGDIR="$CONFIGPATH/$ANS"
           	if [[ -d "$CONFIGDIR" ]];then
               	if $DIALOG --form --image="dialog-question" --text="$OVERWRITE_SESSION" "$CANCEL" "$OK" --width=300 2>/dev/null;then
                   	mv "$CONFIGDIR" "${CONFIGDIR}_BKP" && mkdir -p "$CONFIGDIR"
                   	break
               	else
                   	continue
               	fi
			else
               	mkdir -p "$CONFIGDIR"
           		break	
			fi
		fi
	done
	
    ########################################
	# create style file
	########################################
	__style_name="${ANS}"
	if [ -z "$__style_name" ] ;then
		CONFIG_DIR="${CONFIGDIR}"
	else
		__style_name=$(echo "$__style_name" | sed -e 's/ /_/g')    # replace any spaces in dir name
		CONFIG_DIR="${CONFIGPATH}/${__style_name}"
	fi
	RCFILE="$OBPATH/rc.xml"
	FEHFILE="$HOME/.fehbg"
	CONKYPATH="$HOME/.config/conky"
	CONKYSESSION="$CONKYPATH/conky-sessionfile"
	TINTSESSION="$HOME/.config/tint2/tint2-sessionfile"
	POLYBAR_AND_ROFI="$HOME/$WM_config_dir_name"
	GTK2="$HOME/.config/gtk-2.0"
	GTK3="$HOME/.config/gtk-3.0"
	PLANK_CACHE="$HOME/.cache/plank.conf"
	PLANK="$HOME/.config/plank"
	DUNSTDir="$HOME/.config/dunst"

	# getplank
    if [[ -f "$PLANK_CACHE" ]];then
        mkdir -p "$CONFIG_DIR/cache"
        cp "$PLANK_CACHE" "$CONFIG_DIR/cache"
        mkdir -p "$PLANK"
        [ -f "$PLANK/plank_" ] && cp "$PLANK/plank_" "$CONFIG_DIR/config/plank"
    fi
    
    # getdunst
	if [[ -f "$DUNSTDir/theme.dunstrc" ]];then
        mkdir -p "$CONFIG_DIR/config/dunst"
        cp "$DUNSTDir/theme.dunstrc" "$CONFIG_DIR/config/dunst"
    fi

	# getConky
    conky_sessionfile_file="$CONFIG_DIR/config/conky/conky-sessionfile"
    mkdir -p "$CONFIG_DIR/config/conky"
    pgrep -a conky | while read pid CMD;do
    	echo "$CMD" >> "$conky_sessionfile_file"
    done
    sed -i "s|conky -c $HOME||g" "${conky_sessionfile_file}" 
    sed -i '/^$/d' "${conky_sessionfile_file}" 
    while IFS="" read -r theme
	do
		mkdir -p "$CONFIG_DIR/config/conky"
		cp -r "${HOME}${theme}" "$CONFIG_DIR/config/conky" >/dev/null 2>&1
	done < ${conky_sessionfile_file}
	
	# getGTKtheme
    GTKTHEMES=( "$GTK2" "$GTK3")
    mkdir -p "$CONFIG_DIR/config"
    for d in "${GTKTHEMES[@]}";do
    	cp -r "$d" "$CONFIG_DIR/config"
    done

	# getTint
    if pgrep -a tint2 >/dev/null 2>&1;then
    	tint2_sessionfile_file="$CONFIG_DIR/config/tint2/tint2-sessionfile"
    	mkdir -p "$CONFIG_DIR/config/tint2"
    	pgrep -a tint2 | while read pid cmd;do
    		if [[ "${cmd%% *}" = tint2 ]];then
    			TPATH=$(echo "$cmd" | awk '{print $NF}')
    			echo "$TPATH" >> "$tint2_sessionfile_file"
    		fi
    	done
    	
    	sed -i "s|$HOME||g" "${tint2_sessionfile_file}" 
    	sed -i '/^$/d' "${tint2_sessionfile_file}"    
    	
    	while IFS="" read -r theme
		do
			cp -r "${HOME}${theme}" "$CONFIG_DIR/config/tint2" >/dev/null 2>&1
		done < ${tint2_sessionfile_file}
	elif pgrep -a polybar >/dev/null 2>&1;then
		mkdir -p "$CONFIG_DIR/$WM_config_blob_dir_name"
    	cp "$WM_config_dir/Polybar_style" "$CONFIG_DIR/$WM_config_blob_dir_name"
    	cp "$WM_config_dir/Rofi_style" "$CONFIG_DIR/$WM_config_blob_dir_name"
	fi
	# getOBtheme
	if pgrep -a openbox >/dev/null 2>&1;then
		while IFS= read -r line; do
  			eval "$line"
		done < <(grep "\!ENTITY" "$RCFILE" | grep _var | sed 's/<!ENTITY//g;s/>//g;s/ //g;s/_var/_var=/g')
		echo "bottom=${bottom_var}" >> "$CONFIG_DIR/openboxrctheme"
		echo "top=${top_var}" >> "$CONFIG_DIR/openboxrctheme"
		echo "right=${right_var}" >> "$CONFIG_DIR/openboxrctheme"
		echo "left=${left_var}" >> "$CONFIG_DIR/openboxrctheme"
		echo "font=${font_var}" >> "$CONFIG_DIR/openboxrctheme"
		echo "size=${size_var}" >> "$CONFIG_DIR/openboxrctheme"
		echo "theme=${theme_var}" >> "$CONFIG_DIR/openboxrctheme"
		echo "titleLayout=${titleLayout_var}" >> "$CONFIG_DIR/openboxrctheme"
	fi
	############ end of get
	########################################
	# take screenshot
	########################################
    pid=""
   	TMPSCREENSHOT=$(mktemp --tmpdir blob.XXXX)
   	SCREENSHOT_PATH="$CONFIGPATH/$ANS"
   	CURRDTOP=$(xprop -root _NET_CURRENT_DESKTOP | tail -c -2) # desktop number
   	MONS=$(xrandr -q | grep -c " connected")    # number of monitors
   	# Set mouse position, for appearance of root-menu
   	screenW=$(xrandr -q | awk '/Screen/ {print $8}')
   	screenH=$(xrandr -q | awk '/Screen/ {print $10}')
   	screenH=${screenH%,}

   	if [ "$MONS" -eq 1 ];then # single monitor
       	appX=$(( (screenW/20)*8 ))
       	menuX=$(( (screenW/20)*2 ))
   	else
       	appX=$(( (screenW/20)*4 ))
       	menuX=$(( (screenW/20)*1 ))
   	fi
   	appY=$(( (screenH/20)*4 ))
   	menuY=$(( (screenH/20)*2 ))
	
   	wmctrl -l -x > "$TMPSCREENSHOT"      # store window list in tempfile
   	wmctrl -k on                    # hide windows, show desktop
   	# show any conkys which have been hidden by wmctrl, (ie not own_window_type desktop);
   	# unless Conkys weren't selected to be saved
   	if [ "$(pidof conky)" ] ;then
   		for CONK in $(xdotool search --classname "Conky");do
       		xdotool windowactivate "$CONK" 2>/dev/null
   		done
   	fi

   	# start lxappearance
   	[ ! "$(pidof lxappearance)" ] && lxappearance &
   	pid=$!
   	sleep 0.5

    # get lx window, make sure it loses focus, then move mouse and start root-menu
    LX=$(xdotool getwindowfocus)
    xdotool windowmove --sync "$LX" "$appX" "$appY" && sleep 0.1 && \
    xdotool mousemove --sync --window "$LX" -- -50 0 && xdotool click 1
    xdotool mousemove --sync "$menuX" "$menuY" && xdotool key --clearmodifiers "$MENUMODIFIER"

	i=1
	while (( $i <= $KEYDOWN ));do
		xdotool key --delay 100 Down
		i=$(( $i+1 ))
	done
	xdotool key --delay 20 Right && sleep 0.3
	
	# take screenshot and make thumbnail @9% fullsize
	my-shots --no-view --no-notify --no-copy --thumb 9 --path "${SCREENSHOT_PATH}" --name "${ANS}.jpg"
	mv "${SCREENSHOT_PATH}"/"${ANS}.jpg" "${SCREENSHOT_PATH}"/preview.jpg
	(cd "${SCREENSHOT_PATH}" && cd .. && ln -sf "${ANS}"/preview.jpg .)
	
	# close root menu
	xdotool mousemove_relative --sync --polar 0 10 click 3
    	
	# kill lxappearance
	if pgrep lxappearance | grep "$pid";then
		kill -9 $pid >/dev/null 2>&1
    fi
	
	# restore hidden windows
    while read line; do
       	WINDOW=$(echo $line | awk '{print $1}') # Window_ID is first field
       	DTOP=$(echo $line | awk '{print $2}' )  # Desktop number is second field
       	if [ "$DTOP" -eq "$CURRDTOP" ];then
           	xdotool windowactivate "$WINDOW"
       	fi
    done < "$TMPSCREENSHOT"
    
    # restore any hidden Conkys
    for CONK in $(xdotool search --classname "Conky");do
       	xdotool windowactivate "$CONK" 2>/dev/null
    done
    
    [ -f "$TMPSCREENSHOT" ] && rm -f "$TMPSCREENSHOT"
   	
   	#############################################################################
	
	$DIALOG --text="$SETTINGS_SAVED <b>$ANS</b>" --image="gtk-save" "$OK" 2>/dev/null
	if [[ -d "$CONFIGDIR-BKP" ]];then
		rm -rf "$CONFIGDIR-BKP"
		echo -e "\n  Temporary $CONFIGDIR deleted\n"
	fi
}

Show_help_(){
	echo "CLI"
}
	
Intro(){
	TXTINTRO="<big><b>${__distro_title}\n\nOpenbox Configuration Manager</b></big>\n\n\n \
	<b>Save or Restore settings for:</b>\n\n \
	\tOpenbox theme\n \
	\tGTK theme\n \
	\tConkys\n \
	\tTint2\n \
	\tDesktop Background\n \
	\t+ Screenshot\n\n"
	$DIALOGDEC --image=mbs_trans_64 "$T$TXTINTRO" \
		--title="$TITLE" \
		$CLOSE --borders=30 \
		2>/dev/null
}
	
Launch_YAD_(){
	CONFIGDIR=""
	
	getSet(){
		. "${Distro_config_file}"
    	SET="$Style_name"
	}
	
	restoreSettings(){
    	getSet          # get name of latest set BLOB config
    	DLGLIST=""
    	setARR=()
    	namesARR=()
    	thumbsARR=()
    	i=0
    	for dir in "$CONFIGPATH"/* ;do
        	if [[ -d "$dir" ]];then
            	d=$(echo $dir | sed -e 's/ /_/g')    # replace any spaces in dir name
            	namesARR[$i]="<big>$(basename $d)</big>" # add theme collection name to array
            	d=${d##*/}  # get directory name
            	# Get name of current session, set icon for TRUE/FALSE
            	if [[ "$SET" = "$d" ]];then
                	setARR[$i]="gtk-yes"
            	else
                	setARR[$i]="gtk-no"
            	fi
            	IMGTHUMB="Brak"     # Placeholder if no thumbnail found
            	f="$dir"/*"-thumb.jpg"
            	if [[ "$f" ]];then
                	IMGTHUMB="$f"
            	fi
            	thumbsARR[$i]="$IMGTHUMB"
            	i=$(($i+1))
        	fi
    	done
    	for ((j=0; j<${#namesARR[*]}; j++));do
        	DLGLIST="$DLGLIST ${setARR[j]} ${namesARR[j]} ${thumbsARR[j]}"
    	done
    	FPATH=""
    	while true ;do
        	CONFIG=$($DIALOGDEC --list --title="$TITLE" --image=preferences-desktop-theme\
            	--text="$MAIN_TEXT" \
            	--separator=" " \
            	--button="$ABOUT" \
            	--button="$VIEW_IMG" --button="$ADD" \
            	--button="$DELETE" --button=$RESTORE $EXIT \
            	--always-print-result \
            	--width=$W --height=$H --center --image-preview \
            	--expand-column=3 \
            	--column="$ACTIVE":IMG \
            	--column="$NAME":TEXT \
            	--column="$SCREEN_SHOT":IMG \
            	$DLGLIST \
            	2>/dev/null )
        	RET=$?
        	if [[ "$CONFIG" ]];then
            	Style=$(echo "$CONFIG" | awk -F'[>|<]' '{print $3}' )
            	FPATH="$CONFIGPATH/$Style"
        	fi
        	case $RET in
            	0)  # RESTORE
                	CURSESSION="$(basename $FPATH)"
                	break
                	;;
            	1)  # EXIT
            		exit 0
                	;;
            	2)  # DELETE
            		if [[ ! "$CONFIG" ]];then
                    	$DIALOG --text="$CHOOSE_BEFORE_DELETE" "$EXIT" "$OK" 2>/dev/null
                    	if [ "$?" -eq 0 ];then
                        	continue
                    	else
                        	exit 0
                    	fi
                	fi
                	TEXT="$DELETE_FOR_SURE"
                	if $DIALOG "$T$TEXT" "$CANCEL" "$OK" 2>/dev/null;then
                    	[ -f "$FPATH" ] && rm -rf "$FPATH"
                    	[ -f "$FPATH.jpg" ] && rm "$FPATH.jpg"
                    	echo -e "\n$Style DELETED"
                    	currentsession="$CURSESSION"
                    	fpath=$(basename $FPATH)
                    	if [[ $currentsession = $fpath ]];then
                        	CURSESSION=""
                    	fi
                    	restoreSettings
                	else
                    	continue
                	fi
                	;;
            	3)  #ADD
                	saveStyle
                	restoreSettings
                	;;
            	4)  # show screenshot in image viewer
                	getSet
                	my-image-viewer "$CONFIGPATH/${SEL}.jpg" || echo "failed to locate: $CONFIGPATH/${SEL}.jpg"
                	restoreSettings
                	;;
            	5)  # ABOUT
            		Intro
                	;;
            	*)  exit ;;
        	esac
    	done
		"${__distro_path_root}"/bin/X11/WM/style_changer "$_panel_name_" "$CURSESSION"
		if . "$FPATH/lightdm-gtk-greeter.conf";then
    		apps_as_root "${__distro_path_root}/bin/not_add_2_path/setLightdmGreeter" "$greeter_background" "$greeter_theme_name" "$greeter_icon_theme_name" "$greeter_font_name" "$greeter_position" \
    			|| rofi -e "\n  LightdmGreeter File Restored. \n" -theme "$HOME/.config/rofi/$ROFI_STYLE"/massage.rasi
    	fi
    	restoreSettings   
	}
	# set yad H and W
    PRIMARY=$(xrandr -q | awk '/ connected/ {if ($3=="primary") print $4; else print $3}')
    PSIZE=${PRIMARY%%x*}    # Primary monitor width
    desktopW=$(xrandr -q | awk '/Screen/ {print $8}')  # total desktop width
    desktopH=$(xrandr -q | awk '/Screen/ {print $10}') # desktop height
    desktopH=${desktopH%%,*}    # remove trailing comma
    W=$(( $PSIZE / 3 ))  # 1/3 width primary monitor
    H=$(( ($desktopH / 3)*2 ))  # 2/3 height
    
	getSet
	restoreSettings
	exit 0
}

Launch_YAD_
