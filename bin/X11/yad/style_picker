#!/bin/bash
# if this line exist script will be part of hub script.
# if this line exist script will be part of gui scripts.new_name=Style_Manager
# need superuser : called by apps_as_root
# work on this : fix saveStyle

unalias -a

. "$__distro_path_lib"
. "${__distro_path_root}/lib/common/WM"
. "${__distro_path_root}/lib/common/openbox"
. "${Distro_config_file}"

WM_config_blob_dir_name="config/$WM_config_name"

CONFIGHOMEPATH="$HOME/.config"
GLOBALBLOBPATH="${__distro_path_root}/blob"
BLOBPATH="${CONFIGHOMEPATH}/blob"

if [ "$_panel_name_" = 'polybar' ];then
	GLOBALCONFIGPATH="${GLOBALBLOBPATH}/polybar"
	CONFIGPATH="${BLOBPATH}/polybar"
	CURSESSION="$Style_name"
elif [ "$_panel_name_" = 'tint2' ];then
	GLOBALCONFIGPATH="${GLOBALBLOBPATH}/tint2"
	CONFIGPATH="${BLOBPATH}/polybar"
	CURSESSION="$Style_name"
fi

TITLE="BLOB Config Manager"

DIALOG="yad --center --undecorated --borders=20 --window-icon=${__distro_path_root}/Distro_Specific/icons/linux.svg"
DIALOGDEC="yad --center  --borders=20 --window-icon=${__distro_path_root}/Distro_Specific/icons/linux.svg"
yadWarning="yad --center  --borders=20 --window-icon=${__distro_path_root}/Distro_Specific/icons/linux.svg --title Alert  --button='Ok:1' --button='Cancel:0' --text"

CANCEL="--button=Cancel:1"
EXIT="--button=Quit:1"
CLOSE="--button=Close:1"
	
T="--text="
OK="--button=OK:0"

MAIN_TEXT="Double-click selection, or <b>Enter</b>, or use the <b>Restore</b> button to restore settings\n"
RESTORE="Restore:0"
DELETE="Delete:2"
VIEW_IMG="View image:4"
ADD="Add New:3"
ABOUT="About:5"
SAVE_SETTINGS="Save Settings:0"
VIEW_SAVED="View Saved:2"
ACTIVE="Last set"
NAME="Config Name"
SCREEN_SHOT="Screenshot"
CHOOSE_BEFORE_DELETE="Make a selection before trying to delete"
DELETE_FOR_SURE="Delete saved configurations <b>$FPATH</b>\nand screenshot?"
SETTINGS_SAVED="Settings were saved as"
CHOOSE_IMAGE="Make a selection"
OVERWRITE_SESSION="Overwrite existing session?"

MENUMODIFIER="super+space"  # keybind for show root-menu
MOUSECMD="click 3"          # mouse r-click
KEYDOWN=4           # adjust this for where "Preferences" is in the menu

saveStyle(){
	# set __style_name
	MSG="  Configurations will be saved to a new directory in  \
    \n  $CONFIGPATH\n\n  Enter name of new collection...  "
    MSG2="  No file specified for new saved session.\n\n  Try again?"
    DEL=0
    while true;do  # loop dialog if nothing is selected
        ANS=$($DIALOG --entry \
           	$CANCEL --button="OK:0" \
           	"$T$MSG" \
           	2>/dev/null )
        if [ "$?" -eq 1 ];then # Cancel was selected
           	return
        elif [[ ! "$ANS" ]] ;then     # entry was empty
           	$DIALOG --image="dialog-question" \
           	"$CANCEL" "$OK" \
           	"$T$MSG2" \
           	2>/dev/null
           	if [ "$?" -eq 0 ];then
               	continue
           	else
               	return
           	fi
        else
            ANS=$(echo $ANS | sed -e 's/ /_/g')    # replace any spaces in dir name
            CONFIGDIR="$CONFIGPATH/$ANS"
           	if [[ -d "$CONFIGDIR" ]];then
               	if $DIALOG --form --image="dialog-question" --text="$OVERWRITE_SESSION" "$CANCEL" "$OK" --width=300 2>/dev/null;then
                   	mv "$CONFIGDIR" "${CONFIGDIR}_BKP" && mkdir -p "$CONFIGDIR"
                   	break
               	else
                   	continue
               	fi
			else
               	mkdir -p "$CONFIGDIR"
           		break	
			fi
		fi
	done
	
    ########################################
	# create style file
	########################################
	__style_name="${ANS}"
tee "$CONFIGDIR"/style.conf << EOF >/dev/null 2>&1
Style_name="${__style_name}"

# Distro_config
##############
$(cat "$CONFIGHOMEPATH"/WM_common_config/Distro_config 2>/dev/null || :)

# dunstrc
##############
dunstrc_icon_position=$(grep '^icon_position' "${CONFIGHOMEPATH}/dunst/dunstrc" | awk -F'= ' '{print $2}' || :)
dunstrc_frame_color="$(grep '^frame_color' "${CONFIGHOMEPATH}/dunst/dunstrc" | awk -F'"' '{print $2}' | head -n1 || :)"
dunstrc_separator_color=$(grep '^separator_color' "${CONFIGHOMEPATH}/dunst/dunstrc" | awk -F'= ' '{print $2}' || :)
dunstrc_transparency=$(grep '^transparency' "${CONFIGHOMEPATH}/dunst/dunstrc" | awk -F'= ' '{print $2}' || :)
dunstrc_origin=$(grep '^origin' "${CONFIGHOMEPATH}/dunst/dunstrc" | awk -F'= ' '{print $2}' || :)
dunstrc_offset="$(grep '^offset' "${CONFIGHOMEPATH}/dunst/dunstrc" | awk -F'= ' '{print $2}' || :)"
dunstrc_frame_width=$(grep '^frame_width' "${CONFIGHOMEPATH}/dunst/dunstrc" | awk -F'= ' '{print $2}' || :)
dunstrc_format=$(grep '^format' "${CONFIGHOMEPATH}/dunst/dunstrc" | awk -F'= ' '{print $2}' || :)
dunstrc_low_timeout=$(awk '/\[urgency_low\]/ {f=1} f && /timeout/ {print} f && /^$/ {f=0}' "${CONFIGHOMEPATH}/dunst/dunstrc" | awk -F'= ' '{print $2}' || :)
dunstrc_low_background="$(awk '/\[urgency_low\]/ {f=1} f && /background/ {print} f && /^$/ {f=0}' "${CONFIGHOMEPATH}/dunst/dunstrc" | awk -F'"' '{print $2}' || :)"
dunstrc_low_foreground="$(awk '/\[urgency_low\]/ {f=1} f && /foreground/ {print} f && /^$/ {f=0}' "${CONFIGHOMEPATH}/dunst/dunstrc" | awk -F'"' '{print $2}' || :)"
dunstrc_low_frame_color="$(awk '/\[urgency_low\]/ {f=1} f && /frame_color/ {print} f && /^$/ {f=0}' "${CONFIGHOMEPATH}/dunst/dunstrc" | awk -F'"' '{print $2}' || :)"
dunstrc_normal_timeout=$(awk '/\[urgency_normal\]/ {f=1} f && /timeout/ {print} f && /^$/ {f=0}' "${CONFIGHOMEPATH}/dunst/dunstrc" | awk -F'= ' '{print $2}' || :)
dunstrc_normal_background="$(awk '/\[urgency_normal\]/ {f=1} f && /background/ {print} f && /^$/ {f=0}' "${CONFIGHOMEPATH}/dunst/dunstrc" | awk -F'"' '{print $2}' || :)"
dunstrc_normal_foreground="$(awk '/\[urgency_normal\]/ {f=1} f && /foreground/ {print} f && /^$/ {f=0}' "${CONFIGHOMEPATH}/dunst/dunstrc" | awk -F'"' '{print $2}' || :)"
dunstrc_normal_frame_color="$(awk '/\[urgency_normal\]/ {f=1} f && /frame_color/ {print} f && /^$/ {f=0}' "${CONFIGHOMEPATH}/dunst/dunstrc" | awk -F'"' '{print $2}' || :)"
dunstrc_critical_timeout=$(awk '/\[urgency_critical\]/ {f=1} f && /timeout/ {print} f && /^$/ {f=0}' "${CONFIGHOMEPATH}/dunst/dunstrc" | awk -F'= ' '{print $2}' || :)
dunstrc_critical_background="$(awk '/\[urgency_critical\]/ {f=1} f && /background/ {print} f && /^$/ {f=0}' "${CONFIGHOMEPATH}/dunst/dunstrc" | awk -F'"' '{print $2}' || :)"
dunstrc_critical_foreground="$(awk '/\[urgency_critical\]/ {f=1} f && /foreground/ {print} f && /^$/ {f=0}' "${CONFIGHOMEPATH}/dunst/dunstrc" | awk -F'"' '{print $2}' || :)"
dunstrc_critical_frame_color="$(awk '/\[urgency_critical\]/ {f=1} f && /frame_color/ {print} f && /^$/ {f=0}' "${CONFIGHOMEPATH}/dunst/dunstrc" | awk -F'"' '{print $2}' || :)"

# gtkrc_theme
##############
gtk_theme_name="$(grep '^gtk-theme-name' "${CONFIGHOMEPATH}/gtk-3.0/settings.ini" | awk -F= '{print $2}' || :)"
gtk_icon_name="$(grep '^gtk-icon-theme-name' "${CONFIGHOMEPATH}/gtk-3.0/settings.ini" | awk -F= '{print $2}' || :)"
gtk_font_name="$(grep '^gtk-font-name' "${CONFIGHOMEPATH}/gtk-3.0/settings.ini" | awk -F= '{print $2}' || :)"
gtk_cursor_name="$(grep '^gtk-cursor-theme-name' "${CONFIGHOMEPATH}/gtk-3.0/settings.ini" | awk -F= '{print $2}' || :)"

# openbox
##############
openbox_menu=$(ls -al "${CONFIGHOMEPATH}/openbox/menu.xml" | awk '{print $11}' || :)
openbox_bottom=$(grep "ENTITY bottom_var" "${CONFIGHOMEPATH}/openbox/rc.xml" | awk -F'"' '{print $2}' || :)
openbox_top=$(grep "ENTITY top_var" "${CONFIGHOMEPATH}/openbox/rc.xml" | awk -F'"' '{print $2}' || :)
openbox_right=$(grep "ENTITY right_var" "${CONFIGHOMEPATH}/openbox/rc.xml" | awk -F'"' '{print $2}' || :)
openbox_left=$(grep "ENTITY left_var" "${CONFIGHOMEPATH}/openbox/rc.xml" | awk -F'"' '{print $2}' || :)
openbox_font=$(grep "ENTITY font_var" "${CONFIGHOMEPATH}/openbox/rc.xml" | awk -F'"' '{print $2}' || :)
openbox_size=$(grep "ENTITY size_var" "${CONFIGHOMEPATH}/openbox/rc.xml" | awk -F'"' '{print $2}' || :)
openbox_theme=$(grep "ENTITY theme_var" "${CONFIGHOMEPATH}/openbox/rc.xml" | awk -F'"' '{print $2}' || :)
openbox_titleLayout=$(grep "ENTITY titleLayout_var" "${CONFIGHOMEPATH}/openbox/rc.xml" | awk -F'"' '{print $2}' || :)
openbox_gtk_icon_name="$(grep '^gtk-theme-name' "${CONFIGHOMEPATH}/gtk-3.0/settings.ini" | awk -F= '{print $2}' || :)"

# rofi
##############
rofi_background="$(grep 'background:' "${CONFIGHOMEPATH}/rofi/theme.rasi" | sed "s/;//g" | awk -F'#' '{print "#" $2}' || :)"
rofi_active="$(grep 'active:' "${CONFIGHOMEPATH}/rofi/theme.rasi" | sed "s/;//g" | awk -F'#' '{print "#" $2}' || :)"
rofi_background_alt="$(grep 'background_alt:' "${CONFIGHOMEPATH}/rofi/theme.rasi" | sed "s/;//g" | awk -F'#' '{print "#" $2}' || :)"
rofi_foreground="$(grep 'foreground:' "${CONFIGHOMEPATH}/rofi/theme.rasi" | sed "s/;//g" | awk -F'#' '{print "#" $2}' || :)"
rofi_selected="$(grep 'selected:' "${CONFIGHOMEPATH}/rofi/theme.rasi" | sed "s/;//g" | awk -F'#' '{print "#" $2}' || :)"
rofi_urgent="$(grep 'urgent:' "${CONFIGHOMEPATH}/rofi/theme.rasi" | sed "s/;//g" | awk -F'#' '{print "#" $2}' || :)"
rofi_font="$(grep ' font:' "${CONFIGHOMEPATH}/rofi/fonts.rasi" | awk -F'"' '{print $2}' || :)"
rofi_text_font="$(grep 'text-font:' "${CONFIGHOMEPATH}/rofi/fonts.rasi" | awk -F'"' '{print $2}' || echo '@font')"
rofi_icon_font="$(grep 'icon-font:' "${CONFIGHOMEPATH}/rofi/fonts.rasi" | awk -F'"' '{print $2}' || echo '@font')"

# bspwm
##############
$(cat "$CONFIGHOMEPATH"/bspwm/theme-bspwm.conf 2>/dev/null || :)

# alacritty
##############
alacritty_family="$([ -f "${CONFIGHOMEPATH}/alacritty/fonts.yml" ] && grep 'family:' "${CONFIGHOMEPATH}/alacritty/fonts.yml" 2>/dev/null | head -n1 | awk -F': ' '{print $2}' | sed 's/"//g' || echo "JetBrainsMono Nerd Font")"
alacritty_size=$([ -f "${CONFIGHOMEPATH}/alacritty/fonts.yml" ] && grep 'size:' "${CONFIGHOMEPATH}/alacritty/fonts.yml" 2>/dev/null | head -n1 | awk -F': ' '{print $2}' | sed 's/"//g' || echo "10")

# jgmenu
##############
jgmenu_font="$(grep '^font' "${CONFIGHOMEPATH}/jgmenu/jgmenurc" | awk -F'= '  '{print $2}' | awk '{$NF=""; print $0}' || :)"
jgmenu_size="$(grep '^font' "${CONFIGHOMEPATH}/jgmenu/jgmenurc" | awk -F'= '  '{print $2}' | awk '{print $NF}' || :)"
jgmenu_color_menu_bg="$(grep '^color_menu_bg' "${CONFIGHOMEPATH}/jgmenu/jgmenurc" | awk -F'= '  '{print $2}' || :)"
jgmenu_color_menu_border="$(grep '^color_menu_border' "${CONFIGHOMEPATH}/jgmenu/jgmenurc" | awk -F'= '  '{print $2}' || :)"
jgmenu_color_norm_bg="$(grep '^color_norm_bg' "${CONFIGHOMEPATH}/jgmenu/jgmenurc" | awk -F'= '  '{print $2}' || :)"
jgmenu_color_norm_fg="$(grep '^color_norm_fg' "${CONFIGHOMEPATH}/jgmenu/jgmenurc" | awk -F'= '  '{print $2}' || :)"
jgmenu_color_sel_bg="$(grep '^color_sel_bg' "${CONFIGHOMEPATH}/jgmenu/jgmenurc" | awk -F'= '  '{print $2}' || :)"
jgmenu_color_sel_fg="$(grep '^color_sel_fg' "${CONFIGHOMEPATH}/jgmenu/jgmenurc" | awk -F'= '  '{print $2}' || :)"
jgmenu_color_sel_border="$(grep '^color_sel_border' "${CONFIGHOMEPATH}/jgmenu/jgmenurc" | awk -F'= '  '{print $2}' || :)"
jgmenu_color_title_bg="$(grep '^color_title_bg' "${CONFIGHOMEPATH}/jgmenu/jgmenurc" | awk -F'= '  '{print $2}' || :)"
jgmenu_color_title_fg="$(grep '^color_title_fg' "${CONFIGHOMEPATH}/jgmenu/jgmenurc" | awk -F'= '  '{print $2}' || :)"
jgmenu_color_title_border="$(grep '^color_title_border' "${CONFIGHOMEPATH}/jgmenu/jgmenurc" | awk -F'= '  '{print $2}' || :)"
jgmenu_color_sep_fg="$(grep '^color_sep_fg' "${CONFIGHOMEPATH}/jgmenu/jgmenurc" | awk -F'= '  '{print $2}' || :)"
jgmenu_item_margin_x="$(grep '^item_margin_x' "${CONFIGHOMEPATH}/jgmenu/jgmenurc" | awk -F'= '  '{print $2}' || :)"
jgmenu_item_margin_y="$(grep '^item_margin_y' "${CONFIGHOMEPATH}/jgmenu/jgmenurc" | awk -F'= '  '{print $2}' || :)"
jgmenu_stay_alive="$(grep '^stay_alive' "${CONFIGHOMEPATH}/jgmenu/jgmenurc" | awk -F'= '  '{print $2}' || :)"
jgmenu_menu_padding_right="$(grep '^menu_padding_right' "${CONFIGHOMEPATH}/jgmenu/jgmenurc" | awk -F'= '  '{print $2}' || :)"
jgmenu_menu_padding_bottom="$(grep '^menu_padding_bottom' "${CONFIGHOMEPATH}/jgmenu/jgmenurc" | awk -F'= '  '{print $2}' || :)"
jgmenu_menu_padding_left="$(grep '^menu_padding_left' "${CONFIGHOMEPATH}/jgmenu/jgmenurc" | awk -F'= '  '{print $2}' || :)"
jgmenu_menu_radius="$(grep '^menu_radius' "${CONFIGHOMEPATH}/jgmenu/jgmenurc" | awk -F'= '  '{print $2}' || :)"
jgmenu_sep_halign="$(grep '^sep_halign' "${CONFIGHOMEPATH}/jgmenu/jgmenurc" | awk -F'= '  '{print $2}' || :)"
jgmenu_icon_size="$(grep '^icon_size' "${CONFIGHOMEPATH}/jgmenu/jgmenurc" | awk -F'= '  '{print $2}' || :)"
jgmenu_icon_theme="$(grep '^icon_theme' "${CONFIGHOMEPATH}/jgmenu/jgmenurc" | awk -F'= '  '{print $2}' || :)"
jgmenu_menu_border="$(grep '^menu_border' "${CONFIGHOMEPATH}/jgmenu/jgmenurc" | awk -F'= '  '{print $2}' || :)"

# lightdm-greeter
##############
$(cat "$CONFIGHOMEPATH"/WM_common_config/lightdm-greeter.conf 2>/dev/null || :)

# plank
##############
plank_use_plank="$(pidof -q plank && echo yes || echo no)"
plank_hide_mode=$(grep '^hide-mode' "$HOME"/.cache/plank.conf 2>/dev/null | awk -F= '{print $2}' || :)
plank_offset=$(grep '^offset' "$HOME"/.cache/plank.conf 2>/dev/null | awk -F= '{print $2}' || :)
plank_position=$(grep '^position' "$HOME"/.cache/plank.conf 2>/dev/null | awk -F= '{print $2}' || :)
EOF
	############ end of get
	########################################
	# take screenshot
	########################################
    pid=""
   	TMPSCREENSHOT=$(mktemp --tmpdir blob.XXXX)
   	SCREENSHOT_PATH="$CONFIGPATH/$ANS"
   	CURRDTOP=$(xprop -root _NET_CURRENT_DESKTOP | tail -c -2) # desktop number
   	MONS=$(xrandr -q | grep -c " connected")    # number of monitors
   	# Set mouse position, for appearance of root-menu
   	screenW=$(xrandr -q | awk '/Screen/ {print $8}')
   	screenH=$(xrandr -q | awk '/Screen/ {print $10}')
   	screenH=${screenH%,}

   	if [ "$MONS" -eq 1 ];then # single monitor
       	appX=$(( (screenW/20)*8 ))
       	menuX=$(( (screenW/20)*2 ))
   	else
       	appX=$(( (screenW/20)*4 ))
       	menuX=$(( (screenW/20)*1 ))
   	fi
   	appY=$(( (screenH/20)*4 ))
   	menuY=$(( (screenH/20)*2 ))
	
   	wmctrl -l -x > "$TMPSCREENSHOT"      # store window list in tempfile
   	wmctrl -k on                    # hide windows, show desktop
   	# show any conkys which have been hidden by wmctrl, (ie not own_window_type desktop);
   	# unless Conkys weren't selected to be saved
   	if pidof -q conky ;then
   		for CONK in $(xdotool search --classname "Conky");do
       		xdotool windowactivate "$CONK" 2>/dev/null
   		done
   	fi

   	# start lxappearance
   	pidof -q lxappearance || lxappearance &
   	pid=$!
   	sleep 0.5

    # get lx window, make sure it loses focus, then move mouse and start root-menu
    LX=$(xdotool getwindowfocus)
    xdotool windowmove --sync "$LX" "$appX" "$appY" && sleep 0.1 && \
    xdotool mousemove --sync --window "$LX" -- -50 0 && xdotool click 1
    xdotool mousemove --sync "$menuX" "$menuY" && xdotool key --clearmodifiers "$MENUMODIFIER"

	i=1
	while (( $i <= $KEYDOWN ));do
		xdotool key --delay 100 Down
		i=$(( $i+1 ))
	done
	xdotool key --delay 20 Right && sleep 0.3
	
	# take screenshot and make thumbnail @9% fullsize
	my-shots --no-view --no-notify --no-copy --thumb 9 --path "${SCREENSHOT_PATH}" --name "${ANS}.jpg"
	mv "${SCREENSHOT_PATH}"/"${ANS}.jpg" "${SCREENSHOT_PATH}"/preview.jpg
	(cd "${SCREENSHOT_PATH}" && cd .. && ln -sf "${ANS}"/preview.jpg .)
	
	# close root menu
	xdotool mousemove_relative --sync --polar 0 10 click 3
    	
	# kill lxappearance
	if pgrep lxappearance | grep "$pid";then
		kill -9 $pid >/dev/null 2>&1
    fi
	
	# restore hidden windows
    while read line; do
       	WINDOW=$(echo $line | awk '{print $1}') # Window_ID is first field
       	DTOP=$(echo $line | awk '{print $2}' )  # Desktop number is second field
       	if [ "$DTOP" -eq "$CURRDTOP" ];then
           	xdotool windowactivate "$WINDOW"
       	fi
    done < "$TMPSCREENSHOT"
    
    # restore any hidden Conkys
    for CONK in $(xdotool search --classname "Conky");do
       	xdotool windowactivate "$CONK" 2>/dev/null
    done
    
    [ -f "$TMPSCREENSHOT" ] && rm -f "$TMPSCREENSHOT"
   	
   	#############################################################################
	
	$DIALOG --text="$SETTINGS_SAVED <b>$ANS</b>" --image="gtk-save" "$OK" 2>/dev/null
	if [[ -d "${CONFIGDIR}_BKP" ]];then
		rm -rf "${CONFIGDIR}_BKP"
	fi
}

Show_help_(){
	echo "CLI"
}
	
Intro(){
	TXTINTRO="<big><b>${__distro_title}\n\nOpenbox Configuration Manager</b></big>\n\n\n \
	<b>Save or Restore settings for:</b>\n\n \
	\tOpenbox theme\n \
	\tGTK theme\n \
	\tConkys\n \
	\tTint2\n \
	\tDesktop Background\n \
	\t+ Screenshot\n\n"
	$DIALOGDEC --image=mbs_trans_64 "$T$TXTINTRO" \
		--title="$TITLE" \
		$CLOSE --borders=30 \
		2>/dev/null
}
	
Launch_YAD_(){
	CONFIGDIR=""
	
	getSet(){
		. "${Distro_config_file}"
    	SET="$Style_name"
	}
	
	restoreSettings(){
    	getSet          # get name of latest set BLOB config
    	DLGLIST=""
    	setARR=()
    	namesARR=()
    	thumbsARR=()
    	i=0
    	for dir in "$GLOBALCONFIGPATH"/* "$CONFIGPATH"/* ;do
        	if [[ -d "$dir" ]];then
            	d=$(echo $dir | sed -e 's/ /_/g')    # replace any spaces in dir name
            	namesARR[$i]="<big>$(basename $d)</big>" # add theme collection name to array
            	d=${d##*/}  # get directory name
            	# Get name of current session, set icon for TRUE/FALSE
            	if [[ "$SET" = "$d" ]];then
                	setARR[$i]="gtk-yes"
            	else
                	setARR[$i]="gtk-no"
            	fi
            	IMGTHUMB="Brak"     # Placeholder if no thumbnail found
            	f="$dir"/*"-thumb.jpg"
            	if [[ "$f" ]];then
                	IMGTHUMB="$f"
            	fi
            	thumbsARR[$i]="$IMGTHUMB"
            	i=$(($i+1))
        	fi
    	done
    	for ((j=0; j<${#namesARR[*]}; j++));do
        	DLGLIST="$DLGLIST ${setARR[j]} ${namesARR[j]} ${thumbsARR[j]}"
    	done
    	FPATH=""
    	while true ;do
        	CONFIG=$($DIALOGDEC --list --title="$TITLE" --image=preferences-desktop-theme\
            	--text="$MAIN_TEXT" \
            	--separator=" " \
            	--button="$ABOUT" \
            	--button="$VIEW_IMG" --button="$ADD" \
            	--button="$DELETE" --button=$RESTORE $EXIT \
            	--always-print-result \
            	--width=$W --height=$H --center --image-preview \
            	--expand-column=3 \
            	--column="$ACTIVE":IMG \
            	--column="$NAME":TEXT \
            	--column="$SCREEN_SHOT":IMG \
            	$DLGLIST \
            	2>/dev/null )
        	RET=$?
        	if [[ "$CONFIG" ]];then
            	Style=$(echo "$CONFIG" | awk -F'[>|<]' '{print $3}' )
            	if [ -d "$CONFIGPATH/$Style" ];then
            		FPATH="$CONFIGPATH/$Style"
            	else
            		FPATH="$GLOBALCONFIGPATH/$Style"
            	fi
        	fi
        	case $RET in
            	0)  # RESTORE
                	CURSESSION="$(basename $FPATH)"
                	break
                	;;
            	1)  # EXIT
            		exit 0
                	;;
            	2)  # DELETE
            		if [[ ! "$CONFIG" ]];then
                    	$DIALOG --text="$CHOOSE_BEFORE_DELETE" "$EXIT" "$OK" 2>/dev/null
                    	if [ "$?" -eq 0 ];then
                        	continue
                    	else
                        	exit 0
                    	fi
                	fi
                	TEXT="$DELETE_FOR_SURE"
                	if $DIALOG "$T$TEXT" "$CANCEL" "$OK" 2>/dev/null;then
                    	[ -f "$FPATH" ] && rm -rf "$FPATH"
                    	[ -f "$FPATH.jpg" ] && rm "$FPATH.jpg"
                    	echo -e "\n$Style DELETED"
                    	currentsession="$CURSESSION"
                    	fpath=$(basename $FPATH)
                    	if [[ $currentsession = $fpath ]];then
                        	CURSESSION=""
                    	fi
                    	restoreSettings
                	else
                    	continue
                	fi
                	;;
            	3)  #ADD
                	saveStyle
                	restoreSettings
                	;;
            	4)  # show screenshot in image viewer
                	getSet
                	if [ -f "$CONFIGPATH/${SEL}.jpg" ];then
            			my-image-viewer "$CONFIGPATH/${SEL}.jpg"
            		else
            			my-image-viewer "$GLOBALCONFIGPATH/${SEL}.jpg" || echo "failed to locate: $GLOBALCONFIGPATH/${SEL}.jpg"
            		fi
                	restoreSettings
                	;;
            	5)  # ABOUT
            		Intro
                	;;
            	*)  exit ;;
        	esac
    	done
		"${__distro_path_root}"/bin/X11/WM/style_changer "$_panel_name_" "$CURSESSION"
		#if . "$FPATH/lightdm-gtk-greeter.conf";then
    	#	apps_as_root "${__distro_path_root}/bin/not_add_2_path/setLightdmGreeter" "$greeter_background" "$greeter_theme_name" "$greeter_icon_theme_name" "$greeter_font_name" "$greeter_position" \
    	#		|| rofi -e "\n  LightdmGreeter File Restored. \n" -theme "$HOME/.config/rofi/$ROFI_STYLE"/massage.rasi
    	#fi
    	restoreSettings   
	}
	# set yad H and W
    PRIMARY=$(xrandr -q | awk '/ connected/ {if ($3=="primary") print $4; else print $3}')
    PSIZE=${PRIMARY%%x*}    # Primary monitor width
    desktopW=$(xrandr -q | awk '/Screen/ {print $8}')  # total desktop width
    desktopH=$(xrandr -q | awk '/Screen/ {print $10}') # desktop height
    desktopH=${desktopH%%,*}    # remove trailing comma
    W=$(( $PSIZE / 3 ))  # 1/3 width primary monitor
    H=$(( ($desktopH / 3)*2 ))  # 2/3 height
    
	getSet
	restoreSettings
	exit 0
}

Launch_YAD_
