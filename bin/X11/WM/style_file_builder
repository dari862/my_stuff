#!/bin/sh
. "$__distro_path_lib"
wallpaper="${1:-}"

show_em(){
	echo "[ERROR] $0 : $1"
	exit 1
}

if [ -z "${wallpaper}" ];then
	if [ -t 1 ];then # on terminal
		pickbg
	else
		popup_terminal pickbg
	fi
fi

. "${__distro_path_root}/lib/common/WM"
. "${Distro_config_file}"

_style="dynamic"
dynamicGTKPATH="$HOME/.local/dynamic_theme"
CONFIGPATH="$HOME/.config"

if [ -z "${wallpaper}" ];then
	wallpaper="${wallpaper_are}"
else
	wallpaper="$(realpath "${wallpaper}")"
	setbg -s "${wallpaper}"
fi

theme_color_creater_output_folder="/tmp/$USER/theme_color_creater_output"

"${__distro_path_root}"/bin/dynamic_theme_scripts/theme_color_creater "${_style}" "$theme_color_creater_output_folder" "${wallpaper}" || show_em "failed to run system_default_colors"

cp -r "${theme_color_creater_output_folder}/colors-dunstrc.conf" "$CONFIGPATH/dunst/theme.dunstrc"
[ ! -f "$HOME/.config/dunst/global" ] && cp -r "${__distro_path_root}/skel_extra/.config/dunst/global" "$HOME/.config/dunst" || :
[ ! -f "$HOME/.config/dunst/experimental" ] && cp -r "${__distro_path_root}/skel_extra/.config/dunst/experimental" "$HOME/.config/dunst" || :
[ ! -f "$HOME/.config/dunst/theme.dunstrc" ] && cp -r "${__distro_path_root}/skel_extra/.config/dunst/theme.dunstrc" "$HOME/.config/dunst" || :
cat "$CONFIGPATH"/dunst/global "$CONFIGPATH"/dunst/theme.dunstrc > "$CONFIGPATH"/dunst/dunstrc

dunstify -u normal --replace=699 -i "${__distro_path_all_distro_themes}/icons/channelmixer.svg" "Applying Style : ${_style}"

blob_gtk_theme_path="$HOME/.themes"
cat "${theme_color_creater_output_folder}/gtk_theme"/dynamic-dark.css > "$blob_gtk_theme_path"/dynamic-nord/general/dark.css
cat "${theme_color_creater_output_folder}/gtk_theme"/dynamic-nord-gtkrc > "$blob_gtk_theme_path"/dynamic-nord/gtk-2.0/gtkrc
cat "${theme_color_creater_output_folder}/gtk_theme"/dynamic-gtkrc > "$blob_gtk_theme_path"/dynamic/gtk-2.0/gtkrc
cat "${theme_color_creater_output_folder}/gtk_theme"/gtk-3.0.css > "$blob_gtk_theme_path"/dynamic/gtk-3.0/gtk.css
cat "${theme_color_creater_output_folder}/gtk_theme"/gtk-3.20.css > "$blob_gtk_theme_path"/dynamic/gtk-3.20/gtk.css
cat "${theme_color_creater_output_folder}/gtk_theme"/openbox-3 > "$blob_gtk_theme_path"/dynamic/openbox-3/themerc

blob_gtk_icon_path="$HOME/.icons"
cp -r "${theme_color_creater_output_folder}/gtk-icons"/* "$blob_gtk_icon_path"

if [ "$_panel_name_" = 'polybar' ];then
	cp -r "${theme_color_creater_output_folder}/colors-polybar.conf" "${CONFIGPATH}/polybar/${_style}/colors.ini"
elif [ "$_panel_name_" = 'tint2' ];then
	echo "/.config/tint2/${_style}_new.tint2rc" > "${CONFIGPATH}/tint2/tint2-sessionfile"
	cp -r "${theme_color_creater_output_folder}/colors-tint2rc.conf" "${CONFIGPATH}/tint2/${_style}_new.tint2rc"
	sed -i "s/(((__distro_path_root)))/${__distro_path_root}/g" "${CONFIGPATH}/tint2/${_style}_new.tint2rc"
	sed -i "s|greeter_background=.*|greeter_background=\"${wallpaper}\"|g" "${CONFIGPATH}/blob/${_style}/lightdm-gtk-greeter.conf"
fi

if [ -d "${CONFIGPATH}/jgmenu" ];then
	. "${theme_color_creater_output_folder}/colors-jgmenu.conf"
	jgmenurc_file="${CONFIGPATH}/jgmenu/jgmenurc"
	#create jgmenu theme file
	sed -i "s/font .*/font                = $font $size/g" "$jgmenurc_file"
	sed -i "s/color_menu_bg .*/color_menu_bg       = $color_menu_bg/g" "$jgmenurc_file"
	sed -i "s/color_menu_border .*/color_menu_border   = $color_menu_border/g" "$jgmenurc_file"
	sed -i "s/color_norm_bg .*/color_norm_bg       = $color_norm_bg/g" "$jgmenurc_file"
	sed -i "s/color_norm_fg .*/color_norm_fg       = $color_norm_fg/g" "$jgmenurc_file"
	sed -i "s/color_sel_bg .*/color_sel_bg        = $color_sel_bg/g" "$jgmenurc_file"
	sed -i "s/color_sel_fg .*/color_sel_fg        = $color_sel_fg/g" "$jgmenurc_file"
	sed -i "s/color_sel_border .*/color_sel_border    = $color_sel_border/g" "$jgmenurc_file"
	sed -i "s/color_title_bg .*/color_title_bg      = $color_title_bg/g" "$jgmenurc_file"
	sed -i "s/color_title_fg .*/color_title_fg      = $color_title_fg/g" "$jgmenurc_file"
	sed -i "s/color_title_border .*/color_title_border  = $color_title_border/g" "$jgmenurc_file"
	sed -i "s/color_sep_fg .*/color_sep_fg        = $color_sep_fg/g" "$jgmenurc_file"
	sed -i "s/stay_alive .*/stay_alive        = $stay_alive/g" "$jgmenurc_file"
	sed -i "s/menu_padding_right .*/menu_padding_right        = $menu_padding_right/g" "$jgmenurc_file"
	sed -i "s/menu_padding_bottom .*/menu_padding_bottom        = $menu_padding_bottom/g" "$jgmenurc_file"
	sed -i "s/menu_padding_left .*/menu_padding_left        = $menu_padding_left/g" "$jgmenurc_file"
	sed -i "s/menu_radius .*/menu_radius        = $menu_radius/g" "$jgmenurc_file"
	sed -i "s/sep_halign .*/sep_halign        = $sep_halign/g" "$jgmenurc_file"
	sed -i "s/icon_size .*/icon_size        = $icon_size/g" "$jgmenurc_file"
	sed -i "s/icon_theme .*/icon_theme        = $icon_theme/g" "$jgmenurc_file"
	sed -i "s/menu_border .*/menu_border        = $menu_border/g" "$jgmenurc_file"
fi

if [ -d "${CONFIGPATH}/geany" ];then
	blob_geany_theme_path="${CONFIGPATH}/geany"
	echo "${_style}_new.conf" > "${blob_geany_theme_path}/theme.conf"
	cp -r "${theme_color_creater_output_folder}/colors-geany.conf" "$blob_geany_theme_path/colorschemes/${_style}_new.conf"
fi

if [ -d "${CONFIGPATH}/kitty" ];then
	blob_kitty_theme_path="${CONFIGPATH}/kitty"
	mkdir -p "$blob_kitty_theme_path/themes"
	echo "background_opacity 0.8" > "${blob_kitty_theme_path}/theme.conf"
	echo "# color scheme" >> "${blob_kitty_theme_path}/theme.conf"
	echo "include ./themes/${_style}_new.conf" >> "${blob_kitty_theme_path}/theme.conf"
	cp -r "${theme_color_creater_output_folder}/colors-kitty.conf" "$blob_kitty_theme_path/themes/${_style}_new.conf"
fi

if [ -d "${CONFIGPATH}/alacritty" ];then
	blob_alacritty_theme_path="${CONFIGPATH}/alacritty"
	mkdir -p "$blob_alacritty_theme_path/colorschemes"
	cp -r "${theme_color_creater_output_folder}/colors-alacritty.yml" "$blob_alacritty_theme_path/colorschemes/${_style}_new.yml"
	( cd "$blob_alacritty_theme_path" && ln -sf "colorschemes/${_style}_new.yml" "colors.yml" )
fi

if [ -d "${CONFIGPATH}/rofi" ];then
	cp -r "${theme_color_creater_output_folder}/colors-rofi.rasi" "${CONFIGPATH}/rofi/theme.rasi"
fi

if [ -d "${CONFIGPATH}/x11/Xresources.d" ];then
	cp -r "${theme_color_creater_output_folder}/colors.Xresources" "${CONFIGPATH}/x11/Xresources.d/themes/${_style}_new"
	( cd "${CONFIGPATH}/x11/Xresources.d" && ln -sf "themes/${_style}_new" "colors" )
fi

if [ -d "${CONFIGPATH}/bspwm" ];then
	cp -r "${theme_color_creater_output_folder}/colors-dunstrc.conf" "${CONFIGPATH}/bspwm/theme.conf"
fi

if pgrep openbox >/dev/null 2>&1;then
	reconfigure-openbox || show_em "failed to run reconfigure-openbox "
fi

"${__distro_path_root}"/bin/X11/WM/reload_gtk23 || show_em "failed to run reload_gtk23"

"${__distro_path_root}"/bin/X11/WM/panel_launcher
