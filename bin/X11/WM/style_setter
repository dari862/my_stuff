#!/bin/sh
set -e

. "$__distro_path_lib"
_panel_name_="${1:-polybar}"
_style="${2:-default}"

. "${__distro_path_root}/lib/common/WM"
. "${__distro_path_root}/lib/common/openbox"

CONFIGPATH="$HOME/.config"
CURSESSION="$WM_config_dir/tint2_style"

show_em(){
	echo "[ERROR] $0 : $1"
}

OB_themeing(){
	. "$CONFIGPATH/openbox/openboxrctheme"
	cp -r "${BACKUP_OB_RC_FILE}" "${OBPATH}"
	
	sed -i 's/theme_var "'.*'"/theme_var "'"$theme"'"/g' "${OBPATH}"/rc.xml
	sed -i 's/titleLayout_var "'.*'"/titleLayout_var "'"$titleLayout"'"/g' "${OBPATH}"/rc.xml
	sed -i 's/top_var "'.*'"/top_var "'"$top"'"/g' "${OBPATH}"/rc.xml
	sed -i 's/bottom_var "'.*'"/bottom_var "'"$bottom"'"/g' "${OBPATH}"/rc.xml
	sed -i 's/right_var "'.*'"/right_var "'"$right"'"/g' "${OBPATH}"/rc.xml
	sed -i 's/left_var "'.*'"/left_var "'"$left"'"/g' "${OBPATH}"/rc.xml
	sed -i 's/font_var "'.*'"/font_var "'"$font"'"/g' "${OBPATH}"/rc.xml
	sed -i 's/size_var "'.*'"/size_var "'"$size"'"/g' "${OBPATH}"/rc.xml
}

Set_Style_(){
	[ ! -f "${CONFIGPATH}/dunst/global" ] && cp -r "${__distro_path_root}/skel_extra/.config/dunst/global" "${CONFIGPATH}/dunst" || :
	[ ! -f "${CONFIGPATH}/dunst/experimental" ] && cp -r "${__distro_path_root}/skel_extra/.config/dunst/experimental" "${CONFIGPATH}/dunst" || :
	[ ! -f "${CONFIGPATH}/dunst/theme.dunstrc" ] && cp -r "${__distro_path_root}/skel_extra/.config/dunst/theme.dunstrc" "${CONFIGPATH}/dunst" || :
	cat "${CONFIGPATH}/dunst/global" "${CONFIGPATH}/dunst/theme.dunstrc" > "${CONFIGPATH}"/dunst/dunstrc
	OB_themeing
}

. "${Distro_config_file}"

if [ "${_style}" = "dynamic" ];then
	"${__distro_path_root}"/bin/dynamic_theme_scripts/gtk_theme_builder "_SAVED_"
fi

if [ -d "${CONFIGPATH}/geany" ];then
	theme_geany || show_em "failed to run theme_geany"
fi

if [ -d "${CONFIGPATH}/jgmenu" ];then
	if [ ! -f "$HOME/.cache/jgmenu/.last-gtktheme" ];then
		mkdir -p "$HOME/.cache/jgmenu"
		touch "$HOME/.cache/jgmenu/.last-gtktheme"
	fi
	. "${CONFIGPATH}/jgmenu/jgmenu_theme"
	jgmenurc_file="${CONFIGPATH}/jgmenu/jgmenurc"
	#generate jgmenu theme file
	sed -i "s/font .*/font                = $font $size/g" "$jgmenurc_file"
	sed -i "s/color_menu_bg .*/color_menu_bg       = $color_menu_bg/g" "$jgmenurc_file"
	sed -i "s/color_menu_border .*/color_menu_border   = $color_menu_border/g" "$jgmenurc_file"
	sed -i "s/color_norm_bg .*/color_norm_bg       = $color_norm_bg/g" "$jgmenurc_file"
	sed -i "s/color_norm_fg .*/color_norm_fg       = $color_norm_fg/g" "$jgmenurc_file"
	sed -i "s/color_sel_bg .*/color_sel_bg        = $color_sel_bg/g" "$jgmenurc_file"
	sed -i "s/color_sel_fg .*/color_sel_fg        = $color_sel_fg/g" "$jgmenurc_file"
	sed -i "s/color_sel_border .*/color_sel_border    = $color_sel_border/g" "$jgmenurc_file"
	sed -i "s/color_title_bg .*/color_title_bg      = $color_title_bg/g" "$jgmenurc_file"
	sed -i "s/color_title_fg .*/color_title_fg      = $color_title_fg/g" "$jgmenurc_file"
	sed -i "s/color_title_border .*/color_title_border  = $color_title_border/g" "$jgmenurc_file"
	sed -i "s/color_sep_fg .*/color_sep_fg        = $color_sep_fg/g" "$jgmenurc_file"
	sed -i "s/stay_alive .*/stay_alive        = $stay_alive/g" "$jgmenurc_file"
	sed -i "s/menu_padding_right .*/menu_padding_right        = $menu_padding_right/g" "$jgmenurc_file"
	sed -i "s/menu_padding_bottom .*/menu_padding_bottom        = $menu_padding_bottom/g" "$jgmenurc_file"
	sed -i "s/menu_padding_left .*/menu_padding_left        = $menu_padding_left/g" "$jgmenurc_file"
	sed -i "s/menu_radius .*/menu_radius        = $menu_radius/g" "$jgmenurc_file"
	sed -i "s/sep_halign .*/sep_halign        = $sep_halign/g" "$jgmenurc_file"
	sed -i "s/icon_size .*/icon_size        = $icon_size/g" "$jgmenurc_file"
	sed -i "s/icon_theme .*/icon_theme        = $icon_theme/g" "$jgmenurc_file"
	sed -i "s/menu_border .*/menu_border        = $menu_border/g" "$jgmenurc_file"
fi

Set_Style_ || show_em "failed to run Set_Style_"

if [ "$_panel_name_" = 'polybar' ];then
	"${__distro_path_root}"/bin/X11/polybar/polybar_alternative_style
	"${__distro_path_root}"/bin/X11/polybar/build_polybar_launcher
fi

if pgrep openbox >/dev/null 2>&1;then
	reconfigure-openbox || show_em "failed to run reconfigure-openbox "
fi

"${__distro_path_root}"/bin/X11/WM/reload_gtk23 || show_em "failed to run reload_gtk23"
