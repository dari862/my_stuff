#!/bin/sh
set -e
# work on this : colors not 100% accurete
. "$__distro_path_lib"
. "${__distro_path_root}/lib/common/WM"
. "${Distro_config_file}"

_style="dynamic"
dynamicGTKPATH="$HOME/.local/dynamic_theme"
CONFIGPATH="$HOME/.config"

wallpaper="${1:-}"

if [ -z "${wallpaper}" ];then
	if [ -t 1 ];then # on terminal
		pickbg
	else
		popup_terminal pickbg
	fi
fi

if [ -z "${wallpaper}" ];then
	wallpaper="${wallpaper_are}"
else
	wallpaper="$(realpath "${wallpaper}")"
	setbg -s "${wallpaper}"
fi

dynamic_theme_scripts_dir="${__distro_path_root}/bin/dynamic_theme_scripts"
dynamic_theme_common_file_name="common.sh"
dynamic_theme_sed_them_file_name="sed_them.sh"
dynamic_theme_common_file_path="${dynamic_theme_scripts_dir}/${dynamic_theme_common_file_name}"
. "${dynamic_theme_common_file_path}"

# Remove temp theme file directory if it exists
if [ -d "$temp_theme_file_dir" ];then
	rm -rdf "$temp_theme_file_dir"
fi

mkdir -p "$temp_theme_file_dir"

"${dynamic_theme_scripts_dir}"/theme_color_file_builder "${dynamic_theme_scripts_dir}" "$dynamic_theme_common_file_name" "${wallpaper}" || show_em "failed to run theme_color_file_builder"
"${dynamic_theme_scripts_dir}"/themes_builder "${dynamic_theme_scripts_dir}" "$dynamic_theme_common_file_name" "${dynamic_theme_sed_them_file_name}" || show_em "failed to run themes_builder"

cp -r "${themes_builder_output_dir}/colors-dunstrc.conf" "$CONFIGPATH/dunst/theme.dunstrc"
[ ! -f "$HOME/.config/dunst/global" ] && cp -r "${__distro_path_root}/skel_extra/.config/dunst/global" "$HOME/.config/dunst" || :
[ ! -f "$HOME/.config/dunst/experimental" ] && cp -r "${__distro_path_root}/skel_extra/.config/dunst/experimental" "$HOME/.config/dunst" || :
[ ! -f "$HOME/.config/dunst/theme.dunstrc" ] && cp -r "${__distro_path_root}/skel_extra/.config/dunst/theme.dunstrc" "$HOME/.config/dunst" || :
cat "$CONFIGPATH"/dunst/global "$CONFIGPATH"/dunst/theme.dunstrc > "$CONFIGPATH"/dunst/dunstrc

dunstify -u normal --replace=699 -i "${__distro_path_all_distro_themes}/icons/channelmixer.svg" "Applying Style : ${_style}"

if [ "$_panel_name_" = 'polybar' ];then
	cp -r "${themes_builder_output_dir}/colors-polybar.conf" "${CONFIGPATH}/polybar/${_style}/colors.ini"
elif [ "$_panel_name_" = 'tint2' ];then
	echo "/.config/tint2/${_style}_new.tint2rc" > "${CONFIGPATH}/tint2/tint2-sessionfile"
	cp -r "${themes_builder_output_dir}/colors-tint2rc.conf" "${CONFIGPATH}/tint2/${_style}_new.tint2rc"
	sed -i "s/(((__distro_path_root)))/${__distro_path_root}/g" "${CONFIGPATH}/tint2/${_style}_new.tint2rc"
	sed -i "s|greeter_background=.*|greeter_background=\"${wallpaper}\"|g" "${CONFIGPATH}/blob/${_style}/lightdm-gtk-greeter.conf"
fi

if [ -d "${CONFIGPATH}/jgmenu" ];then
	. "${themes_builder_output_dir}/colors-jgmenu.conf"
	jgmenurc_file="${CONFIGPATH}/jgmenu/jgmenurc"
	sed -i "s/font .*/font                = $font $size/g" "$jgmenurc_file"
	sed -i "s/color_menu_bg .*/color_menu_bg       = $color_menu_bg/g" "$jgmenurc_file"
	sed -i "s/color_menu_border .*/color_menu_border   = $color_menu_border/g" "$jgmenurc_file"
	sed -i "s/color_norm_bg .*/color_norm_bg       = $color_norm_bg/g" "$jgmenurc_file"
	sed -i "s/color_norm_fg .*/color_norm_fg       = $color_norm_fg/g" "$jgmenurc_file"
	sed -i "s/color_sel_bg .*/color_sel_bg        = $color_sel_bg/g" "$jgmenurc_file"
	sed -i "s/color_sel_fg .*/color_sel_fg        = $color_sel_fg/g" "$jgmenurc_file"
	sed -i "s/color_sel_border .*/color_sel_border    = $color_sel_border/g" "$jgmenurc_file"
	sed -i "s/color_title_bg .*/color_title_bg      = $color_title_bg/g" "$jgmenurc_file"
	sed -i "s/color_title_fg .*/color_title_fg      = $color_title_fg/g" "$jgmenurc_file"
	sed -i "s/color_title_border .*/color_title_border  = $color_title_border/g" "$jgmenurc_file"
	sed -i "s/color_sep_fg .*/color_sep_fg        = $color_sep_fg/g" "$jgmenurc_file"
	sed -i "s/stay_alive .*/stay_alive        = $stay_alive/g" "$jgmenurc_file"
	sed -i "s/menu_padding_right .*/menu_padding_right        = $menu_padding_right/g" "$jgmenurc_file"
	sed -i "s/menu_padding_bottom .*/menu_padding_bottom        = $menu_padding_bottom/g" "$jgmenurc_file"
	sed -i "s/menu_padding_left .*/menu_padding_left        = $menu_padding_left/g" "$jgmenurc_file"
	sed -i "s/menu_radius .*/menu_radius        = $menu_radius/g" "$jgmenurc_file"
	sed -i "s/sep_halign .*/sep_halign        = $sep_halign/g" "$jgmenurc_file"
	sed -i "s/icon_size .*/icon_size        = $icon_size/g" "$jgmenurc_file"
	sed -i "s/icon_theme .*/icon_theme        = $icon_theme/g" "$jgmenurc_file"
	sed -i "s/menu_border .*/menu_border        = $menu_border/g" "$jgmenurc_file"
fi

if [ -d "${CONFIGPATH}/geany" ];then
	geany_theme_path="${CONFIGPATH}/geany"
	echo "${_style}_new.conf" > "${geany_theme_path}/theme.conf"
	cp -r "${themes_builder_output_dir}/colors-geany.conf" "$geany_theme_path/colorschemes/${_style}_new.conf"
fi

if [ -d "${CONFIGPATH}/kitty" ];then
	kitty_theme_path="${CONFIGPATH}/kitty"
	mkdir -p "$kitty_theme_path/themes"
	echo "background_opacity 0.8" > "${kitty_theme_path}/theme.conf"
	echo "# color scheme" >> "${kitty_theme_path}/theme.conf"
	echo "include ./themes/${_style}_new.conf" >> "${kitty_theme_path}/theme.conf"
	cp -r "${themes_builder_output_dir}/colors-kitty.conf" "$kitty_theme_path/themes/${_style}_new.conf"
fi

if [ -d "${CONFIGPATH}/alacritty" ];then
	alacritty_theme_path="${CONFIGPATH}/alacritty"
	mkdir -p "$alacritty_theme_path/colorschemes"
	cp -r "${themes_builder_output_dir}/colors-alacritty.yml" "$alacritty_theme_path/colorschemes/${_style}_new.yml"
	( cd "$alacritty_theme_path" && ln -sf "colorschemes/${_style}_new.yml" "colors.yml" )
fi

if [ -d "${CONFIGPATH}/rofi" ];then
	cp -r "${themes_builder_output_dir}/colors-rofi.rasi" "${CONFIGPATH}/rofi/theme.rasi"
fi

if [ -d "${CONFIGPATH}/x11/Xresources.d" ];then
	cp -r "${themes_builder_output_dir}/colors.Xresources" "${CONFIGPATH}/x11/Xresources.d/themes/${_style}_new"
	( cd "${CONFIGPATH}/x11/Xresources.d" && ln -sf "themes/${_style}_new" "colors" )
fi

if [ -d "${CONFIGPATH}/bspwm" ];then
	cp -r "${themes_builder_output_dir}/colors-dunstrc.conf" "${CONFIGPATH}/bspwm/theme.conf"
fi

if pgrep openbox >/dev/null 2>&1;then
	reconfigure-openbox || show_em "failed to run reconfigure-openbox "
fi

"${dynamic_theme_scripts_dir}"/gtk_theme_builder "${dynamic_theme_scripts_dir}" "$dynamic_theme_common_file_name" "${dynamic_theme_sed_them_file_name}" || show_em "failed to run gtk_theme_builder"
"${__distro_path_root}"/bin/X11/WM/panel_launcher || show_em "failed to run panel_launcher"
