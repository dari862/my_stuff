#!/bin/sh
set -e

. "$__distro_path_lib"
. "${__distro_path_root}/lib/common/WM"
. "${__distro_path_root}/lib/common/openbox"

. "${Distro_config_file}"

dynamicGTKPATH="$HOME/.local/dynamic_theme"
CONFIGPATH="$HOME/.config"

wallpaper="${1:-}"

if [ "$Style_name" != "dynamic" ];then
	current_mode_are="dynamic"
else
	old_wallpaper_are="$wallpaper_are"
	if [ -z "${wallpaper}" ];then
		if [ -t 1 ];then # on terminal
			pickbg save
		else
			popup_terminal "pickbg save"
		fi
	elif [ -n "${wallpaper}" ];then
		setbg -s "$(realpath "${wallpaper}")"
	fi
	
	. "${Distro_config_file}"
	
	if [ "$wallpaper_are" = "$old_wallpaper_are" ];then
		current_mode_are="modified"
	else
		current_mode_are="generate"
	fi
fi

_style="dynamic"
dynamic_theme_scripts_dir="${__distro_path_root}/lib/Dynamic"
temp_theme_file_dir="/tmp/$USER/theme_color_builder_output"
themes_builder_output_dir="${temp_theme_file_dir}/templates"

show_em(){
	echo "[ERROR] $0 ${sourced_file}: $1"
	exit 1
}
	
# Remove temp theme file directory if it exists
if [ -d "$temp_theme_file_dir" ];then
	rm -rdf "$temp_theme_file_dir"
fi

mkdir -p "$temp_theme_file_dir"

gtk_theme_path="$HOME/.themes"
gtk_icon_path="$HOME/.icons"
	
if [ "$current_mode_are" = "dynamic" ];then
	if [ ! -f "$HOME/.config/blob/${_panel_name_}/${_style}/style.conf" ];then
		mkdir -p "$HOME/.config/blob/${_panel_name_}/${_style}"
		cp -r "${__distro_path_root}/blob/${_panel_name_}/${_style}/style.conf" "$HOME/.config/blob/${_panel_name_}/${_style}"
	fi
	dunstify -u normal --replace=699 -i "${__distro_path_all_distro_themes}/icons/channelmixer.svg" "Applying Style : ${_style}"
elif [ "$current_mode_are" = "generate" ];then
	sourced_file="at theme_color_file_builder"
	. "${dynamic_theme_scripts_dir}/theme_color_file_builder"
fi

. "$HOME/.config/blob/${_panel_name_}/${_style}/style.conf"
	
sourced_file="at style_file_builder"
. "${__distro_path_root}"/lib/Style/style_file_builder
sourced_file="at style_setter"
. "${__distro_path_root}"/lib/Style/style_setter

setbg -r || show_em "failed to run setbg -r"

sourced_file="at gtk_theme_builder"
. "${dynamic_theme_scripts_dir}/gtk_theme_builder"
sourced_file="at themes_builder"
. "${dynamic_theme_scripts_dir}/themes_builder"
sourced_file=""

"${__distro_path_root}"/bin/X11/WM/panel_launcher || show_em "failed to run panel_launcher"
