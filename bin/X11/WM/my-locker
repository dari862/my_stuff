#!/bin/sh
set -e
. "$__distro_path_lib"
"${__distro_path_root}/bin/not_add_2_path"/check_4_dependencies_if_installed i3lock || exit 1

. "${__distro_path_root}/lib/common/WM"

__arg_="${1-}"
__passed_image_="${2-}"
__image_full_path_="${__passed_image_}"

my_locker_folder="${script_config_path}/locker"

if [ ! -d "$my_locker_folder" ];then
	cp -r "${__distro_path_root}/skel/.config/scriptconfig/locker" "${script_config_path}"
fi

if [ ! -f "$my_locker_folder/config.ini" ];then
	cp -r "${__distro_path_root}/skel/.config/scriptconfig/locker/config.ini" "$my_locker_folder"
fi

_desktop_screenshot_as_lockscreen()
{
	if [ "$color" = "white" ]; then #white background image and black text
    	bw="black"
    	icon="${__distro_path_all_distro_themes}/icons/lock/lockdark.png"
    	param="--inside-color=0000001c --ring-color=0000003e \
        	--line-color=00000000 --keyhl-color=ffffff80 --ringver-color=ffffff00 \
        	--separator-color=22222260 --insidever-color=ffffff1c \
        	--ringwrong-color=ffffff55 --insidewrong-color=ffffff1c \
        	--verif-color=ffffff00 --wrong-color=ff000000 --time-color=ffffff00 \
        	--date-color=ffffff00 --layout-color=ffffff00"
	else
    	bw="white"
    	icon="${__distro_path_all_distro_themes}/icons/lock/lock.png"
    	param="--inside-color=ffffff1c --ring-color=ffffff3e \
        	--line-color=ffffff00 --keyhl-color=00000080 --ringver-color=00000000 \
        	--separator-color=22222260 --insidever-color=0000001c \
        	--ringwrong-color=00000055 --insidewrong-color=0000001c \
        	--verif-color=00000000 --wrong-color=ff000000 --time-color=00000000 \
        	--date-color=00000000 --layout-color=00000000"
	fi
		
	_path="/tmp/$USER"
	_name="lockscreen.png"
	__image_full_path_="${_path}/${_name}"
	
	[ "${greyscale}" = "true" ] && greyscale_arg="-level 0%,100%,0.6 -colorspace Gray" || greyscale_arg=""
	[ "${pixelate}" = "true" ] && pixelate_arg="-scale 10% -scale 1000%" || pixelate_arg=""

	# If invoked with -d/--desktop, we'll attempt to minimize all windows (ie. show
	# the desktop) before locking.
	[ "${minimize_all_windows}" = "true" ] && wmctrl is /usr/bin/wmctrl -k on || :
	
	my-shots --no-notify --no-copy --no-view --win --path "$_path" --name "$_name" --delete
	
	# As above, if we were passed -d/--desktop, we'll attempt to restore all windows
	# after unlocking.
	[ "${minimize_all_windows}" = "true" ] && wmctrl is /usr/bin/wmctrl -k off
	
    magick "$__image_full_path_" $greyscale_arg $pixelate_arg -font "$font" -pointsize 26 -fill "$bw" -gravity center \
    	-annotate +0+160 "$lock_text" "${icon}" -gravity center -composite "$__image_full_path_"
}

_usr_image_as_lockscreen()
{
	if [ "$background" = "wallpaper" ];then
		. "${Distro_config_file}"
		__image_full_path_="${wallpaper_are}"
	else
		__image_full_path_="$background"
	fi
		
	File_type=$(file "$__image_full_path_" | awk '{print $2}')
	
	if [ "$File_type" = "PNG" ];then
  		return 0
  	else
		magick "$__image_full_path_" "${my_locker_folder}/converted_image.png"
		__image_full_path_="${my_locker_folder}/converted_image.png"
	fi
}

case "$__arg_" in
	-s) if [ -n "$__passed_image_" ];then
			sed -i "s/background=.*/background=\"${__passed_image_}\"/g" "$my_locker_folder/config.ini"
		else
			echo "$0: please pick any image."
			exit 1
		fi
	;;
	-d) sed -i "s/background=.*/background=/g" "$my_locker_folder/config.ini" ;;
	-w)	sed -i "s/background=.*/background=\"wallpaper\"/g" "$my_locker_folder/config.ini"
	;;
	*) : ;;
esac

. "$my_locker_folder/config.ini"

if [ -z "$background" ];then
	_desktop_screenshot_as_lockscreen
else
	_usr_image_as_lockscreen		
fi

kswitch us

if command -v i3lock-color >/dev/null 2>&1; then
	i3lock-color -i "$__image_full_path_" "$param"
else
	i3lock -i "$__image_full_path_"
fi
