#!/bin/sh
_SUPERUSER="my-superuser"
[ "$(id -u)" -eq 0 ] && _SUPERUSER=""
. "$__distro_path_lib"

dist=$(lsb_release -cs)
if [ "n/a" = "$dist" ];then
    dist=testing
else
	what_2_grep="${dist}-backports"
	if [ -f "/etc/apt/sources.list" ];then
		mirror="http://deb.debian.org/debian/"
		mirror_security="http://security.debian.org/debian-security"
		apt_sources_file_path="/etc/apt/sources.list"
		line_2_sed=$(grep -E "^(deb|deb-src) (${mirror}|${mirror_security})" "${apt_sources_file_path}" | grep -v "$what_2_grep" )
	elif [ -f "/etc/apt/sources.list.d/debian.sources" ];then
		apt_sources_file_path="/etc/apt/sources.list.d/debian.sources"
		line_2_sed=$(grep "Components: " "${apt_sources_file_path}" | grep -v "$what_2_grep" )
	fi
fi

if [ -z "$line_2_sed" ];then # enabled
	tweek_enabled=true 
elif [ "$1" = "--is-enable" ] || [ "$check_tweek" = "true" ];then # disabled and only check
	tweek_enabled=false
else
	printf '%s\n' "$line_2_sed" | while IFS= read -r l; do
		${_SUPERUSER} sed -i "s\\^$l$\\$l ${what_2_grep}\\" "$apt_sources_file_path"
	done

	Package_update_

	command -v bash >/dev/null 2>&1 && ${_SUPERUSER} ln -s "${__distro_path_disabled_completion}"/bash/backports_install_auto_completion "${__distro_path_enabled_completion}"/bash
	command -v zsh >/dev/null 2>&1 && ${_SUPERUSER} ln -s "${__distro_path_disabled_completion}"/zsh/backports_install_auto_completion "${__distro_path_enabled_completion}"/zsh
fi
