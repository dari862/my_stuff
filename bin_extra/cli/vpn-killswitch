#!/bin/sh
# POSIX compliant VPN Killswitch
set -e
. "$__distro_path_lib"
"${__distro_path_root}/bin/not_add_2_path"/check_4_dependencies_if_installed drill ufw nmcli || exit 1

show_error() { printf "\033[0;91mERROR: %s\033[0m\n" "$*" >&2; }
show_header() { printf "\033[0;96m%s\033[0m\n" "$*"; }
show_listitem() { printf "\033[0;97m  * %s\033[0m\n" "$*"; }

get_active_interface() {
    nmcli -t -f DEVICE,TYPE,STATE device | grep ":connected" | grep -vE ":(bridge|vpn|tun|tap)" | cut -d: -f1 | head -n1
}

get_vpn_data() {
    dev="$1"
    vpn_uuid=$(nmcli -t -f UUID,TYPE,DEVICE connection show --active | grep ":vpn:${dev}" | cut -d: -f1)
    if [ -n "$vpn_uuid" ]; then
        nmcli connection show "$vpn_uuid"
    fi
}

get_vpn_endpoints() {
    echo "$1" | sed -n 's/^VPN.GATEWAY: //p' | tr ',' '\n'
}

get_status() {
    show_header "Current Network Status:"
    pub_ip=$(curl -s https://ifconfig.me || echo "Unknown")
    show_listitem "Public IP: $pub_ip"
    
    if nmcli device status | grep -qE "tun|tap|wireguard"; then
        show_listitem "VPN Interface: Active"
    else
        show_listitem "VPN Interface: Inactive"
    fi
}

enable_killswitch() {
    device=$(get_active_interface)
    if [ -z "$device" ]; then show_error "No active device."; exit 2; fi

    vpndata=$(get_vpn_data "$device")
    if [ -z "$vpndata" ]; then show_error "No active VPN on $device."; exit 2; fi

    show_header "Enabling Killswitch on $device..."

    my-superuser ufw --force reset
    my-superuser ufw default deny incoming
    my-superuser ufw default deny outgoing

    # Dynamic Tunnel Detection: Allow any tun, tap, or wg interface
    # POSIX uses 'tun+' wildcard in UFW as a robust catch-all
    my-superuser ufw allow out on tun+ to any
    my-superuser ufw allow out on tap+ to any
    my-superuser ufw allow out on wg+ to any

    endpoints=$(get_vpn_endpoints "$vpndata")
    for entry in $endpoints; do
        host=$(echo "$entry" | cut -d: -f1)
        port=$(echo "$entry" | cut -d: -f2)
        ip=$(drill +short "$host" | tail -n1)
        [ -z "$ip" ] && ip="$host"

        show_listitem "Whitelisting VPN Server: $ip:$port"
        my-superuser ufw allow out on "$device" to "$ip" port "$port"
    done

    my-superuser ufw enable
}

disable_killswitch() {
    my-superuser ufw --force reset
    my-superuser ufw default deny incoming
    my-superuser ufw default allow outgoing
    my-superuser ufw enable
    show_header "Killswitch disabled."
}

show_help(){
	show_header "Usage: $0 [-e|--enable] [-d|--disable] [-s|--status]"
}

case "$1" in
    -e|--enable)	enable_killswitch;;
    -d|--disable)	disable_killswitch ;;
    -s|--status) 	get_status ;;
    '') 			show_help; exit 0 ;;
    *)				show_error "Invalid option: $1" ; show_help ; exit 1 ;;
esac
