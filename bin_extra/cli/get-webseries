#!/bin/bash
# A robust wrapper for yt-dlp to manage series and playlist downloads.

set -e

# --- Defaults ---
YTDL="yt-dlp"
RESOLUTION=720
START=1
VIDEODIR="$(pwd)"

# --- Functions ---
show_help() {
    cat << EOF
Usage: $(basename "$0") [OPTIONS]

A smart wrapper for yt-dlp to download and archive web series.

Options:
  -h, --help                Show this help message and exit
  -u, --url URL             The URL of the playlist or video
  -n, --name NAME           Name of the series (creates a sub-folder)
  -d, --destination DIR     Root directory for downloads (default: current dir)
  -r, --resolution RES      Max resolution (720, 1080, 1440, 2160) (default: 720)
  -s, --start INDEX         Playlist index to start from (default: 1)

Example:
  $(basename "$0") -u "https://link-to-series" -n "My Favorite Show" -r 1080
EOF
}

ask_question() {
    read -p "$1: " answer
    echo "$answer"
}

check_command() {
    if ! command -v "$1" >/dev/null 2>&1; then
        echo "ERROR: $1 is not installed. Please install it to continue."
        return 1
    fi
}

# --- Initialization ---
check_command "${YTDL}" || exit 1

# Parse Options
OPTIONS=h d:n:r:s:u:
LONGOPTIONS=help,destination:,name:,resolution:,start:,url:
PARSED=$(getopt -o ${OPTIONS} --long ${LONGOPTIONS} -n "$0" -- "$@")
eval set -- "${PARSED}"

while true; do
    case "$1" in
        -h|--help)        show_help; exit 0 ;;
        -d|--destination) VIDEODIR="$2"; shift 2 ;;
        -n|--name)        NAME="$2";     shift 2 ;;
        -u|--url)         URL="$2";      shift 2 ;;
        -r|--resolution)  RESOLUTION=$(echo "$2" | tr -d 'pi'); shift 2 ;;
        -s|--start)       START="$2";    shift 2 ;;
        --)               shift; break ;;
        *)                echo "Unknown option: $1"; exit 3 ;;
    esac
done

# --- Validation & Interaction ---
if [ -z "$URL" ]; then
    URL=$(ask_question "Enter URL")
fi

if [ -z "$NAME" ]; then
    NAME=$(ask_question "Enter Series Name (for folder naming)")
fi

# Map resolution to yt-dlp format filter
case "${RESOLUTION}" in
    1080) LIMIT="[height<=?1080]" ;;
    1440) LIMIT="[height<=?1440]" ;;
    2160) LIMIT="[height<=?2160]" ;;
    *)    LIMIT="[height<=?720]"  ;;
esac

# Create and move to directory
TARGET_PATH="${VIDEODIR}/${NAME}"
mkdir -p "$TARGET_PATH"
cd "$TARGET_PATH"

echo "--> Syncing '$NAME' to $TARGET_PATH"
echo "--> Quality: ${RESOLUTION}p | Starting at: ${START}"

# --- Execution ---
"${YTDL}" "${URL}" \
    --format "bestvideo${LIMIT}+bestaudio/best${LIMIT}" \
    --merge-output-format mp4 \
    --write-sub --embed-subs --all-subs \
    --add-metadata \
    --playlist-start "${START}" \
    --download-archive ".archive.txt" \
    --ignore-errors \
    --output "%(playlist_index)02d - %(title)s.%(ext)s" \
    --console-title

echo "Finished processing '$NAME'."
