#!/bin/sh
# need superuser : use my-superuser
set -eu

. "$__distro_path_lib"

"${__distro_path_root}/bin/not_add_2_path"/check_4_dependencies_if_installed grep ip cut getopt getent || exit 1

show_error() {
    printf "\033[0;91mError: %s\033[0m\n" "$1" >&2
}

show_header() {
    printf "\033[0;96m%s\033[0m\n" "$1"
}

print_usage() {
    show_header "Network Route Manager"
    echo "Usage: allow-ip [options]"
    echo "  -i, --ip <addr|name> IP or Hostname (e.g. 192.168.1.50 or printer.local)"
    echo "  -m, --mask <bits>    CIDR mask (default: 32)"
    echo "  -d, --delete         Remove the route instead of adding it"
    echo "  -s, --status         Show current custom routes"
    echo "  -h, --help           Show this help"
    echo ""
    show_header "Examples:"
    echo "  allow-ip -i 192.168.1.50           # Route a single IP"
    echo "  allow-ip -i 192.168.1.0/24         # Route a whole subnet"
    echo "  allow-ip -i printer.local          # Route by hostname"
    echo "  allow-ip -i 192.168.1.50 -d        # Remove a specific route"
}

INPUT=""
MASK=""
ACTION="add"

PARSED=$(getopt -o "hi:m:ds" --long "help,ip:,mask:,delete,status" -n "$0" -- "$@")
eval set -- "$PARSED"

while [ $# -gt 0 ]; do
    case "$1" in
        -i|--ip)
            INPUT="$2"
            shift 2 ;;
        -m|--mask) MASK="$2"; shift 2 ;;
        -d|--delete) ACTION="delete"; shift ;;
        -s|--status) ACTION="status"; shift ;;
        -h|--help) print_usage; exit 0 ;;
        --) shift; break ;;
        *) show_error "Internal error!"; exit 3 ;;
    esac
done

if [ "$ACTION" = "status" ]; then
    show_header "Current custom routes via local gateway:"
    ip route show | grep -v "default" | grep "via" || echo "No custom routes found."
    exit 0
fi

if [ -z "$INPUT" ]; then
    show_error "IP or Hostname is required."
    print_usage
    exit 1
fi

case "$INPUT" in
    */*) IP=$(echo "$INPUT" | cut -d/ -f1) ; MASK=$(echo "$INPUT" | cut -d/ -f2);;
    *)   IP="$INPUT" ;;
esac

if ! echo "$IP" | grep -qE '^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+$'; then
    show_header "Resolving hostname: $IP..."
    RESOLVED=$(getent hosts "$IP" | awk '{print $1}' | head -n 1)
    if [ -z "$RESOLVED" ]; then
        show_error "Could not resolve hostname: $IP"
        exit 1
    fi
    IP="$RESOLVED"
    show_header "Resolved to: $IP"
fi

MASK="${MASK:-32}"
TARGET="${IP}/${MASK}"

DEFAULT_ROUTE=$(ip route show default | head -n 1)
GATEWAY=$(echo "$DEFAULT_ROUTE" | sed -n 's/.*via \([^ ]*\).*/\1/p')
IFACE=$(echo "$DEFAULT_ROUTE" | sed -n 's/.*dev \([^ ]*\).*/\1/p')

if [ -z "$GATEWAY" ] || [ -z "$IFACE" ]; then
    show_error "Could not find default route info. Are you connected to a network?"
    exit 1
fi

case "$ACTION" in
    add)
        if ip route show "$TARGET" | grep -q "$IP"; then
            show_header "Route to $TARGET already exists."
        else
            show_header "Adding: $TARGET via $GATEWAY ($IFACE)"
            my-superuser ip route add "$TARGET" via "$GATEWAY" dev "$IFACE"
        fi
        ;;
    delete)
        show_header "Removing: $TARGET"
        if ip route show "$TARGET" | grep -q "$IP"; then
            my-superuser ip route del "$TARGET"
        else
            show_error "Route not found; nothing to delete."
        fi
        ;;
esac

show_header "Done."
