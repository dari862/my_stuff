#!/bin/sh

option="${1-}"
option2="${2-}"

livewallpaper_dir="${HOME}/.local/livewallpaper"
video_dir="${livewallpaper_dir}/video"
autorun_file="${livewallpaper_dir}/autorun"

# Setup directories
if [ ! -d "${video_dir}" ];then
	mkdir -p "${video_dir}"
fi

# Load libraries and check dependencies
. "$__distro_path_lib"
"${__distro_path_root}/bin/not_add_2_path"/check_4_dependencies_if_installed ffmpeg feh || exit 1

# Messages
Preparing_msg="Preparing the video..."
Invalid_format="Invalid format: MP4/M4V only."
noprocess_videos="No saved wallpapers found."

quit_loop(){
    # Kill background feh loops and any other livewall instances
    setbg -r 2>/dev/null
    pkill -f "feh.*${video_dir}" 2>/dev/null
    pgrep -f "livewall" | grep -v "^$$" | xargs kill -9 2>/dev/null
}

check_video_exists(){
    if [ ! -d "${video_dir}" ] || [ -z "$(ls -A "${video_dir}")" ]; then
        echo "${noprocess_videos}"
        exit 1
    fi
}

convert_video(){
    video_path="$1"
    if [ ! -f "$video_path" ];then
		echo "File not found: $video_path"
		exit 1
	fi

    # Validate mime-type
    mime=$(file -b --mime-type "$video_path")
    case "$mime" in
        video/mp4|video/x-m4v) ;;
        *) echo "$Invalid_format"; exit 1 ;;
    esac

    # Determine next numeric directory
    a=1
    while [ -d "${video_dir}/$a" ]; do a=$((a + 1)); done
    mkdir -p "${video_dir}/$a"

    printf "${Preparing_msg}\n"
    # Extract 10 seconds of frames. Lower quality slightly for performance if needed.
    ffmpeg -y -i "$video_path" -t 10 -q:v 2 "${video_dir}/${a}/frame%05d.jpg" >/dev/null 2>&1
    echo "$video_path" > "${video_dir}/${a}/video.info"
    echo "$a"
}

start_live_wallpaper(){
    id="$1"
    target_dir="${video_dir}/$id"
    if [ ! -d "$target_dir" ];then
		exit 1
	fi

    # Pre-load frame list to avoid 'ls' inside the loop (huge CPU saver)
    frames=$(ls -1 "$target_dir"/frame*.jpg)
    
    # Run loop in background
    (
        while :; do
            for frame in $frames; do
                feh --bg-scale "$frame"
                sleep 0.05 # Slightly higher sleep saves CPU; adjust for smoothness
            done
        done
    ) &
}

process_video(){
    target="$1"
    quit_loop
    
    # Check if this video path was already processed
    existing_dir=$(grep -rlF "$target" "$video_dir"/*/video.info 2>/dev/null | head -n 1)
    
    if [ -n "$existing_dir" ]; then
        id=$(basename "$(dirname "$existing_dir")")
    else
        id=$(convert_video "$target")
    fi
    
    start_live_wallpaper "$id"
}

list_videos(){
    check_video_exists
    for dir in "${video_dir}"/*; do
        if [ ! -d "$dir" ];then
			continue
		fi
        id=$(basename "$dir")
        info=$(cat "$dir/video.info" 2>/dev/null || echo "Unknown")
        echo "${id}|${info}" # Using pipe for easier parsing by the GUI script
    done
}

delete_wallpaper(){
    id="$1"
    target_path="${video_dir}/${id}"

    if [ -z "$id" ]; then
        echo "[Error] No ID provided for deletion."
        exit 1
    fi

    if [ -d "$target_path" ]; then
        # Check if the wallpaper being deleted is the current autorun
        if [ -f "$autorun_file" ]; then
            current_auto=$(cat "$autorun_file")
            if [ "$current_auto" = "$id" ]; then
                rm "$autorun_file"
                echo "Removed deleted wallpaper from autorun."
            fi
        fi

        # Stop the wallpaper if it's currently running
        quit_loop
        
        # Remove the directory
        rm -rf "$target_path"
        echo "Wallpaper $id deleted successfully."
    else
        echo "[Error] Wallpaper ID $id does not exist."
        exit 1
    fi
}

# Updated Case Logic
case "${option}" in
    -h|--help) 
        echo "Usage: livewall [option] [file/id]"
        echo " -d, --delete [ID]    Removes wallpaper by ID"
        ;;
    -p|--print-video-directory) echo "${video_dir}" ;;
    -q|--quit) quit_loop ;;
    -L|--list-videos) list_videos ;;
    -I|--select-video) quit_loop; start_live_wallpaper "$option2" ;;
    -a|--enable-autorun) echo "$option2" > "${autorun_file}"; quit_loop; start_live_wallpaper "$option2" ;;
    -d|--delete) delete_wallpaper "$option2" ;; # NEW DELETE CASE
    -r|--run-live-wallpaper) [ -f "${autorun_file}" ] && start_live_wallpaper "$(cat "${autorun_file}")" ;;
    *) [ -n "$option" ] && process_video "$option" ;;
esac
