#!/bin/sh
set -e
. "$__distro_path_lib"
"${__distro_path_root}/bin/not_add_2_path"/check_4_dependencies_if_installed qpdf || exit 1

usage() {
    cat <<EOF
Usage:
  $0 extract input.pdf page_range
  $0 merge output.pdf input1.pdf [input2.pdf ...]
  $0 encrypt input.pdf

Examples:
  $0 extract report.pdf 1-5
  $0 merge final.pdf part1.pdf part2.pdf
EOF
    exit 1
}

prompt_password() {
    msg="$1"
    stty_orig=$(stty -g)
    printf "%s" "$msg" >&2
    stty -echo
    read -r pw
    stty "$stty_orig"
    echo >&2
    printf "%s" "$pw"
}

check_file_exists() {
    if [ ! -f "$1" ]; then
        echo "‚ùå File not found: $1" >&2
        exit 1
    fi
}

confirm_overwrite() {
    if [ -f "$1" ]; then
        printf "‚ö†Ô∏è Output file '%s' exists. Overwrite? (y/N): " "$1" >&2
        read -r confirm
        if [ "$confirm" != "y" ] && [ "$confirm" != "Y" ]; then
            echo "Aborted." >&2
            exit 1
        fi
    fi
}

handle_extract() {
    INPUT="$1"
    PAGES="$2"
    check_file_exists "$INPUT"

    OUTPUT="${INPUT%.*}_extracted.pdf"
    confirm_overwrite "$OUTPUT"

    # Check encryption (POSIX redirect)
    if qpdf --show-encryption "$INPUT" >/dev/null 2>&1; then
        PASS=$(prompt_password "üîê Enter PDF password: ")
        qpdf --password="$PASS" "$INPUT" --pages "$INPUT" "$PAGES" -- "$OUTPUT"
    else
        qpdf "$INPUT" --pages "$INPUT" "$PAGES" -- "$OUTPUT"
    fi
    echo "‚úÖ Extracted pages [$PAGES] to '$OUTPUT'"
}

handle_merge() {
    OUTPUT="$1"
    shift # The rest are input files
    
    confirm_overwrite "$OUTPUT"

    for f in "$@"; do
        check_file_exists "$f"
    done

    qpdf --empty --pages "$@" -- "$OUTPUT"
    echo "‚úÖ Merged into '$OUTPUT'"
}

handle_encrypt() {
    INPUT="$1"
    check_file_exists "$INPUT"

    OUTPUT="${INPUT%.*}_encrypted.pdf"
    confirm_overwrite "$OUTPUT"

    USER_PW=$(prompt_password "üîí Enter user password: ")
    OWNER_PW=$(prompt_password "üîí Enter owner password: ")

    if [ -z "$USER_PW" ] || [ -z "$OWNER_PW" ]; then
        echo "‚ùå Passwords cannot be empty." >&2
        exit 1
    fi

    qpdf --encrypt "$USER_PW" "$OWNER_PW" 256 -- "$INPUT" "$OUTPUT"
    echo "üîê Encrypted as '$OUTPUT'"
}

if [ "$#" -lt 2 ]; then
    usage
fi

CMD="$1"
shift

case "$CMD" in
    extract)
        [ "$#" -ne 2 ] && usage
        handle_extract "$1" "$2"
        ;;
    merge)
        [ "$#" -lt 2 ] && usage
        handle_merge "$@"
        ;;
    encrypt)
        [ "$#" -ne 1 ] && usage
        handle_encrypt "$1"
        ;;
    *)
        usage
        ;;
esac
