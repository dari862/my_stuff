#!/bin/sh
# need superuser : var (_SUPERUSER)
########################################################################
# Check the connection by downloading a file from ftp.debian.org. No disk space used.
# Usage: connectiontest [attempts]
# If attempt count is not specified or 0, then it will loop forever and exit(!) your main program with 1 exit status.

connectiontest() {
	_show_icon=false
	if [ "${2:-}" = "icon" ];then
		_nomassage_=true
		_show_icon=true
	elif [ "${2:-}" = "nomassage" ];then
		_nomassage_=true
	else
		_nomassage_=false
	fi
    TEXT_CHECKING='Checking internet connection...'
    TEXT_FAILED='Internet connection test failed!'
    TEXT_ASK_RETRY='\n\nThis script requires a working internet connection. Please configure your internet connection, then hit "Enter" to continue, else hit "q" to quit.'
    TEXT_ABORT='Script aborted.'
    TEXT_OK='Internet connection test passed!'

    i=0
    attempts=${1:-0}
    while [ "$i" -lt "$attempts" ] || [ "$attempts" -eq 0 ]; do
    	if [ "${_nomassage_}" = false ];then
        	say "$TEXT_CHECKING" 'yellow'
        fi
        if getURL '2term' "http://network-test.debian.org/nm" | grep -q "NetworkManager is online";then
        	if [ "${_nomassage_}" = false ];then
            	say "$TEXT_OK" 1
            fi
            return 0
        fi
        if [ "${_nomassage_}" = false ];then
        	say "$TEXT_FAILED" 'red'
        	if [ "$i" -eq $((attempts - 1)) ];then # if last attempt
            	return 1
        	elif prompt "$TEXT_ASK_RETRY" Q;then # if user wants to quit
            	say "$TEXT_ABORT" 'yellow' 2
            	[ "$attempts" -eq 0 ] && exit 1 || return 1
        	fi
        	tput clear
        fi
        i=$((i + 1))
    done
    if [ "${_nomassage_}" = true ];then
    	if [ "${_show_icon}" = true ];then
    		say "ï’­"
    	fi
    	return 1
    fi
}

# Usage: say text [delayAfterText|pause]
say() {
	message="${1-}"
	mode="${2-}"
	width=$(tput cols 2>/dev/tty)
	
	if [ "${mode}" = 'red' ];then
		color="31"
		mode="${3:-}"
	elif [ "${mode}" = 'yellow' ];then
		color="33"
		mode="${3:-}"
	elif [ "${mode}" = 'green' ];then
		color="32"
		mode="${3:-}"
	else
		color="32"
	fi
	
	printf '%b' "\\033[1;${color}m${message}\\033[0m\n" | fold -s -w $((width - 3)) | sed 's/^/  /' # wraps text nicely and adds two leading spaces

    case "$mode" in
    	pause)
    		stty -icanon -echo time 0 min 1
			head -c1 >/dev/null
			stty icanon echo
    		;;
    	''|*[!0-9.]*)  # Anything other than digits or a single decimal point is invalid
        	:
        	;;
    	*)
        	sleep "${mode}"
        	;;
	esac
}

# Usage: prompt text [ Y | N | Q | <string> ]
prompt() {
    answer=""
    prompt=""
    default=""

    if [ "${2:-}" ] && [ "${2}" = "Q" ];then
        while true; do
            say "$1 " 'red'
        	stty -icanon -echo time 0 min 1
			answer="$(head -c1)"
			stty icanon echo
            echo
            if [ "$answer" = "Q" ] || [ "$answer" = "q" ];then
                return 0
            elif [ -z "$answer" ];then
                return 1
            fi
        done
    fi

    if [ -z "${2:-}" ] || [ "${2}" = "Y" ];then
        prompt='Y/n'
        default='Y'
    elif [ "${2}" = "N" ];then
        prompt='y/N'
        default='N'
    fi

	while true; do
		say "$1 ${prompt:+[$prompt] }" "yellow"
		stty -icanon -echo time 0 min 1
		answer="$(head -c1)"
		stty icanon echo
		echo
		
        [ -z "$answer" ] && answer="$default"
        
		case "$answer" in
			[Yy]) echo; return 0 ;;
			[Nn]) echo; return 1 ;;
			[Qq]) echo; return 1 ;;
			*) say "invalid response only y[yes] or n[No] are allowed." 'red';;
		esac
	done
}

keep_superuser() {
    while true; do
        my-superuser true
        sleep 600
    done
}

end_superuser() {
    if command_exist doas;then
        doas -L
    fi
}

Distrobox_package_installer_() {
	_Distrobox_packages2install="$*"
	say "Updaing gaming distrobox ..." 1
	distrobox enter --name "gaming" -- "yay -q --noprogressbar -Syy --noconfirm" || exit 1	
	clear
	say "Installing $_Distrobox_packages2install ..." 1
    distrobox enter --name "gaming" -- "yay -q --noprogressbar -Syu $_Distrobox_packages2install --noconfirm" || exit 1
}

failed_to_run() {
    __message_="${1:-}"
    say "$__message_" 'red' 'pause'
    exit 1
}

failed_but_continue() {
    __message_="${1:-}"
    say "$__message_" 'red' 'pause'
    continue
}

copy_all__application_link_in_dir(){
	__application_link_dir="${1:-}"
	if [ "$(id -u)" -eq 0 ];then
		_SUPERUSER=""
	else
		if command_exist my-superuser;then
			_SUPERUSER="my-superuser"
		elif command_exist sudo;then
			_SUPERUSER="sudo"
		elif command_exist doas;then
			_SUPERUSER="doas"
		fi
	fi
    $_SUPERUSER cp -r "${__distro_path_root}/applications_extra/${__application_link_dir}"/* "${__distro_path_neverremove}/applications"
}

generate_applicationsdotdesktop_link(){
	__application_name="${1:-}"
	__application_command="${2:-}"
	__Categories="${3:-}"
	if [ "$(id -u)" -eq 0 ];then
		_SUPERUSER=""
	else
		if command_exist my-superuser;then
			_SUPERUSER="my-superuser"
		elif command_exist sudo;then
			_SUPERUSER="sudo"
		elif command_exist doas;then
			_SUPERUSER="doas"
		fi
	fi
    if [ -f "${__distro_path_root}/applications_extra/${__application_name}.desktop" ];then
    	$_SUPERUSER cp -r "${__distro_path_root}/applications_extra/${__application_name}.desktop" "${__distro_path_neverremove}/applications/${__application_name}.desktop"
    	if grep -q "(((__distro_path_root)))" "${__distro_path_neverremove}/applications/${__application_name}.desktop";then
    		$_SUPERUSER sed -i "s/(((__distro_path_root)))/${__distro_path_root}/g" "${__distro_path_neverremove}/applications/${__application_name}.desktop"
    	fi
    	$_SUPERUSER ln -sf "${__distro_path_neverremove}/applications/${__application_name}.desktop" "/usr/share/applications"
    else
    	if [ -n "$__application_command" ];then
    		__Categories="${__Categories};"
    	fi
    	if [ -n "$__application_name" ];then
    		__application_desktop_name="$(printf "${__application_name}" | sed "s/ /_/g" || printf "$__application_name")"
    	fi
    	[ -z "$__application_command" ] && __application_command="${__application_name}"
    	$_SUPERUSER tee "${__distro_path_neverremove}/applications/${__application_desktop_name}.desktop" <<- EOF >/dev/null 2>&1
    	[Desktop Entry]
		Name=${__application_name}
		Comment=${__application_name}
		Exec=${__application_command}
		Terminal=false
		Type=Application
		Icon=flatpak
		Categories=GTK;${Categories}
		MimeType=text/html;text/xml;application/xhtml_xml;
		StartupNotify=true
		EOF
    	$_SUPERUSER ln -sf "${__distro_path_neverremove}/applications/${__application_name}.desktop" "/usr/share/applications"
    fi
}

generate_applicationsdotdesktop_4_xsessions(){
	__application_name="${1:-}"
	__application_command="${2:-}"
	if [ -d "${_distro_xsessions_desktop_path}" ];then
		mkdir -p "${_distro_xsessions_desktop_path}"
	fi
	
	if [ "$(id -u)" -eq 0 ];then
		_SUPERUSER=""
	else
		if command_exist my-superuser;then
			_SUPERUSER="my-superuser"
		elif command_exist sudo;then
			_SUPERUSER="sudo"
		elif command_exist doas;then
			_SUPERUSER="doas"
		fi
	fi
	
	$_SUPERUSER mkdir -p "${_distro_xsessions_desktop_path}"
    if [ ! -f "${_distro_xsessions_desktop_path}/${__custom_distro_name}_${__application_name}.desktop" ];then
    	$_SUPERUSER tee "${_distro_xsessions_desktop_path}/${__custom_distro_name}_${__application_name}.desktop" <<- EOF >/dev/null 2>&1
		[Desktop Entry]
		Name=${__distro_title} ${__application_name}
		Comment=Log in to a ${__distro_title} ${__application_name} session
		Exec=${__distro_path_system_files}/bin/xsessions/${__application_command}
		TryExec=${__distro_path_system_files}/bin/xsessions/${__application_command}
		Icon=${__application_name}
		Type=Xsession
		EOF
    fi
    if [ ! -f "/usr/share/xsessions/${__custom_distro_name}_${__application_name}.desktop" ];then
    	$_SUPERUSER ln -sf "${_distro_xsessions_desktop_path}/${__custom_distro_name}_${__application_name}.desktop" "/usr/share/xsessions"
    fi
}

flatpak_install() {
	if ! command_exist flatpak;then
		say 'Installing flatpak...' 1
		install_as_dependency flatpak
	fi
    __icons_="${1:-}"
    __appid="${2:-}"
    __repo_="${3:-}"
    if [ -z "$__repo_" ];then
    	__repo_="flathub"
    	flatpak info "${__appid}" >/dev/null 2>&1 || failed_to_run "failed to find ${__appid} in flatpak repo: ${__repo_}"
    elif [ "$__repo_" = "nonflathub" ];then
    	__repo_=""
    	flatpak info "${__appid}" >/dev/null 2>&1 || failed_to_run "failed to find ${__appid}"
    else
    	flatpak info "${__appid}" >/dev/null 2>&1 || failed_to_run "failed to find ${__appid} in flatpak repo: ${__repo_}"
    fi
        
    say "Installing package ${__icons_} via flatpak"
    my-superuser flatpak install -y "$__repo_" "${__appid}"
    generate_applicationsdotdesktop_link "${__icons_}" "flatpak run ${__appid}"
}

sed_distro_path_root_var_2_correct_value(){
	if [ "$(id -u)" -eq 0 ];then
		_SUPERUSER=""
	else
		if command_exist my-superuser;then
			_SUPERUSER="my-superuser"
		elif command_exist sudo;then
			_SUPERUSER="sudo"
		elif command_exist doas;then
			_SUPERUSER="doas"
		fi
	fi
	
	__distro_path_system_ready_laptop="${__distro_path_system_ready}/this_is_laptop"
	
	sed_distro_path(){
		sed_this_distro_path="(((${1:-})))"
		with_this_distro_path="${2:-}"
		if grep -rIq "${sed_this_distro_path}" "${__distro_path_system_skel_files}";then
			$_SUPERUSER find "${__distro_path_system_skel_files}" -type f -exec sed -i "s|${sed_this_distro_path}|${with_this_distro_path}|g" {} +
		fi
	}
	
	sed_distro_path "__distro_path_root" "${__distro_path_root}"
	sed_distro_path "__distro_path_enabled_completion" "${__distro_path_enabled_completion}"
	sed_distro_path "__distro_path_system_ready" "${__distro_path_system_ready}"
	sed_distro_path "__distro_path_system_ready_laptop" "${__distro_path_system_ready_laptop}"
	sed_distro_path "__distro_path_neverremove" "${__distro_path_neverremove}"
	sed_distro_path "__distro_path_themes" "${__distro_path_themes}"
	sed_distro_path "__distro_path_all_distro_themes" "${__distro_path_all_distro_themes}"
	sed_distro_path "__distro_title" "${__distro_title}"
	sed_distro_path "__distro_path_themes" "${__distro_path_themes}"
	sed_distro_path "__distro_path_wallpaper" "${__distro_path_wallpaper}"
	
	. "${__distro_path_root}/Distro_Specific/disto_icon"
	sed_distro_path "distro_icon" "${distro_icon}"
	
	sed_distro_path "bl_preferences_pipemenu_file" "${bl_preferences_pipemenu_file}"
	sed_distro_path "ac_preferences_pipemenu_file" "${ac_preferences_pipemenu_file}"
	sed_distro_path "my_preferences_pipemenu_file" "${my_preferences_pipemenu_file}"
}

copy_from_extra_skel() {
    __copythis="${1:-}"
    __basename=$(basename "$__copythis")
    __dirname=$(dirname "$__copythis")
    __copythere=""

    if [ "$__dirname" != "." ];then
        __copythere="$__dirname"
    fi

    my-superuser cp -r "${__distro_path_root}/skel_extra/${__copythis}" "${__distro_path_system_skel_files}/${__copythere}"
    
	sed_distro_path_root_var_2_correct_value
	
    for d in /home/*/; do
        [ "$(dirname "$d")" = "/home" ] && ! id "$(basename "$d")" >/dev/null 2>&1 && continue
        user_and_group=$(stat "$(dirname "$d/.config")" -c %u:%g)
        my-superuser cp -r "${__distro_path_system_skel_files}/${__copythis}" "$d/${__copythis}"
        my-superuser chown -R "$user_and_group" "$d"
    done
}

add_keybinds(){
	__package_name="${1:-}"
	my-superuser "${__distro_path_root}/bin/keybinds"/keybinds --add "$__package_name"
}

command_exist() {
	commad_2_check="${1:-}"
	if command -v "$commad_2_check" >/dev/null 2>&1;then
		return 0
	else
		return 1
	fi
}

grub_updater_function() {
	say "update grub"
	my-superuser sync
	if command_exist update-grub; then
		my-superuser update-grub
	elif command_exist grub-mkconfig; then
		my-superuser grub-mkconfig -o /boot/grub/grub.cfg
	elif command_exist zypper || command_exist transactional-update; then
		my-superuser grub2-mkconfig -o /boot/grub2/grub.cfg
	elif command_exist dnf || command_exist rpm-ostree; then
		if [ -f "/boot/grub2/grub.cfg" ]; then
			my-superuser grub2-mkconfig -o /boot/grub2/grub.cfg
		elif [ -f "/boot/efi/EFI/fedora/grub.cfg" ]; then
			my-superuser grub2-mkconfig -o /boot/efi/EFI/fedora/grub.cfg
		fi
	fi
}

if command_exist git;then
    clone_repo() {
        getthis="${1:-}"
        getto="${2:-}"
        echo "git clone ${getthis}"
        git clone --depth=1 "${getthis}" "${getto}"
    }
    super_clone_repo() {
        getthis="${1:-}"
        getto="${2:-}"
        say "git clone ${getthis} to ${getto}" 1
        my-superuser git clone --depth=1 "${getthis}" "${getto}"
    }
elif command_exist svn;then
    clone_repo() {
        getthis="${1:-}"
        getto="${2:-}"
        echo "svn clone ${getthis}"
        svn clone --depth=1 "${getthis}" "${getto}"
    }
    super_clone_repo() {
        getthis="${1:-}"
        getto="${2:-}"
        say "git clone ${getthis} to ${getto}" 1
        my-superuser svn clone --depth=1 "${getthis}" "${getto}"
    }
fi

ln_sf_files_depth1(){
	$_SUPERUSER find "$1" -maxdepth 1 -type f -exec ln -sf {} "$2" \;
}

generate_never_remove_bin(){
	bin_to_lnsf="${1:-}"
	new_name_for_bin="${2:-}"
	bin_name="$(basename "$bin_to_lnsf")"
	my-superuser cp -r "${bin_to_lnsf}" "${__distro_path_neverremove}/bin"
	if [ -z "$new_name_for_bin" ];then
		my-superuser ln -sf "${__distro_path_neverremove}/bin/${bin_name}" "${__distro_path_root}/system_files/bin"
	else
		my-superuser ln -sf "${__distro_path_neverremove}/bin/${bin_name}" "${__distro_path_root}/system_files/bin/${new_name_for_bin}"
	fi
}

remove_never_remove_bin(){
	bin_to_rm="${1:-}"
	if [ -z "${bin_to_rm}" ];then
		my-superuser rm -f "${__distro_path_root}/system_files/bin/${bin_to_rm}"
		my-superuser rm -f "${__distro_path_neverremove}/bin/${bin_to_rm}"
	fi
}
