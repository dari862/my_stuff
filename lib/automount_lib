#!/bin/bash
set -e

dry_run=false
unmounted_devices=""

show_m() {
    __massage="${1:-}"
    printf '%s\n' "$__massage"
}

show_em() {
    __massage="${1:-}"
    printf '%s\n' "$__massage"
    exit 1
}

if [ "$__mode" = "rofi" ]; then
	show_m() {
    	__massage="${1:-}"
     	rofi -e "$__massage" -theme "$RASI_PATH"
	}
	show_em() {
    	__massage="${1:-}"
    	rofi -e "$__massage" -theme "$RASI_PATH"
    	exit 1
	}
fi

get_uuid() {
	if my-superuser blkid "$1" | grep -q "PTUUID=";then
    	my-superuser blkid "$1" | sed -n 's/.*UUID="\([^"]*\)".*/\1/p'
	else
		ls -l /dev/disk/by-uuid/ | grep $(basename "$1") | awk '{print $9}'
	fi
}

get_fs_type() {
	if my-superuser blkid "$1" | grep -q "PTTYPE=";then
    	my-superuser blkid "$1" | sed -n 's/.*TYPE="\([^"]*\)".*/\1/p'
	else
		df -T | grep /dev/sda | awk '{print $2}'
	fi
}

Parse_arguments(){
	arg="${1:-}"
	case "$arg" in
	--dry-run)
		dry_run=true
		;;
	'') : ;;
	*)	show_m "Usage: $0 [--dry-run]"
		show_em "‚ùå Unknown option: $arg"
	;;
	esac
}

fill_unmounted_devices_var(){
	_devices="$(lsblk -lnpo NAME,TYPE | awk '$2 == "disk" {print $1}' | grep -v "zram" || :)"
	mount_output="$(my-superuser mount)"
	for dev in ${_devices};do
		if ! printf "%s\n" "$mount_output" | grep -q "$dev";then
			unmounted_devices="$unmounted_devices $dev"
		fi
	done

	if [ -z "$unmounted_devices" ]; then
		show_m "‚úÖ No unmounted partitions found."
		exit 0
	fi
}

get_uuid_and_fs_type(){
	device_path=$(awk '{print $1}' <<< "$selected_line")

	if [ -z "$device_path" ] || [ ! -b "$device_path" ]; then
		show_em "‚ùå Invalid selection or device not found."
	fi

	uuid=$(get_uuid "$device_path")
	
	fs_type=$(get_fs_type "$device_path")

	if [ -z "$uuid" ] || [ -z "$fs_type" ]; then
		show_em "‚ùå Could not retrieve UUID or filesystem type for $device_path."
	fi

	if grep -q "$uuid" /etc/fstab; then
		show_m "‚ö†Ô∏è UUID already exists in /etc/fstab. Skipping."
		exit 0
	fi
}

check_mount_path_and_fs_type(){
	if [ -z "$mount_path" ]; then
		mount_path="/mnt/disk-${uuid:0:8}"
		show_m "‚ÑπÔ∏è Mount point auto-generated: $mount_path"
	fi

	case "$fs_type" in
		ext4|xfs) options="defaults" ;;
		btrfs)    options="defaults,compress=zstd" ;;
		ntfs)     options="defaults,uid=1000,gid=1000" ;;
		vfat)     options="defaults,uid=1000,gid=1000,umask=022" ;;
		*)        options="defaults"
				  show_m "‚ö†Ô∏è Unknown filesystem type '$fs_type'. Using default options." ;;
	esac
}

run_automount(){
	if [ "$dry_run" = true ]; then
		show_m "üö´ Dry-run mode active ‚Äî no changes will be made."
		exit 0
	fi

	mkdir -p "$mount_path"

	backup_file="/etc/fstab.backup.$(date +%F-%H%M%S)"
	my-superuser cp /etc/fstab "$backup_file"
	show_m "üìÅ fstab backed up to $backup_file"

	{
		printf "# Added by automount script on %s\n" "$(date)"
		printf "UUID=%s %s %s %s 0 2\n" "$uuid" "$mount_path" "$fs_type" "$options"
	} | my-superuser tee -a /etc/fstab

	service_manager reload

	if my-superuser  mount "$mount_path"; then
		show_m "‚úÖ Mounted $device_path at $mount_path"
		df -h | grep --color=never "$mount_path"
	else
		show_em "‚ùå Failed to mount $device_path."
	fi
}
